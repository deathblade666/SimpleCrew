<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Simple. Activity</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FDFDFD">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Simple">
    <link rel="apple-touch-icon" href="https://d31s10tn3clc14.cloudfront.net/imgs/deposits/Review+Logos/simple-logo.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #FDFDFD;
            --border-color: #E8E8E8;
            --text-dark: #2C2C2C;
            --text-light: #767676;
            --simple-blue: #0093E9;
            --alert-red: #D93025;
            --link-blue: #0085C3;
            --exp-track: #F0F0F0;
            --exp-fill: #34495E;
            --nav-height: 60px;
            --bottom-nav-height: 0px; /* 0 on desktop */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-dark); 
            font-size: 14px; 
            overflow-y: hidden; /* Desktop keeps hidden, Mobile will override */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- NAV --- */
        .top-nav { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            height: var(--nav-height); 
            padding: 0 40px; 
            background: #FFF; 
            border-bottom: 1px solid var(--border-color); 
            flex-shrink: 0; 
            z-index: 50;
            position: relative; /* For absolute centering */
        }
        .nav-left, .nav-right { display: flex; align-items: center; gap: 30px; }
        .logo { margin-right: 15px; display: flex; align-items: center; }
        .logo img { height: 22px; display: block; }
        
        .nav-link { 
            text-decoration: none; 
            color: var(--text-dark); 
            font-weight: 500; 
            padding: 21px 0; 
            border-bottom: 2px solid transparent; 
            cursor: pointer; 
            transition: color 0.2s; 
            font-size: 14px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 4px;
        }
        
        .nav-link svg {
            display: none; /* Hidden on desktop */
            width: 24px;
            height: 24px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .nav-link:hover { color: var(--simple-blue); }
        .nav-link.active { border-bottom: 2px solid var(--simple-blue); color: var(--text-dark); }
        
        .user-profile { display: flex; align-items: center; gap: 10px; color: var(--text-light); cursor: pointer; }
        .avatar { width: 32px; height: 32px; background: #F5A623; color: #FFF; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; }

        /* --- HEADER --- */
        .info-header { 
            background: #FAFAFA; 
            padding: 25px 40px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            flex-shrink: 0; 
            margin-bottom: 0;
        }
        .balance-container h1 { margin: 0; font-size: 32px; font-weight: 600; color: var(--text-dark); display: flex; align-items: baseline; gap: 12px; }
        .sts-label { font-size: 15px; font-weight: 400; color: #999; }
        .math-line { margin-top: 6px; font-size: 13px; color: var(--text-dark); }
        .math-gray { color: #999; }
        .header-links { display: flex; gap: 30px; align-items: center; } 
        .header-link-group { display: flex; flex-direction: column; }
        .header-link-label { font-size: 12px; color: #999; margin-bottom: 4px; }
        .header-link-action { font-size: 13px; color: var(--link-blue); font-weight: 500; text-decoration: none; }


        
        /* --- CONTROLS --- */
        .controls-bar { 
            padding: 25px 40px 0 40px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-shrink: 0; 
            margin-bottom: -10px;
        }
        
        #search-container { display: flex; gap: 10px; width: 60%; transition: opacity 0.2s; }
        .search-input { padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 4px; width: 100%; font-size: 14px; color: #333; }
        .btn { padding: 8px 16px; border-radius: 4px; font-weight: 500; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .btn-outline { background: #FFF; border: 1px solid var(--border-color); color: var(--text-dark); white-space: nowrap; }
        .btn-outline:hover { border-color: #BBB; }
        
        .btn-move { background: #FFF; border: 1px solid var(--border-color); color: var(--text-dark); display: flex; align-items: center; gap: 8px; padding: 10px 16px; white-space: nowrap; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.05);}
        .btn-move:hover { border-color: #BBB; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* FILTERS */
        .filters { 
            padding: 0 40px; 
            margin-bottom: 20px; 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            flex-shrink: 0; 
            position: relative; 
            margin-top: 20px;
            z-index: 10;
        }
        .pill { background: #E0E0E0; color: var(--text-dark); padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px;}
        .pill:hover { background: #D0D0D0; }
        .pill-remove { font-size: 14px; color: #666; font-weight: normal; }
        .link-blue { color: var(--link-blue); font-size: 13px; cursor: pointer; user-select: none; white-space: nowrap; }

        /* FILTER POPUP */
        .filter-popup {
            position: absolute; top: 30px; left: 150px; background: #FFF; border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-radius: 6px; padding: 20px; width: 300px; z-index: 100; display: none;
        }
        .filter-group { margin-bottom: 15px; }
        .filter-label { font-size: 12px; font-weight: 600; color: #777; margin-bottom: 5px; display: block; }
        .filter-row { display: flex; gap: 10px; }
        .filter-input { width: 100%; padding: 8px; border: 1px solid #DDD; border-radius: 4px; font-size: 13px; }
        .btn-apply { background: var(--simple-blue); color: #FFF; width: 100%; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: 600; }

        /* NEW: Popup Header for Exit Button */
        .popup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom:10px; border-bottom:1px solid #F0F0F0; }
        .popup-title { font-weight: 700; font-size: 14px; color: #333; }
        .close-popup { font-size: 24px; color: #999; cursor: pointer; line-height: 1; }
        .close-popup:hover { color: #333; }

        /* --- GRID --- */
        .main-grid { 
            display: grid; 
            grid-template-columns: 3fr 1fr; 
            gap: 40px; 
            padding: 0 40px; 
            max-width: 1600px; 
            /* On desktop, we want the grid to fill remaining height */
            flex: 1;
            overflow: hidden; 
            width: 100%;
            margin-top: 30px;
        }
        .main-column {
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Contains the internal scroll */
            height: 100%;
        }

        .view-section { display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }

        .section-header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--simple-blue); padding-bottom: 12px; margin-bottom: 0px; flex-shrink: 0; }
        .tab-title { font-weight: 700; font-size: 15px; color: var(--text-dark); }
        .view-toggles { color: var(--text-light); font-size: 13px; cursor: default; }
        .view-toggles span.active { color: var(--text-dark); font-weight: 700; }

        .data-container {
            background: #FFF; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 4px 4px;
            flex: 1; 
            overflow-y: auto; 
            scrollbar-width: thin; 
            scrollbar-color: #CCC #F0F0F0;
        }
        .data-container::-webkit-scrollbar { width: 8px; }
        .data-container::-webkit-scrollbar-track { background: #FAFAFA; border-left: 1px solid #EEE; }
        .data-container::-webkit-scrollbar-thumb { background-color: #C1C1C1; border-radius: 4px; border: 2px solid #FAFAFA; }

        /* --- MODERN GROUP STYLES (Cards) --- */
        .group-container {
            margin-bottom: 15px;
            transition: all 0.2s;
            border: 2px solid transparent; /* Prepare for drag over */
            border-radius: 10px;
        }

        /* DRAG AND DROP STYLES */
        .group-container.drag-active {
            border-color: var(--simple-blue);
            background-color: rgba(0, 147, 233, 0.05);
            border-style: dashed;
        }

        .group-header {
            background-color: #FFF;
            border: 1px solid #EAEAEA;
            border-radius: 8px; /* Rounded corners for card look */
            padding: 20px 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            user-select: none;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            pointer-events: none; /* Let clicks pass through if needed, but we handle click on header */
        }
        /* Enable pointer events on header specifically for click to collapse */
        .group-header { pointer-events: auto; } 

        .group-header:hover { 
            box-shadow: 0 4px 12px rgba(0,0,0,0.06); 
            transform: translateY(-1px);
            border-color: #DDD;
        }
        
        .group-icon-square {
            width: 42px; 
            height: 42px;
            border-radius: 10px;
            background: var(--simple-blue);
            color: #FFF;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-weight: 700; 
            font-size: 18px;
            margin-right: 18px;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .group-info { flex: 1; pointer-events: none; }
        .group-title-text { 
            font-size: 16px; 
            font-weight: 700; 
            color: #333; 
            line-height: 1.2;
        }
        .group-subtitle { 
            font-size: 13px; 
            color: #999; 
            font-weight: 500;
            margin-top: 2px;
        }

        .group-stats { 
            text-align: right; 
            margin-right: 20px; 
            pointer-events: none;
        }
        .group-balance { 
            font-size: 15px; 
            font-weight: 700; 
            color: #333; 
        }
        .group-target { 
            font-size: 12px; 
            color: #999; 
        }

        .group-chevron { 
            color: #CCC; 
            font-size: 12px; 
            transition: transform 0.2s; 
        }
        .group-header.collapsed .group-chevron { transform: rotate(-90deg); }
        .group-header.collapsed {
            border-radius: 8px; /* Keep rounded when collapsed */
        }
        
        .group-content { display: block; margin-top: 5px; min-height: 10px; }
        .group-content.collapsed { display: none; }
        
        /* Style items inside groups */
        .group-content .exp-item {
            background: #FAFAFA; /* Slightly distinct background */
            border-left: 4px solid #E0E0E0; 
            margin-left: 15px; /* Indent */
            margin-right: 15px;
            border-radius: 4px;
            margin-bottom: 1px;
            border-bottom: 1px solid #EEE;
        }
        .group-content .exp-item:first-child { border-top-left-radius: 4px; border-top-right-radius: 4px; }
        .group-content .exp-item:last-child { border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; border-bottom: none;}

        /* --- NEW: MANAGE BUTTON STYLE --- */
        .btn-manage-groups {
            background: transparent;
            color: #767676;
            border: 1px solid transparent;
            padding: 8px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .btn-manage-groups:hover {
            background: #F5F5F5;
            color: var(--simple-blue);
        }
        .icon-gear { font-size: 14px; }

        /* --- GROUP MANAGEMENT MODAL STYLES --- */
        .mgmt-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #F4F4F4;
        }
        .mgmt-list-item:last-child { border-bottom: none; }
        .mgmt-name { font-weight: 600; font-size: 14px; color: #333; }
        .mgmt-actions { display: flex; gap: 15px; }
        .action-icon { cursor: pointer; font-size: 13px; font-weight: 600; color: #999; transition: color 0.2s; }
        .action-icon:hover { color: var(--simple-blue); }
        .action-icon.delete:hover { color: var(--alert-red); }

        .pocket-select-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #EEE;
            border-radius: 4px;
            margin-top: 10px;
        }
        .pocket-select-row {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #FAFAFA;
            cursor: pointer;
        }
        .pocket-select-row:hover { background: #F9F9F9; }
        .pocket-select-row:last-child { border-bottom: none; }
        .ps-checkbox { margin-right: 12px; width: 16px; height: 16px; accent-color: var(--simple-blue); }
        .ps-name { font-weight: 600; font-size: 13px; color: #333; flex: 1; }
        .ps-current-group { font-size: 11px; color: #999; background: #F0F0F0; padding: 2px 6px; border-radius: 4px; }

        /* --- MODERN CARD ROW STYLES --- */
        .card-row {
            display: flex;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 1px solid #EAEAEA;
            background: #FFF;
            transition: background 0.1s;
        }
        .card-row:hover { background: #FAFAFA; }
        
        /* Left: Icon & Name */
        .card-icon {
            width: 48px;
            height: 30px;
            border-radius: 4px;
            margin-right: 20px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-icon::after {
            content:''; position:absolute; top:4px; left:4px; width:8px; height:5px; 
            background:rgba(255,255,255,0.4); border-radius:1px; 
        }
        .card-info { flex: 1; }
        .card-name { font-weight: 700; font-size: 16px; color: #2C2C2C; margin-bottom: 2px; }
        .card-meta { font-size: 13px; color: #999; font-weight: 500; }

        /* Right: Controls Area */
        .card-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .spend-label {
            font-size: 11px;
            font-weight: 700;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modern-select {
            appearance: none;
            -webkit-appearance: none;
            background-color: #FFF;
            border: 1px solid #DDD;
            border-radius: 4px;
            padding: 8px 32px 8px 12px;
            font-size: 14px;
            color: #333;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23999%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 10px auto;
            min-width: 140px;
        }
        .modern-select:hover { border-color: #BBB; }
        .modern-select:focus { border-color: var(--simple-blue); outline: none; }

        .type-badge {
            background: #E3F2FD;
            color: #1565C0;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 6px 10px;
            border-radius: 12px;
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .card-row { flex-direction: column; align-items: flex-start; gap: 15px; }
            .card-controls { width: 100%; justify-content: space-between; }
            .modern-select { flex: 1; }
        }


        /* TRANSACTIONS */
        .tx-group-date { font-size: 12px; color: #999; font-weight: 700; background: #FAFAFA; padding: 8px 15px; border-bottom: 1px solid #EEE; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 2; }
        .tx-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: #FFF; border-bottom: 1px solid #F4F4F4; cursor: pointer; transition: background 0.1s; }
        .tx-row:hover { background: #F7FBFF; }
        .tx-row.credit-card-tx { 
            background: linear-gradient(to right, rgba(102, 126, 234, 0.05) 0%, #FFF 20%);
            border-left: 3px solid #667eea;
            padding-left: 17px;
        }
        .tx-row.credit-card-tx:hover { 
            background: linear-gradient(to right, rgba(102, 126, 234, 0.1) 0%, #F7FBFF 20%);
        }
        .tx-left { display: flex; flex-direction: column; gap: 4px; }
        .tx-title { font-weight: 600; font-size: 14px; color: var(--text-dark); }
        .tx-desc { font-size: 12px; color: #999; }
        .tx-amount { font-weight: 600; font-size: 14px; }
        .tx-neg { color: var(--text-dark); }
        .tx-pos { color: #63BB67; }

        /* EXPENSES & GOALS */
        .exp-summary-bar { font-size: 13px; color: #767676; font-weight: 500; margin-bottom: 15px; text-align: right; }
        
        /* New Expense Hero Card for Mobile */
        .exp-hero-card {
            background: #FFF;
            padding: 20px 25px;
            border-bottom: 1px solid #EAEAEA;
            display: none; /* Hidden on desktop by default */
            flex-direction: row;
            justify-content: space-between;
            align-items: stretch;
        }
        .exp-hero-col { display: flex; flex-direction: column; justify-content: center; }
        .exp-hero-col.right { min-width: 90px; }
        
        .exp-hero-divider {
            width: 1px;
            background-color: #E0E0E0;
            margin: 0 20px;
        }

        .hero-lbl { font-size: 13px; color: #999; font-weight: 400; margin-bottom: 5px; }
        .hero-val { font-size: 16px; font-weight: 600; color: #2C2C2C; }
        .hero-status { font-size: 15px; font-weight: 600; color: #2E7D32; display: flex; align-items: center; gap: 4px; }

        .exp-item { padding: 20px 25px; border-bottom: 1px solid #EAEAEA; cursor: pointer; transition: background-color 0.15s; }
        .exp-item:last-child { border-bottom: none; }
        .exp-item:hover { background-color: #F9F9F9; }
        
        /* Credit card pocket styling */
        .exp-item.credit-card-pocket {
            background: linear-gradient(to right, rgba(102, 126, 234, 0.03) 0%, transparent 100%);
            border-left: 3px solid #667eea;
            padding-left: 22px;
        }
        .exp-item.credit-card-pocket:hover {
            background: linear-gradient(to right, rgba(102, 126, 234, 0.06) 0%, rgba(249, 249, 249, 0.5) 100%);
        }
        .group-content .exp-item.credit-card-pocket {
            background: linear-gradient(to right, rgba(102, 126, 234, 0.05) 0%, rgba(250, 250, 250, 0.8) 100%);
        }
        
        /* Dragging styles for items */
        .exp-item[draggable="true"] { cursor: grab; }
        .exp-item[draggable="true"]:active { cursor: grabbing; }
        .exp-item.is-dragging { opacity: 0.4; background-color: #F0F9FF; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .exp-header-line { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; pointer-events: none; }
        .exp-name { font-weight: 700; font-size: 15px; color: #2C2C2C; }
        .exp-funding-status { font-size: 12px; font-weight: 600; color: #767676; background: #F0F0F0; padding: 3px 8px; border-radius: 4px; }
        .exp-funding-status.ready { background: #E6F8E8; color: #2E7D32; }
        .exp-progress-container { height: 10px; background: var(--exp-track); border-radius: 5px; width: 100%; overflow: hidden; margin-bottom: 10px; pointer-events: none; }
        .exp-progress-bar { height: 100%; background: var(--exp-fill); width: 0%; border-radius: 5px; transition: width 0.5s ease-out; }
        .exp-details { display: flex; justify-content: space-between; font-size: 13px; color: #666; font-weight: 500; pointer-events: none; }

        /* ADD BILL / POCKET ROW STYLES */
        .add-bill-row {
            border: 2px dashed #E0E0E0;
            border-radius: 8px;
            margin: 10px 25px 20px 25px;
            padding: 18px;
            text-align: center;
            color: #999;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .add-bill-row:hover {
            border-color: var(--simple-blue);
            color: var(--simple-blue);
            background: #F7FBFF;
        }


        /* FAMILY TAB */
        .family-section-title { font-size: 14px; font-weight: 700; color: #999; margin: 25px 0 15px 0; text-transform: uppercase; letter-spacing: 0.5px; }
        .family-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .family-card { background: #FFF; border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; position: relative; overflow: hidden; }
        .family-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .color-strip { position: absolute; top: 0; left: 0; right: 0; height: 6px; }
        .profile-img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 2px solid #FFF; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .family-name { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 5px; }
        .family-role { font-size: 12px; font-weight: 500; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }
        .family-balance { font-size: 24px; font-weight: 600; color: #333; margin-top: 15px; }

        /* CARDS TAB */
        .card-row { display: flex; align-items: center; padding: 20px; border-bottom: 1px solid #EAEAEA; background: #FFF; transition: background 0.1s; }
        .card-row:hover { background: #FAFAFA; }
        .card-icon { width: 40px; height: 26px; border-radius: 4px; margin-right: 15px; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card-icon::after { content:''; position:absolute; top:4px; left:4px; width:6px; height:4px; background:rgba(255,255,255,0.5); border-radius:1px; }
        .card-info { flex: 1; }
        .card-name { font-weight: 600; font-size: 15px; color: #333; }
        .card-meta { font-size: 13px; color: #999; margin-top: 2px; }
        .card-type-badge { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 4px 8px; border-radius: 12px; margin-right: 15px; }
        .type-phys { background: #E3F2FD; color: #1565C0; }
        .type-virt { background: #F3E5F5; color: #7B1FA2; }
        .card-status { font-size: 13px; font-weight: 500; width: 100px; text-align: right; }
        .status-active { color: #63BB67; }
        .status-inactive { color: #AAA; }

        /* SIDEBAR */
        .sidebar-column { display: flex; flex-direction: column; overflow: hidden; }
        .sidebar-card { background: #FFF; border: 1px solid var(--border-color); border-radius: 4px; padding: 20px; margin-bottom: 20px; flex-shrink: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
        .card-title { font-size: 13px; font-weight: 700; margin-bottom: 15px; display: flex; justify-content: space-between; color: var(--text-dark); }
        .trend-row { display: flex; justify-content: space-between; padding: 12px 0; font-size: 13px; border-bottom: 1px solid #FAFAFA; }
        .trend-row:last-child { border-bottom: none; }
        .goal-bar-bg { height: 4px; background: #E6E6E6; border-radius: 2px; margin-top: 8px; overflow: hidden; }
        .goal-bar-fill { height: 100%; background: var(--simple-blue); width: 0%; }
        .goal-card-clickable { cursor: pointer; transition: border-color 0.2s; }
        .goal-card-clickable:hover { border-color: var(--simple-blue); }

        /* MODAL */
        /* UPDATE: Z-INDEX Increased to 2100 to beat Bottom Nav (1000) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(3px); display: none; justify-content: center; align-items: center; z-index: 2100; }
        .modal-content { background: #FFF; width: 450px; border-radius: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); border: none; overflow: hidden; animation: popIn 0.2s ease-out; max-width: 90vw; display: flex; flex-direction: column; max-height: 80vh;}
        
        /* Custom Dialog Styles */
        .app-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease-out;
        }
        .app-dialog-overlay.show {
            display: flex;
        }
        .app-dialog {
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: popIn 0.2s ease-out;
            overflow: hidden;
        }
        .app-dialog-header {
            padding: 24px 24px 16px;
            border-bottom: 1px solid var(--border-color);
        }
        .app-dialog-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }
        .app-dialog-body {
            padding: 24px;
            color: var(--text-dark);
            line-height: 1.6;
            white-space: pre-line;
            max-height: 60vh;
            overflow-y: auto;
        }
        .app-dialog-footer {
            padding: 16px 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-top: 1px solid var(--border-color);
        }
        .app-dialog-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            min-width: 80px;
        }
        .app-dialog-button-primary {
            background: var(--simple-blue);
            color: white;
        }
        .app-dialog-button-primary:hover {
            background: #0080d0;
        }
        .app-dialog-button-secondary {
            background: white;
            color: var(--text-dark);
            border: 2px solid var(--border-color);
        }
        .app-dialog-button-secondary:hover {
            border-color: var(--simple-blue);
            color: var(--simple-blue);
        }
        .app-dialog-button-danger {
            background: var(--alert-red);
            color: white;
        }
        .app-dialog-button-danger:hover {
            background: #c5221f;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Animation for Modals (Flex centered) */
        @keyframes popIn { 
            from { transform: scale(0.95); opacity: 0; } 
            to { transform: scale(1); opacity: 1; } 
        }
        
        /* Animation for Fixed/Absolute centered elements (Transform centered) */
        @keyframes popInCenter { 
            from { transform: translateX(-50%) scale(0.95); opacity: 0; } 
            to { transform: translateX(-50%) scale(1); opacity: 1; } 
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-header { padding: 15px 20px; background: #F8F9FB; border-bottom: 1px solid #EEE; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;}
        
        /* UPDATE: Added Scroll Properties for Mobile Forms */
        .modal-body { 
            padding: 30px; 
            overflow-y: auto; /* Allow scroll */
            scrollbar-width: thin;
            -webkit-overflow-scrolling: touch; /* Smooth iOS scroll */
            flex: 1;
        }
        
        .detail-amount { font-size: 36px; font-weight: 700; margin-bottom: 5px; color: #333; letter-spacing: -1px; }
        .detail-title { font-size: 18px; font-weight: 500; color: #555; margin-bottom: 25px; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 14px; border-bottom: 1px solid #FAFAFA; padding-bottom: 10px; }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { color: #999; font-weight: 500; }
        .detail-val { color: #333; font-weight: 600; }
        .close-btn { cursor: pointer; font-size: 24px; color: #999; line-height: 1; }
        .close-btn:hover { color: #333; }
        
        /* Updated Button Styles for Modal Footer */
        .btn-goal-add { 
            background: var(--simple-blue); 
            color: #FFF; 
            width: 100%; 
            padding: 14px; 
            border-radius: 6px; 
            border:none; 
            font-weight:600; 
            font-size:15px; 
            cursor: pointer; 
            margin-top: 10px; /* Default margin for standard forms */
        }
        .btn-goal-add:hover { background: #007BB5; }

        /* NEW DELETE BUTTON STYLE */
        .btn-goal-delete {
            background: #FFF;
            color: var(--alert-red);
            border: 1px solid #E0E0E0; /* Slightly clearer border */
            width: 100%;
            padding: 14px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 15px; /* Matched font size to Add button */
            cursor: pointer;
            margin-top: 15px; /* Default margin */
            transition: all 0.2s;
        }
        .btn-goal-delete:hover {
            background: #FFF5F5; 
            border-color: var(--alert-red);
        }
        
        .btn-primary { background: var(--simple-blue); color: #FFF; width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; }
        .btn-secondary { background: #FFF; color: #555; border: 1px solid #DDD; width: 100%; padding: 12px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; margin-top: 10px; }


        /* --- CUSTOM SUGGESTION DROPDOWN STYLES --- */
        .suggestion-box {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #FFF;
            border: 1px solid #DDD;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000; /* High Z-index */
            display: none; /* Hidden by default */
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); /* Stronger shadow */
        }
        .suggestion-item {
            padding: 12px 10px; /* Larger tap area for mobile */
            cursor: pointer;
            border-bottom: 1px solid #F0F0F0;
            font-size: 14px;
            color: #333;
            background: #FFF;
        }
        .suggestion-item:hover {
            background: #F9F9F9;
            color: var(--simple-blue);
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }

        .form-group { margin-bottom: 15px; }
        .form-row-2 { display: flex; gap: 15px; }
        .form-label { display: block; font-size: 12px; font-weight: 600; color: #777; margin-bottom: 5px; }
        .form-select, .form-input { width: 100%; padding: 10px; border: 1px solid #DDD; border-radius: 4px; font-size: 14px; background: #FFF; }
        .form-select:focus, .form-input:focus { border-color: var(--simple-blue); outline: none; }
        
        /* CHECKBOX & SUBTEXT */
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .checkbox-input { width: 18px; height: 18px; cursor: pointer; }
        .checkbox-label { font-size: 14px; color: #2C2C2C; font-weight: 600; }
        .form-subtext { font-size: 12px; color: #999; margin-top: 5px; line-height: 1.4; padding-left: 2px; }

        /* TABLE STYLES FOR GOAL HISTORY */
        .history-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        .history-table th { text-align: left; color: #999; font-weight: 600; padding-bottom: 10px; border-bottom: 1px solid #EEE; }
        .history-table td { padding: 10px 0; border-bottom: 1px solid #FAFAFA; color: #333; }
        .history-table .bal-col { color: #777; text-align: right; }
        .history-table .amt-col { text-align: right; font-weight: 600; }

        #modal-body-content { max-height: 70vh; overflow-y: auto; scrollbar-width: thin; }

        /* --- POCKET DETAIL SCROLL AREA --- */
        .pocket-header { text-align: center; margin-bottom: 20px; }
        .pocket-balance { font-size: 42px; font-weight: 700; color: #2C2C2C; margin-bottom: 5px; letter-spacing: -1px; }
        .pocket-sub { font-size: 14px; color: #999; margin-bottom: 25px; font-weight: 500; }
        .pocket-tx-scroll {
            max-height: 350px;
            overflow-y: auto;
            border-top: 1px solid #EEE;
            margin: 0 -30px; /* Bleed to edge */
            padding: 0 30px;
            scrollbar-width: thin;
        }
        .pocket-tx-scroll::-webkit-scrollbar { width: 6px; }
        .pocket-tx-scroll::-webkit-scrollbar-thumb { background-color: #DDD; border-radius: 3px; }
        
        .pocket-tx-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #FAFAFA;
            font-size: 14px;
        }
        .pocket-tx-row:last-child { border-bottom: none; }
        .pocket-tx-date { color: #999; font-size: 12px; width: 80px; }
        .pocket-tx-title { font-weight: 600; color: #333; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 15px; }
        .pocket-tx-amt { font-weight: 600; text-align: right; }

        /* UNGROUPED DROP ZONE */
        .ungrouped-zone {
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 5px;
            transition: all 0.2s;
        }
        .ungrouped-zone.drag-active {
            border-color: #E0E0E0;
            background-color: #FAFAFA;
            border-style: dashed;
        }

        /* --- MOBILE ADAPTATIONS --- */
        @media (max-width: 768px) {
            :root {
                --nav-height: 60px;
                --bottom-nav-height: calc(60px + env(safe-area-inset-bottom)); /* Add safe area */
            }

            body {
                overflow-y: auto; 
                padding-bottom: var(--bottom-nav-height); 
                height: auto;
                min-height: 100vh;
                background-color: #F8F9FB; /* Light gray bg for contrast on mobile */
            }

            /* TRANSFORM NAV TO STICKY TOP HEADER & BOTTOM TABS */
            .top-nav {
                padding: 0 15px;
                position: sticky;
                top: 0;
                width: 100%;
                z-index: 900;
                justify-content: space-between; 
                /* IMPORTANT: Removed backdrop-filter from parent to allow fixed children */
                background: #FFFFFF; 
                border-bottom: 1px solid rgba(0,0,0,0.05);
            }

            /* HIDE NAV LINKS ON MOBILE BUT KEEP LOGO */
            .nav-left {
                width: auto;
                gap: 0;
                display: flex;
            }
            .nav-left a.nav-link { display: none; } /* Hide desktop links */
            .logo { display: flex; margin-right: 0; }

            /* CREATE A NEW CENTERED MOBILE HEADER WITHIN NAV */
            .mobile-center-header {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                white-space: nowrap; /* Prevents jumping */
            }
            .mobile-top-label {
                font-size: 10px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: #2C2C2C; /* Darker label */
                font-weight: 600;
                line-height: 1;
                margin-bottom: 3px;
            }
            .mobile-top-balance {
                font-size: 15px;
                font-weight: 700;
                color: var(--simple-blue); /* BLUE COLOR AS REQUESTED */
                line-height: 1;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            /* FIXED BOTTOM NAV */
            .mobile-bottom-nav {
                display: flex; /* Show only on mobile */
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                z-index: 1000;
                background: rgba(255, 255, 255, 0.98); 
                backdrop-filter: blur(10px);
                height: var(--bottom-nav-height);
                padding-bottom: env(safe-area-inset-bottom);
                border-top: 1px solid rgba(0,0,0,0.1);
                box-shadow: 0 -1px 10px rgba(0,0,0,0.02);
            }

            .mobile-nav-link {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 4px;
                color: #999;
                font-size: 10px;
                font-weight: 500;
                cursor: pointer;
            }
            
            .mobile-nav-link svg {
                width: 22px;
                height: 22px;
                fill: none;
                stroke: currentColor;
                stroke-width: 2;
                stroke-linecap: round;
                stroke-linejoin: round;
            }

            .mobile-nav-link.active {
                color: var(--simple-blue);
            }
            .mobile-nav-link.active svg {
                stroke: var(--simple-blue);
                stroke-width: 2.5;
            }

            /* Top Right Profile */
            .nav-right {
                position: absolute;
                right: 15px;
                gap: 10px;
            }
            .user-profile span { display: none; }
            .user-profile .avatar { display: flex; width: 30px; height: 30px; font-size: 12px; }

            /* MAIN LAYOUT */
            .main-grid {
                grid-template-columns: 1fr;
                padding: 0 15px;
                height: auto;
                display: flex;
                flex-direction: column;
                overflow: visible;
                gap: 20px;
                margin-bottom: 20px;
                margin-top: 5px; /* TIGHTER SPACING FOR MOBILE */
            }

            .main-column {
                overflow: visible;
                height: auto;
            }


            .draggable-item.is-dragging {
                opacity: 0.5;
                background: #eef;
                border: 1px dashed #ccc;
            }
            /* Ensure the drop zone has height so you can drop into an empty group */
            .group-content {
                min-height: 50px; 
                transition: padding 0.2s;
            }
            .ungrouped-zone {
                min-height: 100px;
            }
            /* Visual indicator line when sorting */
            .sortable-placeholder {
                height: 4px;
                background: var(--simple-blue);
                border-radius: 2px;
                margin: 5px 0;
            }

            /* HEADER INFO MOBILE OVERRIDES */
            /* Hide the big info header on mobile since we moved it to top nav */
            .info-header {
                display: none; 
            }

            /* CONTROLS */
            .controls-bar {
                padding: 15px;
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
                background: #FFF;
                border-bottom: 1px solid #EEE;
            }
            #search-container { width: 100%; }
            .search-input { height: 40px; background: #F4F6F8; border:none; } 
            .btn { height: 40px; display: flex; align-items: center; justify-content: center; }
            .btn-outline { background: #FFF; border: 1px solid #DDD; }
            .btn-move { justify-content: center; width: 100%; margin-top: 0; background: #FFF; border: 1px solid #DDD; font-weight: 600; }

            /* FILTERS */
            .filters {
                padding: 10px 15px;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 10px;
                gap: 8px;
                background: #FFF;
                margin-bottom: 0; /* Attach to grid */
                margin-top: 0;
            }
            .pill { padding: 6px 14px; font-size: 12px; background: #F0F2F5; }
            
            /* UPDATED MOBILE POPUP STYLE: FIXED POS */
            .filter-popup {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 350px;
                z-index: 2000;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            }

            /* DATA CONTAINERS */
            .data-container {
                border-radius: 0; /* Full width feel */
                border: none;
                border-top: 1px solid var(--border-color);
                overflow: visible;
                max-height: none;
                background: #FFF;
                margin: 0 -15px; /* Bleed to edges */
            }
            
            /* TRANSACTIONS & LISTS */
            /* UPDATED: Removed top margin to remove blank space */
            .section-header-row { 
                margin: 0 0 10px 0; 
                border: none; 
                padding: 15px 5px 5px 5px; 
                flex-wrap: wrap; 
            }
            .tab-title { font-size: 16px; font-weight: 800; color: #111; margin-right: 15px; }
            /* Styling for the subtitle on mobile specifically to match screenshot */
            .exp-summary { display: none; }

            .exp-hero-card { display: flex; margin: 0 -15px; border-top: 1px solid #EEE; }

            .tx-group-date { background: #F8F9FB; color: #555; border-bottom: 1px solid #EEE; padding: 10px 20px; font-weight: 600; font-size: 11px; }
            .tx-row { padding: 18px 20px; }
            .tx-title { font-size: 15px; font-weight: 500; }
            .tx-desc { margin-top: 2px; }
            .tx-amount { font-size: 15px; font-weight: 600; }

            .add-bill-row {
                margin: 10px 15px; /* Tighter margins on mobile */
            }

            /* REMOVE SIDEBAR ON MOBILE */
            .sidebar-column { display: none !important; }

            /* MODALS */
            .modal-content {
                width: 90%;
                margin: 0 auto;
            }
            /* Reduce padding for mobile modals to fit more content */
            .modal-body {
                padding: 20px;
            }
        }
        
        /* NEW STYLES FOR MOBILE STS DROPDOWN */
        .mobile-sts-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            /* Fixed: Ensure static transform includes translateX(-50%) */
            transform: translateX(-50%);
            background: #FFF;
            border: 1px solid #EEE;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-radius: 8px;
            padding: 15px;
            width: 200px;
            margin-top: 10px;
            z-index: 2000;
            text-align: right;
            cursor: default;
        }
        .mobile-sts-dropdown.show { display: block; animation: popInCenter 0.2s ease-out; }
        .mobile-sts-dropdown::before { /* Little arrow pointing up */
            content: ''; position: absolute; top: -6px; left: 50%; margin-left: -6px;
            border-width: 0 6px 6px 6px; border-style: solid; border-color: transparent transparent #FFF transparent;
        }
        .mb-dropdown-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #333; }
        .mb-dropdown-row.minus { color: #D93025; }
        .mb-dropdown-row.total { font-weight: 700; color: var(--simple-blue); margin-bottom: 0; font-size: 14px; }
        .mb-dropdown-divider { height: 1px; background: #EEE; margin: 8px 0; }
        .mb-math-label { color: #999; font-weight: 500; font-size: 11px; text-transform: uppercase; margin-left: 10px; }
        .header-arrow { font-size: 10px; margin-left: 4px; transition: transform 0.2s; display: inline-block; }
        .mobile-center-header.active .header-arrow { transform: rotate(180deg); }
        
        /* Desktop specific hide */
        @media (min-width: 769px) {
            .mobile-bottom-nav { display: none; }
            .mobile-center-header { display: none; }
        }
    </style>
</head>
<body>

    <div id="group-mgmt-modal" class="modal-overlay" onclick="closeGroupMgmt()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span id="mgmt-title" style="font-weight:700; color:#333; font-size:14px;">Manage Groups</span>
                <span class="close-btn" onclick="closeGroupMgmt()">×</span>
            </div>
            <div class="modal-body" id="mgmt-body">
                </div>
        </div>
    </div>

    <div id="tx-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span id="modal-title-text" style="font-weight:600; color:#999; font-size:12px; letter-spacing:1px; text-transform:uppercase;">Details</span>
                <span class="close-btn" onclick="closeModal(event)">×</span>
            </div>
            <div class="modal-body" id="modal-body-content"><div style="text-align:center; padding: 20px;">Loading...</div></div>
        </div>
    </div>

    <div id="move-modal" class="modal-overlay" onclick="closeMoveModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span style="font-weight:600; color:#999; font-size:12px; letter-spacing:1px; text-transform:uppercase;">Move Money</span>
                <span class="close-btn" onclick="closeMoveModal(event)">×</span>
            </div>
            <div class="modal-body">
                <div id="move-message"></div>
                <div class="form-group"><label class="form-label">From</label><select id="move-from" class="form-select"><option>Loading...</option></select></div>
                <div class="form-group"><label class="form-label">To</label><select id="move-to" class="form-select"><option>Loading...</option></select></div>
                <div class="form-group"><label class="form-label">Amount</label><input type="number" id="move-amount" class="form-input" placeholder="0.00" step="0.01"></div>
                <div class="form-group"><label class="form-label">Note (Optional)</label><input type="text" id="move-note" class="form-input" placeholder="What's this for?"></div>
                <button class="btn-goal-add" onclick="executeTransfer()">Transfer Funds</button>
            </div>
        </div>
    </div>

    <div id="bill-modal" class="modal-overlay" onclick="closeBillModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span style="font-weight:600; color:#999; font-size:12px; letter-spacing:1px; text-transform:uppercase;">Add Expense</span>
                <span class="close-btn" onclick="closeBillModal(event)">×</span>
            </div>
            <div class="modal-body">
                <div id="bill-message"></div>
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" id="bill-name" class="form-input" placeholder="e.g. Netflix">
                </div>
                
                <div class="form-row-2" style="position:relative; z-index:4;">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Amount</label>
                        <input type="number" id="bill-amount" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Frequency</label>
                        <select id="bill-freq" class="form-select">
                            <option value="MONTHLY">Once A Month</option>
                            <option value="WEEKLY">Every Week</option>
                            <option value="BIWEEKLY">Every two weeks</option>
                            <option value="QUARTERLY">Every three Months</option>
                            <option value="SEMI_ANNUALLY">Twice a year</option>
                            <option value="ANNUALLY">Once a year</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="position:relative; z-index:3;">
                    <label class="form-label">Day of Month</label>
                    <select id="bill-day" class="form-select">
                        </select>
                </div>

                <div class="form-group" style="position:relative; z-index:50;">
                    <label class="form-label">Identification (Search Transactions)</label>
                    <input type="text" id="bill-id-search" class="form-input" placeholder="Type to search..." autocomplete="off">
                    <div id="suggestion-box" class="suggestion-box"></div>
                </div>

                <div class="form-row-2" style="position:relative; z-index:1;">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Min Amount</label>
                        <input type="number" id="bill-min" class="form-input" placeholder="0.00">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Max Amount</label>
                        <input type="number" id="bill-max" class="form-input" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="bill-variable" class="checkbox-input">
                        <span class="checkbox-label">Adjust for Variable Bills</span>
                    </label>
                    <div class="form-subtext">If a bill is different than expected, update its reservation amount for the next period</div>
                </div>

                <button class="btn-goal-add" onclick="saveBill()">Create Bill</button>
            </div>
        </div>
    </div>

    <div id="pocket-modal" class="modal-overlay" onclick="closePocketModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span style="font-weight:600; color:#999; font-size:12px; letter-spacing:1px; text-transform:uppercase;">Create Pocket</span>
                <span class="close-btn" onclick="closePocketModal(event)">×</span>
            </div>
            <div class="modal-body">
                <div id="pocket-message"></div>
                <div class="form-group">
                    <label class="form-label">Pocket Name</label>
                    <input type="text" id="pocket-name" class="form-input" placeholder="e.g. Vacation Fund">
                </div>

                <div class="form-group">
                    <label class="form-label">Initial Funding</label>
                    <input type="number" id="pocket-initial" class="form-input" placeholder="0.00">
                    <div id="pocket-funding-hint" class="form-subtext">Safe-to-Spend: $0.00</div>
                </div>                
                
                <div class="form-group">
                    <label class="form-label">Goal Amount ($)</label>
                    <input type="number" id="pocket-amount" class="form-input" placeholder="0.00">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Group (Optional)</label>
                    <select id="pocket-group" class="form-select">
                        <option value="">No Group</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Description (Optional)</label>
                    <input type="text" id="pocket-desc" class="form-input" placeholder="What is this for?">
                </div>

                <button class="btn-goal-add" onclick="savePocket()">Create Pocket</button>
            </div>
        </div>
    </div>

    <nav class="top-nav">
        <div class="nav-left">
            <div class="logo"><img src="https://d31s10tn3clc14.cloudfront.net/imgs/deposits/Review+Logos/simple-logo.png" alt="Simple"></div>
            <a onclick="switchTab('activity')" id="nav-activity" class="nav-link active">Activity</a>
            <a onclick="switchTab('expenses')" id="nav-expenses" class="nav-link">Expenses</a>
            <a onclick="switchTab('goals')" id="nav-goals" class="nav-link">Pockets</a>
            <a onclick="switchTab('family')" id="nav-family" class="nav-link">Family</a>
            <a onclick="switchTab('cards')" id="nav-cards" class="nav-link">Cards</a>
            <a onclick="switchTab('credit')" id="nav-credit" class="nav-link">Credit</a>
        </div>

        <div class="mobile-center-header" onclick="toggleMobileStats(event)">
            <div class="mobile-top-label" id="mobile-header-label">Safe-to-Spend®</div>
            <div class="mobile-top-balance" id="mobile-header-balance">$ --.-- <span class="header-arrow">▼</span></div>
            
            <div id="mobile-sts-dropdown" class="mobile-sts-dropdown">
                <div class="mb-dropdown-row"><span id="mb-math-total">$0.00</span> <span class="mb-math-label">Available</span></div>
                <div class="mb-dropdown-row minus"><span id="mb-math-bills">-$0.00</span> <span class="mb-math-label">Bills</span></div>
                <div class="mb-dropdown-row minus"><span id="mb-math-goals">-$0.00</span> <span class="mb-math-label">Pockets</span></div>
                <div class="mb-dropdown-divider"></div>
                <div class="mb-dropdown-row total"><span id="mb-math-sts">$0.00</span> <span class="mb-math-label">Safe-to-Spend</span></div>
            </div>
        </div>
        <div class="nav-right">
            <div class="user-profile">
                <div class="avatar" id="user-avatar">--</div>
                <span style="font-weight:500;" id="user-name">Loading...</span>
                <span style="font-size: 10px;">▼</span>
            </div>
        </div>
    </nav>

    <div class="mobile-bottom-nav">
        <div onclick="switchTab('activity')" id="mb-nav-activity" class="mobile-nav-link active">
            <svg viewBox="0 0 24 24"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
            <span>Activity</span>
        </div>
        <div onclick="switchTab('expenses')" id="mb-nav-expenses" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            <span>Expenses</span>
        </div>
        <div onclick="switchTab('goals')" id="mb-nav-goals" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
            <span>Pockets</span>
        </div>
        <div onclick="switchTab('family')" id="mb-nav-family" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="7" r="4"/><path d="M5.5 21v-2a4 4 0 0 1 4-4h5a4 4 0 0 1 4 4v2"/></svg>
            <span>Family</span>
        </div>
        <div onclick="switchTab('cards')" id="mb-nav-cards" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>
            <span>Cards</span>
        </div>
        <div onclick="switchTab('credit')" id="mb-nav-credit" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>
            <span>Credit</span>
        </div>
        
        <div onclick="openIntercom()" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
            <span>Help</span>
        </div>
    </div>

    <div class="info-header">
        <div class="balance-container">
            <h1><span id="sts-balance">$ --.--</span><span class="sts-label">Safe-to-Spend®</span></h1>
            <div class="math-line"><span id="math-total">$0.00</span> <span class="math-gray">available balance</span> - <span id="math-sched">$0.00</span> <span class="math-gray">in Bills</span> - <span id="math-goals">$0.00</span> <span class="math-gray">in Pockets</span></div>
        </div>
        <div class="header-links">
            <button class="btn btn-move" id="btn-move-money" onclick="openMoveModal()">Move Money <span style="font-size:16px; line-height:0;">⇅</span></button>
            <div class="header-link-group"><span class="header-link-label">CDs</span><a href="#" class="header-link-action">Open a CD today!</a></div>
        </div>
    </div>

    <div class="controls-bar" id="controls-bar">
        <div class="search-wrapper" id="search-container"><input type="text" class="search-input" id="search-input-box" placeholder="Search activity..."><button class="btn btn-outline" onclick="triggerSearch()">Search</button></div>
    </div>

    <div class="filters" id="filter-bar">
        <span style="color: #999; font-size: 12px;">Current Filters:</span>
        <div id="active-filters" style="display:flex; gap:10px;"><div class="pill" onclick="removeFilter('date')">Last 6 months <span class="pill-remove">×</span></div></div>
        <span class="link-blue" onclick="toggleFilterMenu()">More Filters ⌵</span>
        <div id="filter-menu" class="filter-popup">
            <div class="popup-header">
                <span class="popup-title">Filter Transactions</span>
                <span class="close-popup" onclick="toggleFilterMenu()">×</span>
            </div>
            <div class="filter-group"><span class="filter-label">Date Range</span><div class="filter-row"><input type="date" id="filter-min-date" class="filter-input"><input type="date" id="filter-max-date" class="filter-input"></div></div>
            <div class="filter-group"><span class="filter-label">Amount Range ($)</span><div class="filter-row"><input type="number" id="filter-min-amt" class="filter-input" placeholder="Min"><input type="number" id="filter-max-amt" class="filter-input" placeholder="Max"></div></div>
            <button class="btn-apply" onclick="applyFilters()">Apply Filters</button>
        </div>
    </div>

    <div class="main-grid">
        <div class="main-column">

            <div id="view-activity" class="view-section active">
                <div class="section-header-row"><span class="tab-title">Transactions</span><div class="view-toggles"><span class="active">≡ List</span></div></div>
                <div id="list-container" class="data-container"><div id="tx-loading" style="text-align:center; padding:20px; color:#999;">Loading transactions...</div><div id="tx-content"></div></div>
            </div>

            <div id="view-expenses" class="view-section">
                <div class="section-header-row"><span class="tab-title">Monthly Expenses</span><div class="exp-summary" id="exp-summary-text"></div></div>
                <div id="exp-hero-container"></div>
                <div id="expenses-list" class="data-container">
                    <div style="text-align:center; padding:20px; color:#999;">Loading expenses...</div>
                </div>
            </div>

            <div id="view-goals" class="view-section">
                <div class="section-header-row">
                    <span class="tab-title">Pockets</span>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-manage-groups" onclick="toggleCreditCardPocketsVisibility()" id="toggle-cc-pockets-btn" style="padding: 8px 12px;">
                            <span id="cc-pockets-toggle-text">💳 Show CC</span>
                        </button>
                        <button class="btn-manage-groups" onclick="openGroupMgmt()">
                            <span>Manage Groups</span>
                            <span class="icon-gear">⚙️</span>
                        </button>
                    </div>
                </div>
                <div id="goals-list" class="data-container"><div style="text-align:center; padding:20px; color:#999;">Loading goals...</div></div>
            </div>

            <div id="view-family" class="view-section">
                <div class="section-header-row"><span class="tab-title">Family</span></div>
                <div class="data-container" style="padding: 20px;">
                    <div id="family-content"><div style="text-align:center; padding:20px; color:#999;">Loading family...</div></div>
                </div>
            </div>

            <div id="view-cards" class="view-section">
                <div class="section-header-row"><span class="tab-title">Cards</span></div>
                <div class="data-container">
                    <div id="cards-content"><div style="text-align:center; padding:20px; color:#999;">Loading cards...</div></div>
                </div>
            </div>

            <div id="view-credit" class="view-section">
                <div class="section-header-row"><span class="tab-title">Credit Cards</span></div>
                <div class="data-container" style="padding: 40px 20px;">
                    <div style="max-width: 800px; margin: 0 auto;">
                        <!-- Setup Screen (shown when no API key or not configured) -->
                        <div id="credit-setup-screen">
                            <div style="text-align: center; margin-bottom: 40px;">
                                <div style="font-size: 48px; margin-bottom: 20px;">💳</div>
                                <h1 style="font-size: 32px; font-weight: 600; color: var(--text-dark); margin-bottom: 10px;">Set Up Credit Card Tracking</h1>
                                <p style="font-size: 18px; color: var(--text-light); line-height: 1.6;">
                                    Connect your credit card to track transactions and stay in sync with Crew.
                                </p>
                            </div>

                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 40px; margin-bottom: 40px; color: white;">
                                <h2 style="font-size: 24px; font-weight: 600; margin-bottom: 20px;">How It Works</h2>
                                <div style="line-height: 1.8; font-size: 16px;">
                                    <p style="margin-bottom: 16px;">
                                        When you connect your credit card, Crew automatically creates a <strong>"Credit Card" Pocket</strong> to keep your spending in sync.
                                    </p>
                                    <p style="margin-bottom: 16px;">
                                        Money automatically moves from your <strong>Safe-to-Spend</strong> to your Credit Card Pocket whenever you make a purchase, ensuring you always have enough set aside to pay off your credit card balance.
                                    </p>
                                    <p>
                                        This way, you can enjoy the benefits of credit cards—building credit history, earning points and cash back—without the worry of overspending.
                                    </p>
                                </div>
                            </div>

                            <!-- Provider Selection -->
                            <div id="provider-selection" style="display: none;">
                                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark); text-align: center;">Choose Your Provider</h3>
                                <p style="color: var(--text-light); margin-bottom: 30px; text-align: center;">Select how you'd like to connect your credit card account.</p>

                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                    <div onclick="selectProvider('lunchflow')" style="background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 30px; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.borderColor='var(--simple-blue)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                        <div style="font-size: 48px; margin-bottom: 16px;">🍱</div>
                                        <h4 style="font-size: 18px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">LunchFlow</h4>
                                        <p style="font-size: 14px; color: var(--text-light); line-height: 1.5; margin-bottom: 12px;">
                                            API-based connection with daily syncing
                                        </p>
                                        <span style="display: inline-block; background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Recommended</span>
                                    </div>

                                    <div onclick="selectProvider('simplefin')" style="background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 30px; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.borderColor='var(--simple-blue)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                        <div style="font-size: 48px; margin-bottom: 16px;">🔐</div>
                                        <h4 style="font-size: 18px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">SimpleFin</h4>
                                        <p style="font-size: 14px; color: var(--text-light); line-height: 1.5; margin-bottom: 12px;">
                                            Direct protocol connection via token
                                        </p>
                                        <span style="display: inline-block; background: #f3e5f5; color: #7b1fa2; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Open Protocol</span>
                                    </div>
                                </div>
                            </div>

                            <!-- LunchFlow Setup -->
                            <div id="lunchflow-setup" style="display: none;">
                                <div style="margin-bottom: 20px;">
                                    <button onclick="showProviderSelection()" style="background: none; border: none; color: var(--simple-blue); cursor: pointer; font-size: 14px; padding: 8px 0;">
                                        ← Back to provider selection
                                    </button>
                                </div>

                                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">LunchFlow Setup</h3>

                                <!-- API Key Setup Instructions -->
                                <div id="api-key-setup" style="background: #f8f9fa; border-radius: 12px; padding: 30px; margin-bottom: 30px; border: 2px dashed #ddd;">
                                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">Step 1: Configure LunchFlow API Key</h3>
                                <ol style="line-height: 2; color: var(--text-light); padding-left: 20px;">
                                    <li>Sign up for a <a href="https://lunchflow.app" target="_blank" style="color: var(--simple-blue);">LunchFlow account</a></li>
                                    <li>Create an API destination in your LunchFlow dashboard</li>
                                    <li>Copy your API key from the destination settings</li>
                                    <li>Add it to your <code style="background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-family: monospace;">docker-compose.yml</code> file:</li>
                                </ol>
                                <div style="background: #2d2d2d; color: #f8f8f2; padding: 16px; border-radius: 8px; margin: 16px 0; font-family: monospace; font-size: 13px; overflow-x: auto;">
                                    <div>environment:</div>
                                    <div>&nbsp;&nbsp;- BEARER_TOKEN=...</div>
                                    <div>&nbsp;&nbsp;- LUNCHFLOW_API_KEY=<span style="color: #ffd700;">YOUR_API_KEY_HERE</span></div>
                                </div>
                                <p style="color: var(--text-light); margin-top: 16px; font-size: 14px;">
                                    Once you've added your API key, restart the Docker container and refresh this page.
                                </p>
                            </div>

                                <!-- Account Selection (shown when API key is configured) -->
                                <div id="account-selection" style="display: none;">
                                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">Step 2: Select Your Credit Card Account</h3>
                                    <p style="color: var(--text-light); margin-bottom: 20px;">
                                        Select which account from your LunchFlow connections should be tracked as your credit card account:
                                    </p>
                                    <div id="accounts-list" style="margin-bottom: 20px;">
                                        <div style="text-align: center; padding: 40px; color: #999;">
                                            <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid var(--simple-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                                            Loading accounts...
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- SimpleFin Setup -->
                            <div id="simplefin-setup" style="display: none;">
                                <div style="margin-bottom: 20px;">
                                    <button onclick="showProviderSelection()" style="background: none; border: none; color: var(--simple-blue); cursor: pointer; font-size: 14px; padding: 8px 0;">
                                        ← Back to provider selection
                                    </button>
                                </div>

                                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">SimpleFin Setup</h3>

                                <!-- Invalid Token Warning -->
                                <div id="simplefin-invalid-warning" style="display: none; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                                        <div style="font-size: 24px;">⚠️</div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; margin-bottom: 8px; color: #e65100;">SimpleFin Token Invalid or Revoked</div>
                                            <p style="color: #e65100; line-height: 1.6; margin-bottom: 12px; font-size: 14px;">
                                                Your SimpleFin access token has been revoked or is no longer valid. This can happen if you deleted the connection from your bank's side or if the token expired.
                                            </p>
                                            <button onclick="disconnectSimpleFin()" style="background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                                Disconnect SimpleFin
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Token Input -->
                                <div id="simplefin-token-input" style="background: #f8f9fa; border-radius: 12px; padding: 30px; margin-bottom: 30px; border: 2px dashed #ddd;">
                                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">Step 1: Enter Your SimpleFin Setup Token</h3>
                                    <ol style="line-height: 2; color: var(--text-light); padding-left: 20px; margin-bottom: 20px;">
                                        <li>Get your SimpleFin setup token from your bank or financial institution</li>
                                        <li>The token is a Base64-encoded string (one-time use only)</li>
                                        <li>Paste the token below and click "Connect"</li>
                                    </ol>
                                    <div style="margin-bottom: 16px;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">SimpleFin Setup Token</label>
                                        <input type="text" id="simplefin-token-field" placeholder="Paste your Base64-encoded setup token here" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: monospace; font-size: 13px;">
                                    </div>
                                    <button onclick="claimSimpleFinToken()" style="background: var(--simple-blue); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                        Claim Setup Token
                                    </button>
                                    <p style="color: var(--text-light); margin-top: 16px; font-size: 14px;">
                                        Note: The setup token is one-time use. Once claimed, it cannot be used again. Your access credentials will be securely stored.
                                    </p>
                                </div>

                                <!-- Account Selection (shown after token claimed) -->
                                <div id="simplefin-account-selection" style="display: none;">
                                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">Step 2: Select Your Credit Card Account</h3>
                                    <p style="color: var(--text-light); margin-bottom: 20px;">
                                        Select which account from your SimpleFin connection should be tracked as your credit card account:
                                    </p>
                                    <div id="simplefin-accounts-list" style="margin-bottom: 20px;">
                                        <div style="text-align: center; padding: 40px; color: #999;">
                                            <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid var(--simple-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                                            Loading accounts...
                                        </div>
                                    </div>
                                </div>

                                <div style="background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 8px; padding: 20px; margin-top: 30px;">
                                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                                        <div style="font-size: 24px;">ℹ️</div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; margin-bottom: 8px; color: #1565c0;">About SimpleFin</div>
                                            <p style="color: #1565c0; line-height: 1.6; margin: 0; font-size: 14px;">
                                                SimpleFin is a read-only financial data sharing protocol. Your token contains credentials that allow secure access to your account data without sharing passwords. Learn more at <a href="https://www.simplefin.org/protocol.html" target="_blank" style="color: #1565c0; text-decoration: underline;">simplefin.org</a>.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Balance Sync Confirmation Modal (shown after account selection) -->
                            <div id="balance-sync-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; flex-direction: column;">
                                <div style="background: white; border-radius: 16px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin: auto;">
                                    <h3 style="font-size: 24px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">Sync Balance?</h3>
                                    <p style="color: var(--text-light); margin-bottom: 24px; line-height: 1.6;">
                                        Would you like to sync the pocket balance to match your credit card's current balance?
                                    </p>
                                    <div id="balance-display" style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 24px; text-align: center;">
                                        <div style="font-size: 14px; color: var(--text-light); margin-bottom: 8px;">Current Credit Card Balance</div>
                                        <div id="balance-amount" style="font-size: 32px; font-weight: 700; color: var(--text-dark);">Loading...</div>
                                    </div>
                                    <div style="display: flex; gap: 12px;">
                                        <button onclick="handleBalanceSync(false)" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; background: white; border-radius: 8px; font-weight: 600; cursor: pointer; color: var(--text-dark);">Skip</button>
                                        <button onclick="handleBalanceSync(true)" style="flex: 1; padding: 12px; border: none; background: var(--simple-blue); color: white; border-radius: 8px; font-weight: 600; cursor: pointer;">Sync Balance</button>
                                    </div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-top: 40px;">
                                <div style="background: #f8f9fa; border-radius: 12px; padding: 24px;">
                                    <div style="font-size: 32px; margin-bottom: 12px;">🔗</div>
                                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">Connect Your Card</h3>
                                    <p style="font-size: 14px; color: var(--text-light); line-height: 1.5;">
                                        Connect your credit card through LunchFlow. Crew will securely sync your account information.
                                    </p>
                                </div>

                                <div style="background: #f8f9fa; border-radius: 12px; padding: 24px;">
                                    <div style="font-size: 32px; margin-bottom: 12px;">💰</div>
                                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">Auto-Sync Pocket</h3>
                                    <p style="font-size: 14px; color: var(--text-light); line-height: 1.5;">
                                        A "Credit Card" Pocket is automatically created to reserve funds from your Safe-to-Spend for credit card payments.
                                    </p>
                                </div>

                                <div style="background: #f8f9fa; border-radius: 12px; padding: 24px;">
                                    <div style="font-size: 32px; margin-bottom: 12px;">✅</div>
                                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--text-dark);">Stay in Sync</h3>
                                    <p style="font-size: 14px; color: var(--text-light); line-height: 1.5;">
                                        Every purchase automatically moves money to your Credit Card Pocket, keeping you aligned with your actual balance.
                                    </p>
                                </div>
                            </div>

                            <div style="border-top: 1px solid #e0e0e0; padding-top: 30px; margin-top: 40px; text-align: center;">
                                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--text-dark);">Benefits</h3>
                                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; font-size: 14px; color: var(--text-light);">
                                    <span>✓ Build credit history</span>
                                    <span>✓ Earn points & rewards</span>
                                    <span>✓ Never overspend</span>
                                    <span>✓ Automatic balance tracking</span>
                                </div>
                            </div>

                            <div style="background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; padding: 20px; margin-top: 40px;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: #856404;">💡 Note</div>
                                <p style="color: #856404; line-height: 1.6; margin: 0; font-size: 14px;">
                                    Once you have a valid API key configured (optional), this screen will change to show your connected accounts and allow you to select which account to track.
                                </p>
                            </div>
                        </div>

                        <!-- Management Interface (shown when fully configured) -->
                        <div id="credit-management-screen" style="display: none;">
                            <!-- Invalid Token Warning (for SimpleFin) -->
                            <div id="credit-management-invalid-warning" style="display: none; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <div style="display: flex; align-items: flex-start; gap: 12px;">
                                    <div style="font-size: 24px;">⚠️</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 8px; color: #e65100;">SimpleFin Token Invalid or Revoked</div>
                                        <p style="color: #e65100; line-height: 1.6; margin-bottom: 12px; font-size: 14px;">
                                            Your SimpleFin access token has been revoked or is no longer valid. Transactions will not sync until you reconnect.
                                        </p>
                                        <button onclick="disconnectSimpleFin()" style="background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s; margin-right: 10px;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                            Disconnect SimpleFin
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Multi-Account Cards Container -->
                            <div id="credit-accounts-list" style="display: grid; gap: 20px; margin-bottom: 20px;">
                                <!-- Account cards will be dynamically inserted here -->
                            </div>

                            <!-- Add Another Account Button -->
                            <button onclick="addAnotherSimpleFinAccount()" style="background: white; border: 2px dashed #ccc; border-radius: 12px; padding: 20px; cursor: pointer; width: 100%; text-align: center; color: var(--simple-blue); font-weight: 600; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--simple-blue)'; this.style.background='#f8f9fa'" onmouseout="this.style.borderColor='#ccc'; this.style.background='white'">
                                + Add Another SimpleFin Card
                            </button>

                            <!-- Sync Schedule Info -->
                            <div style="background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 8px; padding: 20px; margin-top: 30px;">
                                <div style="display: flex; align-items: flex-start; gap: 12px;">
                                    <div style="font-size: 24px;">ℹ️</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 8px; color: #1565c0;">Sync Schedule</div>
                                        <p style="color: #1565c0; line-height: 1.6; margin: 0; font-size: 14px;">
                                            SimpleFin accounts sync automatically every hour in the background. Each account syncs independently, so you can track multiple cards without delays.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="sidebar-column">
            <div class="sidebar-card">
                <div class="card-title"><span>Trends</span><span style="color:#999; font-weight:400; font-size:12px;">Monthly ▼</span></div>
                <div class="trend-row" style="font-weight: 700; color:#AAA; font-size:10px; text-transform:uppercase; letter-spacing:0.5px;"><span>Overview</span><span>This month</span></div>
                <div class="trend-row"><span>Checking</span><span id="checking-val" style="color:var(--text-dark); font-weight:600;">--</span></div>
                <div class="trend-row"><span>Earned</span><span id="trend-earned" style="color:var(--text-light);">$0.00</span></div>
                <div class="trend-row"><span>Spent</span><span id="trend-spent" style="color:var(--text-light);">$0.00</span></div>
            </div>
             <div class="sidebar-card">
                <div class="card-title"><span>Active Pockets</span></div>
                <div id="sidebar-pockets-list">
                    <div style="text-align:center; color:#999; padding:10px;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fmt = (num) => "$" + num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const cardColors = { 'DENIM': '#4a69bd', 'TEAL': '#0abde3', 'BEIGE': '#d1ccc0', 'BLACK': '#2f3640' };

        // Globals
        let goalsDataStore = [];
        let allGroups = [];
        let currentBalances = { checking: 0, savings: 0 };
        let expensesDataStore = [];
        let moveMoneyAccounts = [];
        let currentFundingSource = "Checking";
        let showCreditCardPockets = localStorage.getItem('showCreditCardPockets') === 'true';

        // --- PWA REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('SW Registered: ', registration.scope);
                })
                .catch(err => {
                    console.log('SW Registration Failed: ', err);
                });
            });
        }

        // --- TAB SWITCHING ---
        function switchTab(tab) {
            // Clear Active Desktop
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            // Clear Active Mobile
            document.querySelectorAll('.mobile-nav-link').forEach(el => el.classList.remove('active'));
            // Clear View
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));

            // Set Desktop Active
            const desktopNav = document.getElementById(`nav-${tab}`);
            if(desktopNav) desktopNav.classList.add('active');
            
            // Set Mobile Active
            const mobileNav = document.getElementById(`mb-nav-${tab}`);
            if(mobileNav) mobileNav.classList.add('active');

            const searchContainer = document.getElementById('search-container');
            const filterBar = document.getElementById('filter-bar');
            const controlsBar = document.getElementById('controls-bar');

            document.getElementById(`view-${tab}`).classList.add('active');

            // Handle UI Visibility based on Tab
            if(tab === 'activity') {
                searchContainer.style.opacity = '1'; searchContainer.style.visibility = 'visible'; filterBar.style.display = 'flex';
                controlsBar.style.display = 'flex';
                // Load transactions and start auto-refresh when activity tab is active
                reloadTx();
                startTransactionAutoRefresh();
            } else if (tab === 'goals') {
                stopTransactionAutoRefresh();
                searchContainer.style.opacity = '0'; searchContainer.style.visibility = 'hidden'; filterBar.style.display = 'none';
                controlsBar.style.display = 'none'; // FIX: Hide Controls bar on mobile Pockets to avoid whitespace
            } else {
                // Expenses, Family, Cards - Hide controls bar completely
                searchContainer.style.opacity = '0'; searchContainer.style.visibility = 'hidden'; filterBar.style.display = 'none';
                controlsBar.style.display = 'none';
                stopTransactionAutoRefresh();
            }
            // This forces a refresh of the top header numbers every time you change tabs
            initBalances(true);
            // =============================
            // === UPDATED LOGIC: Force refresh on Expenses and Goals ===
            // This ensures data is fresh when navigating
            if(tab === 'expenses') loadExpenses(true);
            if(tab === 'goals') loadGoals(true);
            
            if(tab === 'family') loadFamily();
            if(tab === 'cards') loadCards(true);
            if(tab === 'credit') {
                loadCreditSetup();
            } else {
                // Clean up credit card intervals when leaving credit page
                cleanupCreditCardIntervals();
            }
        }

        // --- CARDS LOGIC ---
        function loadCards(forceRefresh = false) {
            // If forceRefresh is true, append the query param to bypass cache
            const url = forceRefresh ? '/api/cards?refresh=true' : '/api/cards';
            
            fetch(url).then(res => res.json()).then(data => {
                const container = document.getElementById('cards-content');
                if(data.error) { 
                    container.innerHTML = `<div style="text-align:center; padding:20px; color:red;">${data.error}</div>`; 
                    return; 
                }

                let html = '';
                if(data.cards.length === 0) {
                    html = '<div style="text-align:center; padding:40px; color:#999;">No physical cards found.</div>';
                } else {
                    data.cards.forEach(card => {
                        const bg = cardColors[card.color] || '#333';
                        
                        // let optionsHtml = `<option value="Checking" ${card.current_spend_id === 'Checking' ? 'selected' : ''}>Checking</option>`;
                        let optionsHtml = `<option value="Checking" ${card.current_spend_id === 'Checking' ? 'selected' : ''}>Safe-to-Spend</option>`;
                        if (typeof goalsDataStore !== 'undefined') {
                            goalsDataStore.forEach(goal => {
                                const isSelected = card.current_spend_id === goal.id ? 'selected' : '';
                                optionsHtml += `<option value="${goal.id}" ${isSelected}>${goal.name}</option>`;
                            });
                        }


                        html += `
                        <div class="card-row">
                            <div class="card-icon" style="background-color: ${bg};"></div>
                            <div class="card-info">
                                <div class="card-name">${card.holder}</div>
                                <div class="card-meta">Simple Visa® Card • ..${card.last4}</div>
                            </div>
                            <div class="card-controls">
                                <span class="spend-label">Spend From:</span>
                                
                                <select class="modern-select" 
                                        onclick="event.stopPropagation()" 
                                        onchange="updateSpendPocket(this, '${card.userId}')"> ${optionsHtml}
                                </select>
                                
                                <span class="type-badge">Physical</span>
                            </div>
                        </div>`;
                    });
                }
                container.innerHTML = html;
            });
        }

        // --- CREDIT CARD SETUP LOGIC ---
        let selectedProvider = null;
        let simpleFinAccessUrl = null;

        function showProviderSelection() {
            document.getElementById('provider-selection').style.display = 'block';
            document.getElementById('lunchflow-setup').style.display = 'none';
            document.getElementById('simplefin-setup').style.display = 'none';
        }

        function selectProvider(provider) {
            selectedProvider = provider;
            document.getElementById('provider-selection').style.display = 'none';

            if (provider === 'lunchflow') {
                document.getElementById('lunchflow-setup').style.display = 'block';
                document.getElementById('simplefin-setup').style.display = 'none';
                // Check if API key is configured
                fetch('/api/lunchflow/credit-card-status')
                    .then(res => res.json())
                    .then(status => {
                        if (status.hasApiKey) {
                            document.getElementById('api-key-setup').style.display = 'none';
                            document.getElementById('account-selection').style.display = 'block';
                            loadLunchFlowAccounts();
                        } else {
                            document.getElementById('api-key-setup').style.display = 'block';
                            document.getElementById('account-selection').style.display = 'none';
                        }
                    });
            } else if (provider === 'simplefin') {
                document.getElementById('lunchflow-setup').style.display = 'none';
                document.getElementById('simplefin-setup').style.display = 'block';

                // Check status for token validity
                fetch('/api/lunchflow/credit-card-status')
                    .then(res => res.json())
                    .then(status => {
                        // Show invalid token warning if needed
                        if (status.simplefinTokenInvalid) {
                            document.getElementById('simplefin-invalid-warning').style.display = 'block';
                            document.getElementById('simplefin-token-input').style.display = 'none';
                            document.getElementById('simplefin-account-selection').style.display = 'none';
                        } else {
                            document.getElementById('simplefin-invalid-warning').style.display = 'none';

                            // Check if we already have a SimpleFin access URL stored
                            console.log('Checking for stored SimpleFin access URL...');
                            if (status.hasSimplefinAccessUrl) {
                                // We already have an access URL - fetch it and load accounts
                                fetch('/api/simplefin/get-access-url')
                                    .then(res => res.json())
                                    .then(data => {
                                        console.log('SimpleFin access URL check result:', data);
                                        if (data.success && data.accessUrl) {
                                            console.log('✅ Found stored SimpleFin access URL, loading accounts...');
                                            simpleFinAccessUrl = data.accessUrl;
                                            document.getElementById('simplefin-token-input').style.display = 'none';
                                            document.getElementById('simplefin-account-selection').style.display = 'block';
                                            loadSimpleFinAccounts();
                                        }
                                    });
                            } else {
                                // No access URL - show token input
                                console.log('⚠️ No SimpleFin access URL found, showing token input');
                                document.getElementById('simplefin-token-input').style.display = 'block';
                                document.getElementById('simplefin-account-selection').style.display = 'none';
                            }
                        }
                    })
                    .catch(err => {
                        console.error('❌ Error checking SimpleFin status:', err);
                        // On error, show token input
                        document.getElementById('simplefin-token-input').style.display = 'block';
                        document.getElementById('simplefin-account-selection').style.display = 'none';
                    });
            }
        }

        function loadCreditSetup() {
            // Check status first
            fetch('/api/lunchflow/credit-card-status')
                .then(res => res.json())
                .then(status => {
                    const providerSelection = document.getElementById('provider-selection');
                    const lunchflowSetup = document.getElementById('lunchflow-setup');
                    const simplefinSetup = document.getElementById('simplefin-setup');
                    const setupScreen = document.getElementById('credit-setup-screen');
                    const managementScreen = document.getElementById('credit-management-screen');
                    const simplefinAccountSelection = document.getElementById('simplefin-account-selection');

                    // Check if we have SimpleFin accounts (multi-account mode)
                    const hasSimpleFinAccounts = status.accounts && status.accounts.length > 0;

                    if (hasSimpleFinAccounts) {
                        // Show multi-account management screen
                        setupScreen.style.display = 'none';
                        managementScreen.style.display = 'block';
                        if (simplefinAccountSelection) {
                            simplefinAccountSelection.style.display = 'none';
                        }
                        loadCreditAccounts(status);
                    } else if (status.configured && status.pocketCreated) {
                        // Fully configured (legacy single account) - show management interface
                        setupScreen.style.display = 'none';
                        managementScreen.style.display = 'block';
                        if (simplefinAccountSelection) {
                            simplefinAccountSelection.style.display = 'none';
                        }
                        loadCreditManagement(status);
                    } else if (status.configured && !status.pocketCreated) {
                        // Account selected but pocket not created - show balance sync modal
                        setupScreen.style.display = 'block';
                        managementScreen.style.display = 'none';
                        providerSelection.style.display = 'none';
                        lunchflowSetup.style.display = 'none';
                        simplefinSetup.style.display = 'none';

                        // Restore pending account info and show balance sync modal
                        pendingAccountId = status.accountId;
                        pendingAccountName = status.accountName;
                        selectedProvider = status.provider || 'lunchflow';

                        // Fetch balance based on provider
                        if (status.provider === 'simplefin') {
                            // For SimpleFin, get access URL and fetch balance
                            if (status.hasSimplefinAccessUrl) {
                                fetch('/api/simplefin/get-access-url')
                                    .then(res => res.json())
                                    .then(data => {
                                        if (data.success && data.accessUrl) {
                                            simpleFinAccessUrl = data.accessUrl;
                                            // Fetch balance
                                            return fetch('/api/simplefin/get-balance', {
                                                method: 'POST',
                                                headers: {'Content-Type': 'application/json'},
                                                body: JSON.stringify({
                                                    accountId: status.accountId,
                                                    accessUrl: simpleFinAccessUrl
                                                })
                                            });
                                        } else {
                                            throw new Error('No access URL found');
                                        }
                                    })
                                    .then(res => res.json())
                                    .then(balanceData => {
                                        if (balanceData.error) {
                                            showBalanceSyncModal(null);
                                        } else {
                                            const balance = Math.abs(balanceData.balance?.amount || 0);
                                            showBalanceSyncModal(balance);
                                        }
                                    })
                                    .catch(err => {
                                        console.error('Error fetching SimpleFin balance:', err);
                                        showBalanceSyncModal(null);
                                    });
                            } else {
                                showBalanceSyncModal(null);
                            }
                        } else {
                            // LunchFlow balance fetch
                            fetch(`/api/lunchflow/get-balance/${status.accountId}`)
                                .then(res => res.json())
                                .then(balanceData => {
                                    if (balanceData.error) {
                                        showBalanceSyncModal(null);
                                    } else {
                                        const balanceAmount = balanceData.balance?.amount || 0;
                                        const balance = Math.abs(balanceAmount);
                                        showBalanceSyncModal(balance);
                                    }
                                })
                                .catch(err => {
                                    console.error('Error fetching balance:', err);
                                    showBalanceSyncModal(null);
                                });
                        }
                    } else {
                        // Not configured - show provider selection
                        setupScreen.style.display = 'block';
                        managementScreen.style.display = 'none';
                        providerSelection.style.display = 'block';
                        lunchflowSetup.style.display = 'none';
                        simplefinSetup.style.display = 'none';
                    }
                })
                .catch(err => {
                    console.error('Error loading credit card status:', err);
                });
        }

        function loadLunchFlowAccounts() {
            const accountsList = document.getElementById('accounts-list');
            accountsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid var(--simple-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>Loading accounts...</div>';

            fetch('/api/lunchflow/accounts')
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        accountsList.innerHTML = `<div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 20px; color: #721c24;">
                            <strong>Error loading accounts:</strong> ${data.error}
                        </div>`;
                        return;
                    }

                    // LunchFlow API returns { accounts: [...], total: number }
                    const accounts = data.accounts || [];

                    if (accounts.length === 0) {
                        accountsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No accounts found. Please connect an account in your LunchFlow dashboard first.</div>';
                        return;
                    }

                    let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
                    accounts.forEach(account => {
                        // Schema: id (number), name, institution_name, provider, status, currency, institution_logo
                        const accountId = account.id;
                        const accountName = account.name || 'Unknown Account';
                        const institutionName = account.institution_name || '';
                        const provider = account.provider || '';
                        const status = account.status || 'ACTIVE';
                        const currency = account.currency || '';
                        const logo = account.institution_logo || null;
                        
                        // Filter to only show ACTIVE accounts, or show all with status badge
                        const statusColor = status === 'ACTIVE' ? '#28a745' : status === 'ERROR' ? '#dc3545' : '#6c757d';
                        
                        html += `
                            <div style="background: white; border: 2px solid ${status === 'ACTIVE' ? '#e0e0e0' : '#f0f0f0'}; border-radius: 8px; padding: 20px; cursor: ${status === 'ACTIVE' ? 'pointer' : 'not-allowed'}; transition: all 0.2s; opacity: ${status === 'ACTIVE' ? '1' : '0.7'};"
                                 ${status === 'ACTIVE' ? `onclick="selectCreditCardAccount(${accountId}, '${accountName.replace(/'/g, "\\'")}')"` : ''}
                                 ${status === 'ACTIVE' ? 'onmouseover="this.style.borderColor=\'var(--simple-blue)\'; this.style.boxShadow=\'0 2px 8px rgba(0,0,0,0.1)\'"' : ''}
                                 ${status === 'ACTIVE' ? 'onmouseout="this.style.borderColor=\'#e0e0e0\'; this.style.boxShadow=\'none\'"' : ''}>
                                <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
                                    ${logo ? `<img src="${logo}" alt="${institutionName}" style="width: 40px; height: 40px; object-fit: contain; border-radius: 4px; background: #f8f9fa; padding: 4px;">` : '<div style="width: 40px; height: 40px; background: #e9ecef; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 20px;">🏦</div>'}
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 4px;">${accountName}</div>
                                        <div style="font-size: 13px; color: var(--text-light); display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                            ${institutionName ? `<span>${institutionName}</span>` : ''}
                                            ${provider ? `<span>• ${provider}</span>` : ''}
                                            ${currency ? `<span>• ${currency}</span>` : ''}
                                            <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${status}</span>
                                        </div>
                                    </div>
                                    ${status === 'ACTIVE' ? '<div style="font-size: 24px; color: var(--simple-blue);">→</div>' : '<div style="font-size: 14px; color: #999;">Not available</div>'}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';

                    accountsList.innerHTML = html;
                })
                .catch(err => {
                    accountsList.innerHTML = `<div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 20px; color: #721c24;">
                        <strong>Error:</strong> ${err.message}
                    </div>`;
                });
        }

        let pendingAccountId = null;
        let pendingAccountName = null;

        function selectCreditCardAccount(accountId, accountName) {
            pendingAccountId = String(accountId);
            pendingAccountName = accountName;
            
            // First, save the account selection
            fetch('/api/lunchflow/set-credit-card', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    accountId: pendingAccountId,
                    accountName: pendingAccountName
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    appAlert('Error saving account: ' + data.error, 'Error');
                    return;
                }
                
                // Fetch balance and show sync confirmation modal
                fetch(`/api/lunchflow/get-balance/${pendingAccountId}`)
                    .then(res => res.json())
                    .then(balanceData => {
                        if (balanceData.error) {
                            // If balance fetch fails, still proceed but without balance display
                            showBalanceSyncModal(null);
                        } else {
                            const balanceAmount = balanceData.balance?.amount || 0;
                            // Balance is already in dollars, not cents
                            const balance = Math.abs(balanceAmount);
                            showBalanceSyncModal(balance);
                        }
                    })
                    .catch(err => {
                        console.error('Error fetching balance:', err);
                        showBalanceSyncModal(null);
                    });
            })
            .catch(err => {
                appAlert('Error: ' + err.message, 'Error');
            });
        }

        function showBalanceSyncModal(balance) {
            const modal = document.getElementById('balance-sync-modal');
            const balanceAmount = document.getElementById('balance-amount');
            
            if (balance !== null) {
                balanceAmount.textContent = fmt(balance);
            } else {
                balanceAmount.textContent = 'Unable to load';
                balanceAmount.style.color = '#999';
            }
            
            modal.style.display = 'flex';
        }

        // SimpleFin Functions
        function claimSimpleFinToken() {
            const token = document.getElementById('simplefin-token-field').value.trim();
            if (!token) {
                appAlert('Please enter a SimpleFin token', 'Error');
                return;
            }

            console.log('Claiming SimpleFin setup token...');
            fetch('/api/simplefin/claim-token', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({token})
            })
            .then(res => res.json())
            .then(data => {
                console.log('SimpleFin claim token result:', data);
                if (data.error) {
                    appAlert('Error claiming token: ' + data.error, 'Error');
                    return;
                }
                console.log('✅ SimpleFin token claimed successfully, access URL stored');
                simpleFinAccessUrl = data.accessUrl;
                // Now fetch accounts
                loadSimpleFinAccounts();
            })
            .catch(err => {
                console.error('❌ Error claiming SimpleFin token:', err);
                appAlert('Error: ' + err.message, 'Error');
            });
        }

        function loadSimpleFinAccounts() {
            console.log('loadSimpleFinAccounts called');
            const tokenInput = document.getElementById('simplefin-token-input');
            const accountSelection = document.getElementById('simplefin-account-selection');
            const accountsList = document.getElementById('simplefin-accounts-list');

            console.log('Elements found:', {
                tokenInput: !!tokenInput,
                accountSelection: !!accountSelection,
                accountsList: !!accountsList
            });

            if (tokenInput) tokenInput.style.display = 'none';
            if (accountSelection) accountSelection.style.display = 'block';

            if (!accountsList) {
                console.error('simplefin-accounts-list element not found!');
                return;
            }

            accountsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid var(--simple-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>Loading accounts...</div>';

            // Ensure we have the access URL
            if (!simpleFinAccessUrl) {
                console.error('simpleFinAccessUrl is not set!');
                accountsList.innerHTML = '<div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 20px; color: #721c24;"><strong>Error:</strong> SimpleFin access URL not found. Please reconnect SimpleFin.</div>';
                return;
            }

            console.log('Fetching accounts with access URL (length):', simpleFinAccessUrl.length);
            fetch('/api/simplefin/accounts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({accessUrl: simpleFinAccessUrl})
            })
            .then(res => {
                console.log('Accounts API response status:', res.status);
                return res.json();
            })
            .then(data => {
                console.log('Accounts API response data:', data);
                if (data.error) {
                    accountsList.innerHTML = `<div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 20px; color: #721c24;">
                        <strong>Error loading accounts:</strong> ${data.error}
                    </div>`;
                    return;
                }

                const accounts = data.accounts || [];
                if (accounts.length === 0) {
                    accountsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No accounts found.</div>';
                    return;
                }

                console.log('Building account list HTML for', accounts.length, 'accounts');
                let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
                accounts.forEach(account => {
                    const accountId = account.id;
                    const accountName = account.name || 'Unknown Account';
                    const org = account.org || '';
                    const currency = account.currency || '';
                    const balance = account.balance || 0;

                    html += `
                        <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;"
                             onclick="selectSimpleFinAccount('${accountId}', '${accountName.replace(/'/g, "\\'")}')"
                             onmouseover="this.style.borderColor='var(--simple-blue)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'"
                             onmouseout="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
                                <div style="width: 40px; height: 40px; background: #e9ecef; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 20px;">🏦</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 4px;">${accountName}</div>
                                    <div style="font-size: 13px; color: var(--text-light); display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                        ${org ? `<span>${org}</span>` : ''}
                                        ${currency ? `<span>• ${currency}</span>` : ''}
                                        ${balance ? `<span>• Balance: ${fmt(Math.abs(balance))}</span>` : ''}
                                    </div>
                                </div>
                                <div style="font-size: 24px; color: var(--simple-blue);">→</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                console.log('Setting innerHTML for accountsList element');
                console.log('accountsList element:', accountsList);
                console.log('HTML length:', html.length);
                accountsList.innerHTML = html;
                console.log('innerHTML set successfully');
            })
            .catch(err => {
                accountsList.innerHTML = `<div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 20px; color: #721c24;">
                    <strong>Error:</strong> ${err.message}
                </div>`;
            });
        }

        function selectSimpleFinAccount(accountId, accountName) {
            // Check if account already tracked
            fetch('/api/lunchflow/credit-card-status')
                .then(res => res.json())
                .then(statusData => {
                    const existingAccount = statusData.accounts?.find(a => a.accountId === accountId);
                    if (existingAccount) {
                        appAlert('This account is already being tracked!', 'Info');
                        return Promise.reject(new Error('Account already tracked'));
                    }

                    pendingAccountId = accountId;
                    pendingAccountName = accountName;

                    // Save the account selection
                    return fetch('/api/simplefin/set-credit-card', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            accountId: pendingAccountId,
                            accountName: pendingAccountName,
                            accessUrl: simpleFinAccessUrl
                        })
                    });
                })
                .then(res => res ? res.json() : null)
                .then(data => {
                    if (!data) return;

                    if (data.error) {
                        appAlert('Error saving account: ' + data.error, 'Error');
                        return;
                    }

                    // Fetch balance and show sync confirmation modal
                    return fetch('/api/simplefin/get-balance', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            accountId: pendingAccountId,
                            accessUrl: simpleFinAccessUrl
                        })
                    });
                })
                .then(res => res ? res.json() : null)
                .then(balanceData => {
                    if (!balanceData) return;

                    if (balanceData.error) {
                        showBalanceSyncModal(null);
                    } else {
                        const balance = Math.abs(balanceData.balance?.amount || 0);
                        showBalanceSyncModal(balance);
                    }
                })
                .catch(err => {
                    if (err.message !== 'Account already tracked') {
                        console.error('Error:', err);
                        appAlert('Error: ' + err.message, 'Error');
                    }
                });
        }

        function disconnectSimpleFin() {
            if (!confirm('Are you sure you want to disconnect SimpleFin? This will remove all SimpleFin accounts and return any pocket funds to your Checking account.')) {
                return;
            }

            fetch('/api/simplefin/disconnect', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    appAlert(data.message || 'SimpleFin disconnected successfully', 'Success');
                    // Refresh the page to show clean state
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    appAlert(data.error || 'Failed to disconnect SimpleFin', 'Error');
                }
            })
            .catch(err => {
                console.error('Error disconnecting SimpleFin:', err);
                appAlert('Error: ' + err.message, 'Error');
            });
        }

        function handleBalanceSync(syncBalance) {
            const modal = document.getElementById('balance-sync-modal');

            if (!pendingAccountId) {
                appAlert('Error: No account selected', 'Error');
                return;
            }

            // Show loading state in modal
            const modalContent = modal.querySelector('div[style*="background: white"]');
            const originalContent = modalContent.innerHTML;
            modalContent.innerHTML = `
                <div style="text-align: center; padding: 60px 40px;">
                    <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid var(--simple-blue); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 24px;"></div>
                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 12px; color: var(--text-dark);">Setting up your account...</h3>
                    <p style="color: var(--text-light); line-height: 1.6;">
                        ${syncBalance ? 'Syncing balance and importing transactions. This may take a moment.' : 'Creating pocket and importing transactions. This may take a moment.'}
                    </p>
                </div>
            `;

            // Determine which API to use based on selected provider
            const endpoint = selectedProvider === 'simplefin'
                ? '/api/simplefin/create-pocket-with-balance'
                : '/api/lunchflow/create-pocket-with-balance';

            // Create pocket with or without balance sync
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    accountId: pendingAccountId,
                    syncBalance: syncBalance
                })
            })
            .then(res => res.json())
            .then(data => {
                modal.style.display = 'none';
                modalContent.innerHTML = originalContent;

                if (data.error) {
                    appAlert('Error creating pocket: ' + data.error, 'Error');
                    return;
                }

                // Show success message with details
                if (syncBalance && data.syncedBalance) {
                    appAlert(`✅ Account added successfully!\n\nThe pocket balance has been synced to match your current credit card balance. Transactions have been imported and will be tracked going forward.`, 'Success');
                } else {
                    appAlert(`✅ Account added successfully!\n\nThe pocket starts at $0. Transactions will be tracked going forward, and new spending will automatically adjust the pocket balance.`, 'Success');
                }

                // Refresh Safe to Spend balance and goals/pockets list after pocket creation
                if (typeof initBalances === 'function') {
                    initBalances(true);
                }
                if (typeof loadGoals === 'function') {
                    loadGoals(true);
                }

                // Reload to show management interface
                loadCreditSetup();

                // Clear pending values
                pendingAccountId = null;
                pendingAccountName = null;
            })
            .catch(err => {
                modal.style.display = 'none';
                modalContent.innerHTML = originalContent;
                appAlert('Error: ' + err.message, 'Error');
            });
        }

        let creditCardRefreshInterval = null;

        function loadCreditManagement(status) {
            // Show/hide invalid token warning for SimpleFin
            if (status.provider === 'simplefin' && status.simplefinTokenInvalid) {
                document.getElementById('credit-management-invalid-warning').style.display = 'block';
            } else {
                document.getElementById('credit-management-invalid-warning').style.display = 'none';
            }

            // Update account info
            document.getElementById('mgmt-account-name').textContent = status.accountName || 'Unknown';
            document.getElementById('mgmt-account-id').textContent = status.accountId || 'N/A';
            
            if (status.createdAt) {
                const date = new Date(status.createdAt);
                document.getElementById('mgmt-connected-date').textContent = date.toLocaleDateString();
            } else {
                document.getElementById('mgmt-connected-date').textContent = 'Unknown';
            }
            
            // Clear any existing intervals
            if (creditCardRefreshInterval) {
                clearInterval(creditCardRefreshInterval);
            }
            
            // Load pocket information immediately
            refreshCreditCardBalance(status);
            
            // Set up periodic refresh every hour (silent background check)
            creditCardRefreshInterval = setInterval(() => {
                refreshCreditCardBalance(status);
            }, 3600000); // 1 hour
        }

        function refreshCreditCardBalance(status) {
            if (status.pocketId) {
                // Fetch goals to get pocket data (force refresh to get latest balance)
                fetch('/api/goals?refresh=true')
                    .then(res => res.json())
                    .then(data => {
                        if (data.goals) {
                            const creditCardPocket = data.goals.find(g => g.id === status.pocketId);
                            if (creditCardPocket) {
                                document.getElementById('credit-pocket-name').textContent = creditCardPocket.name;
                                document.getElementById('credit-pocket-balance').textContent = fmt(creditCardPocket.balance);
                                document.getElementById('credit-pocket-account').textContent = `Tracking: ${status.accountName}`;
                            }
                        }
                    })
                    .catch(err => console.error('Error loading pocket data:', err));
            }
        }

        // Clean up intervals when leaving credit page
        function cleanupCreditCardIntervals() {
            if (creditCardRefreshInterval) {
                clearInterval(creditCardRefreshInterval);
                creditCardRefreshInterval = null;
            }
            stopTransactionAutoRefresh();
        }

        // --- MULTI-ACCOUNT MANAGEMENT FUNCTIONS ---

        function loadCreditAccounts(status) {
            // Show/hide invalid token warning for SimpleFin
            if (status && status.simplefinTokenInvalid) {
                document.getElementById('credit-management-invalid-warning').style.display = 'block';
            } else {
                document.getElementById('credit-management-invalid-warning').style.display = 'none';
            }

            // Fetch latest status to get accounts array
            fetch('/api/lunchflow/credit-card-status')
                .then(res => res.json())
                .then(data => {
                    const accounts = data.accounts || [];
                    renderAccountCards(accounts);
                });
        }

        function renderAccountCards(accounts) {
            const container = document.getElementById('credit-accounts-list');
            if (!container) return;

            container.innerHTML = '';

            if (accounts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No SimpleFin accounts configured yet.</div>';
                return;
            }

            // Fetch pockets data to get balances
            fetch('/api/goals?refresh=true')
                .then(res => res.json())
                .then(data => {
                    accounts.forEach(account => {
                        // Find the pocket for this account
                        const pocket = data.goals ? data.goals.find(g => g.id === account.pocketId) : null;
                        const balance = pocket ? fmt(pocket.balance) : 'N/A';
                        const pocketName = pocket ? pocket.name : 'Credit Card';

                        const cardHtml = `
                            <div class="credit-account-card" data-account-id="${account.accountId}" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 30px; color: white; position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                                <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                                <div style="position: relative; z-index: 1;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; opacity: 0.9;">💳 ${pocketName}</div>
                                            <div style="font-size: 24px; font-weight: 700; margin-top: 8px;">${account.accountName}</div>
                                            <div style="font-size: 12px; opacity: 0.8; font-family: monospace; margin-top: 4px;">${account.accountId}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 14px; opacity: 0.9;">Balance</div>
                                            <div style="font-size: 28px; font-weight: 700;">${balance}</div>
                                        </div>
                                    </div>

                                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                                        <button onclick="syncAccountBalance('${account.accountId}')" style="flex: 1; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                            🔄 Sync
                                        </button>
                                        <button onclick="viewAccountTransactions('${account.accountId}')" style="flex: 1; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                            📋 Transactions
                                        </button>
                                        <button onclick="removeAccount('${account.accountId}')" style="background: rgba(220,53,69,0.3); border: 1px solid rgba(220,53,69,0.5); color: white; padding: 12px 16px; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(220,53,69,0.5)'" onmouseout="this.style.background='rgba(220,53,69,0.3)'">
                                            🗑️
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', cardHtml);
                    });
                })
                .catch(err => console.error('Error loading pocket balances:', err));
        }

        function syncAccountBalance(accountId) {
            appConfirm('⚠️ WARNING: This will sync your credit card pocket balance to match your current credit card balance. This will move money from Safe-to-Spend to the pocket (or vice versa).\n\nDo you want to continue?', 'Sync Balance', { confirmText: 'Continue' }).then(confirmed => {
                if (!confirmed) return;

                // Show loading indicator
                const loadingModal = document.createElement('div');
                loadingModal.style = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                loadingModal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 40px; text-align: center; max-width: 400px;">
                        <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid var(--simple-blue); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 24px;"></div>
                        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 12px; color: var(--text-dark);">Syncing Balance...</h3>
                        <p style="color: var(--text-light);">Fetching current balance from SimpleFin</p>
                    </div>
                `;
                document.body.appendChild(loadingModal);

                fetch('/api/simplefin/sync-balance', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({accountId: accountId})
                })
                .then(res => res.json())
                .then(data => {
                    loadingModal.remove();
                    if (data.error) {
                        appAlert('Error syncing balance: ' + data.error, 'Error');
                    } else {
                        appAlert(`✅ Balance synced successfully!\n\nPrevious: ${fmt(data.previousBalance)}\nNew: ${fmt(data.targetBalance)}`, 'Success');
                        loadCreditSetup();
                        if (typeof loadGoals === 'function') loadGoals(true);
                        if (typeof initBalances === 'function') initBalances(true);
                    }
                })
                .catch(err => {
                    loadingModal.remove();
                    appAlert('Error syncing balance: ' + err.message, 'Error');
                });
            });
        }

        function removeAccount(accountId) {
            const warningMessage = `⚠️ WARNING: Removing this credit card account will:\n\n` +
                                  `1. DELETE the credit card pocket permanently\n` +
                                  `2. Return all money from the pocket back to Safe-to-Spend\n` +
                                  `3. Remove all transaction history for this account\n\n` +
                                  `Are you sure you want to remove this account?`;

            appConfirm(warningMessage, 'Remove Account', { confirmText: 'Remove Account', danger: true }).then(confirmed => {
                if (!confirmed) return;

                // Show loading indicator
                const loadingModal = document.createElement('div');
                loadingModal.style = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                loadingModal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 40px; text-align: center; max-width: 400px;">
                        <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid var(--simple-blue); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 24px;"></div>
                        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 12px; color: var(--text-dark);">Removing Account...</h3>
                        <p style="color: var(--text-light);">Deleting pocket and returning funds</p>
                    </div>
                `;
                document.body.appendChild(loadingModal);

                fetch('/api/simplefin/stop-tracking', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({accountId: accountId})
                })
                .then(res => res.json())
                .then(data => {
                    loadingModal.remove();
                    if (data.error) {
                        appAlert('Error removing account: ' + data.error, 'Error');
                    } else {
                        appAlert('✅ Account removed successfully!\n\nThe pocket has been deleted and funds returned to Safe-to-Spend.', 'Success');
                        loadCreditSetup();
                        if (typeof loadGoals === 'function') loadGoals(true);
                        if (typeof initBalances === 'function') initBalances(true);
                    }
                })
                .catch(err => {
                    loadingModal.remove();
                    appAlert('Error removing account: ' + err.message, 'Error');
                });
            });
        }

        function viewAccountTransactions(accountId) {
            fetch(`/api/lunchflow/transactions?accountId=${accountId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.transactions && data.transactions.length > 0) {
                        showTransactionsModal(data.transactions);
                    } else {
                        appAlert('No transactions found for this account', 'Info');
                    }
                })
                .catch(err => appAlert('Error loading transactions: ' + err.message, 'Error'));
        }

        function addAnotherSimpleFinAccount() {
            // Set provider to simplefin
            selectedProvider = 'simplefin';

            // Return to account selection screen
            document.getElementById('credit-management-screen').style.display = 'none';
            document.getElementById('credit-setup-screen').style.display = 'block';
            document.getElementById('provider-selection').style.display = 'none';
            document.getElementById('simplefin-setup').style.display = 'block';

            // Fetch SimpleFin access URL first, then load accounts
            console.log('Fetching SimpleFin access URL...');
            fetch('/api/simplefin/get-access-url')
                .then(res => res.json())
                .then(data => {
                    console.log('Access URL response:', data);
                    if (data.success && data.accessUrl) {
                        simpleFinAccessUrl = data.accessUrl;
                        console.log('Access URL set, loading accounts...');
                        loadSimpleFinAccounts();
                    } else {
                        console.error('No access URL in response');
                        appAlert('Error: SimpleFin access URL not found. Please reconnect SimpleFin.', 'Error');
                        // Go back to setup
                        document.getElementById('credit-setup-screen').style.display = 'block';
                        document.getElementById('provider-selection').style.display = 'block';
                        document.getElementById('simplefin-setup').style.display = 'none';
                    }
                })
                .catch(err => {
                    console.error('Error fetching access URL:', err);
                    appAlert('Error loading SimpleFin accounts: ' + err.message, 'Error');
                });
        }

        function showTransactionsModal(transactions) {
            // Create a simple modal to display transactions
            const modal = document.createElement('div');
            modal.style = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            const content = document.createElement('div');
            content.style = 'background: white; border-radius: 12px; padding: 30px; max-width: 600px; max-height: 80vh; overflow-y: auto;';

            let html = '<h2 style="margin-bottom: 20px;">Recent Transactions</h2>';
            transactions.forEach(t => {
                html += `
                    <div style="border-bottom: 1px solid #eee; padding: 12px 0;">
                        <div style="display: flex; justify-content: space-between;">
                            <strong>${t.merchant || t.description}</strong>
                            <strong>${fmt(Math.abs(t.amount))}</strong>
                        </div>
                        <div style="font-size: 12px; color: #666;">${t.date}${t.isPending ? ' (Pending)' : ''}</div>
                    </div>
                `;
            });
            html += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="margin-top: 20px; padding: 10px 20px; background: var(--simple-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">Close</button>';

            content.innerHTML = html;
            modal.appendChild(content);
            document.body.appendChild(modal);

            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        }

        // --- END MULTI-ACCOUNT MANAGEMENT FUNCTIONS ---

        function syncCreditBalance() {
            fetch('/api/lunchflow/credit-card-status')
                .then(res => res.json())
                .then(status => {
                    if (!status.accountId) {
                        appAlert('No credit card account configured', 'Error');
                        return;
                    }

                    const provider = status.provider || 'lunchflow';
                    const syncEndpoint = provider === 'simplefin' ? '/api/simplefin/sync-balance' : '/api/lunchflow/sync-balance';

                    appConfirm('⚠️ WARNING: This will sync your credit card pocket balance to match your current credit card balance. This will move money from Safe-to-Spend to the pocket (or vice versa).\n\nDo you want to continue?', 'Sync Balance', { confirmText: 'Continue' }).then(confirmed => {
                        if (!confirmed) return;
                        fetch(syncEndpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ accountId: status.accountId })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.error) {
                                appAlert('Error syncing balance: ' + data.error, 'Error');
                            } else {
                                appAlert(`✅ Balance synced successfully!\n\nPrevious: ${fmt(data.previousBalance)}\nNew: ${fmt(data.targetBalance)}`, 'Success');
                                loadCreditSetup();
                                if (typeof loadGoals === 'function') loadGoals(true);
                                if (typeof initBalances === 'function') initBalances(true);
                            }
                        })
                        .catch(err => appAlert('Error: ' + err.message, 'Error'));
                    });
                });
        }

        function changeCreditAccount() {
            const warningMessage = `⚠️ WARNING: Changing the credit card account will:\n\n` +
                                  `1. DELETE the current credit card pocket\n` +
                                  `2. Return all money from the pocket back to Safe-to-Spend\n` +
                                  `3. Remove all transaction history for this account\n` +
                                  `4. Require you to select a new account and create a new pocket\n\n` +
                                  `Are you sure you want to change accounts?`;

            appConfirm(warningMessage, 'Change Account', { confirmText: 'Change Account', danger: true }).then(confirmed => {
                if (!confirmed) return;

                // Check provider to use correct endpoint
                fetch('/api/lunchflow/credit-card-status')
                    .then(res => res.json())
                    .then(status => {
                        const provider = status.provider || 'lunchflow';
                        const endpoint = provider === 'simplefin' ? '/api/simplefin/change-account' : '/api/lunchflow/change-account';

                        fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({})
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.error) {
                                appAlert('Error changing account: ' + data.error, 'Error');
                            } else {
                                pendingAccountId = null;
                                pendingAccountName = null;
                                selectedProvider = null;
                                simpleFinAccessUrl = null;

                                const balanceSyncModal = document.getElementById('balance-sync-modal');
                                if (balanceSyncModal) {
                                    balanceSyncModal.style.display = 'none';
                                }

                                appAlert('✅ Account changed successfully!\n\nThe pocket has been deleted and funds returned to Safe-to-Spend. Please select a new account.', 'Success');
                                setTimeout(() => {
                                    loadCreditSetup();
                                    if (typeof loadGoals === 'function') loadGoals(true);
                                    if (typeof initBalances === 'function') initBalances(true);
                                }, 100);
                            }
                        })
                        .catch(err => appAlert('Error: ' + err.message, 'Error'));
                    });
            });
        }

        function stopCreditTracking() {
            const warningMessage = `⚠️ WARNING: Stopping credit card tracking will:\n\n` +
                                  `1. DELETE the credit card pocket permanently\n` +
                                  `2. Return all money from the pocket back to Safe-to-Spend\n` +
                                  `3. Remove all credit card transaction history\n` +
                                  `4. Remove all credit card configuration\n\n` +
                                  `You will need to set up credit card tracking again from scratch if you want to use it later.\n\n` +
                                  `Are you absolutely sure you want to stop tracking?`;

            appConfirm(warningMessage, 'Stop Tracking', { confirmText: 'Stop Tracking', danger: true }).then(confirmed => {
                if (!confirmed) return;

                // Check provider to use correct endpoint
                fetch('/api/lunchflow/credit-card-status')
                    .then(res => res.json())
                    .then(status => {
                        const provider = status.provider || 'lunchflow';
                        const endpoint = provider === 'simplefin' ? '/api/simplefin/stop-tracking' : '/api/lunchflow/stop-tracking';

                        fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({})
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.error) {
                                appAlert('Error stopping tracking: ' + data.error, 'Error');
                            } else {
                                appAlert('✅ Credit card tracking stopped.\n\nThe pocket has been deleted and funds returned to Safe-to-Spend.', 'Success');
                                cleanupCreditCardIntervals();
                                selectedProvider = null;
                                simpleFinAccessUrl = null;
                                pendingAccountId = null;
                                pendingAccountName = null;
                                loadCreditSetup();
                                if (typeof loadGoals === 'function') loadGoals(true);
                                if (typeof initBalances === 'function') initBalances(true);
                            }
                        })
                        .catch(err => appAlert('Error: ' + err.message, 'Error'));
                    });
            });
        }

        // --- FILTER & SEARCH ---
        let filterState = { q: '', minDate: '', maxDate: '', minAmt: '', maxAmt: '' };
        let transactionRefreshInterval = null;
        
        document.getElementById('search-input-box').addEventListener('input', (e) => { filterState.q = e.target.value; reloadTx(); });
        function triggerSearch() { filterState.q = document.getElementById('search-input-box').value; reloadTx(); }
        function toggleFilterMenu() { const menu = document.getElementById('filter-menu'); menu.style.display = menu.style.display === 'block' ? 'none' : 'block'; }
        function applyFilters() { filterState.minDate = document.getElementById('filter-min-date').value; filterState.maxDate = document.getElementById('filter-max-date').value; filterState.minAmt = document.getElementById('filter-min-amt').value; filterState.maxAmt = document.getElementById('filter-max-amt').value; updatePills(); reloadTx(); toggleFilterMenu(); }
        function updatePills() { const container = document.getElementById('active-filters'); container.innerHTML = ''; if (!filterState.minDate && !filterState.maxDate && !filterState.minAmt && !filterState.maxAmt) { container.innerHTML = `<div class="pill" onclick="removeFilter('date')">Last 6 months <span class="pill-remove">×</span></div>`; return; } if(filterState.minDate || filterState.maxDate) { container.innerHTML += `<div class="pill" onclick="removeFilter('date')">${filterState.minDate || '...'} to ${filterState.maxDate || '...'} <span class="pill-remove">×</span></div>`; } if(filterState.minAmt || filterState.maxAmt) { container.innerHTML += `<div class="pill" onclick="removeFilter('amt')">$${filterState.minAmt || '0'} - $${filterState.maxAmt || '∞'} <span class="pill-remove">×</span></div>`; } }
        function removeFilter(type) { if(type === 'date') { filterState.minDate = ''; filterState.maxDate = ''; document.getElementById('filter-min-date').value = ''; document.getElementById('filter-max-date').value = ''; } if(type === 'amt') { filterState.minAmt = ''; filterState.maxAmt = ''; document.getElementById('filter-min-amt').value = ''; document.getElementById('filter-max-amt').value = ''; } updatePills(); reloadTx(); }
        
        function startTransactionAutoRefresh() {
            // Clear any existing interval
            if (transactionRefreshInterval) {
                clearInterval(transactionRefreshInterval);
            }
            // Refresh transactions every 30 seconds when activity tab is active
            transactionRefreshInterval = setInterval(() => {
                const activityTab = document.getElementById('view-activity');
                if (activityTab && activityTab.classList.contains('active')) {
                    reloadTx();
                }
            }, 30000); // 30 seconds
        }
        
        function stopTransactionAutoRefresh() {
            if (transactionRefreshInterval) {
                clearInterval(transactionRefreshInterval);
                transactionRefreshInterval = null;
            }
        }
        
        // --- DYNAMIC SEARCH FOR BILL IDENTIFICATION (REPLACED DATALIST) ---
        
        // 1. Debounce utility to prevent spamming the API while typing
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // 2. Search Function
        const performBillSearch = debounce(function(evt) {
            const query = evt.target.value;
            const suggestionBox = document.getElementById('suggestion-box');
            
            // Clear if empty or short
            if(query.length < 2) {
                suggestionBox.style.display = 'none';
                return;
            }

            // Call the existing transactions API with the search term ('q')
            fetch(`/api/transactions?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    suggestionBox.innerHTML = ''; // Clear previous results
                    
                    if(data.transactions && data.transactions.length > 0) {
                        // Filter for unique titles to avoid duplicates in the dropdown
                        const uniqueTitles = [...new Set(data.transactions.map(t => t.title))];
                        
                        uniqueTitles.forEach(title => {
                            const div = document.createElement('div');
                            div.className = 'suggestion-item';
                            div.innerText = title;
                            // Add click handler to populate input and close box
                            div.onclick = function() {
                                document.getElementById('bill-id-search').value = title;
                                suggestionBox.style.display = 'none';
                            };
                            suggestionBox.appendChild(div);
                        });
                        
                        // Show the box
                        suggestionBox.style.display = 'block';
                    } else {
                        suggestionBox.style.display = 'none';
                    }
                })
                .catch(err => {
                    console.error("Search failed", err);
                    suggestionBox.style.display = 'none';
                });
        }, 400); // Wait 400ms after typing stops

        // 3. Attach to the specific "Identification" input field
        const billSearchInput = document.getElementById('bill-id-search');
        if(billSearchInput) {
            billSearchInput.addEventListener('input', performBillSearch);
        }
        
        // 4. Close suggestions when clicking elsewhere
        document.addEventListener('click', function(e) {
            const suggestionBox = document.getElementById('suggestion-box');
            const searchInput = document.getElementById('bill-id-search');
            if (e.target !== suggestionBox && e.target !== searchInput) {
                suggestionBox.style.display = 'none';
            }
        });

        function reloadTx() {
            const loader = document.getElementById('tx-loading'); const content = document.getElementById('tx-content'); loader.style.display = 'block'; content.innerHTML = '';
            const cleanState = {}; for (const key in filterState) { if (filterState[key]) cleanState[key] = filterState[key]; }
            const params = new URLSearchParams(cleanState).toString();
            fetch(`/api/transactions?${params}`).then(res => res.json()).then(data => {
                loader.style.display = 'none';
                if(data.error || !data.transactions || data.transactions.length === 0) { content.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">No transactions found.</div>`; return; }
                const grouped = {};
                
                // Also populate Search suggestions for Bills from initial load if needed, but dynamic is better
                
                data.transactions.forEach(tx => { const dateStr = new Date(tx.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); if(!grouped[dateStr]) grouped[dateStr] = []; grouped[dateStr].push(tx); });
                let html = '';
                for (const [date, txs] of Object.entries(grouped)) {
                    html += `<div class="tx-group-date">${date}</div>`;
                    txs.forEach(tx => { 
                        const amtClass = tx.amount > 0 ? 'tx-pos' : 'tx-neg';
                        const isCreditCard = tx.isCreditCard === true;
                        const creditCardBadge = isCreditCard ? '<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; margin-right: 8px; text-transform: uppercase;">💳 Credit</span>' : '';
                        const pendingBadge = (isCreditCard && tx.isPending) ? '<span style="background: #ffc107; color: #333; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; margin-right: 8px;">Pending</span>' : '';
                        const rowClass = isCreditCard ? 'tx-row credit-card-tx' : 'tx-row';
                        const merchantInfo = isCreditCard && tx.merchant ? `<span class="tx-desc" style="color: #667eea; font-weight: 500;">${tx.merchant}</span>` : '';
                        html += `<div class="${rowClass}" onclick="openTxDetail('${tx.id}')"><div class="tx-left">${creditCardBadge}${pendingBadge}<span class="tx-title">${tx.title || 'Unknown'}</span>${merchantInfo}${tx.description && !isCreditCard ? `<span class="tx-desc">${tx.description}</span>` : ''}</div><div class="tx-amount ${amtClass}">${fmt(tx.amount)}</div></div>`; 
                    });
                }
                content.innerHTML = html;
            }).catch(err => { loader.style.display = 'none'; content.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Offline / Cached Mode</div>'; });
        }

        // --- SHARED DATA ---
        function updateAllMath(billReserved) {
            const available = currentBalances.checking + currentBalances.savings + billReserved;
            document.getElementById('math-total').innerText = fmt(available);
            document.getElementById('math-sched').innerText = fmt(billReserved);
            document.getElementById('math-goals').innerText = fmt(currentBalances.savings);
            document.getElementById('sts-balance').innerText = fmt(currentBalances.checking);
            
            // Mobile Update - Always shows checking/safe-to-spend
            if (document.getElementById('mobile-header-balance')) {
                // Keep the arrow span when updating text
                const arrowHtml = '<span class="header-arrow">▼</span>';
                document.getElementById('mobile-header-balance').innerHTML = fmt(currentBalances.checking) + " " + arrowHtml;
            }
        }

        // --- EXPENSES ---
        function loadExpenses(forceRefresh = false) {
            const url = forceRefresh ? '/api/expenses?refresh=true' : '/api/expenses';
            fetch(url).then(res => res.json()).then(data => {
                if(data.error) return;
                updateAllMath(data.summary.totalReserved || 0);
                expensesDataStore = data.expenses;
                
                // Store the source for later use in Delete Logic
                currentFundingSource = data.summary.fundingSource || "Checking";
                
                const nextDate = new Date(data.summary.nextFundingDate).toLocaleDateString(undefined, {month:'short', day:'numeric', year:'numeric'});
                const summaryText = `Next Funding: ${nextDate} • Estimated ${fmt(data.summary.estimatedFunding)}`;
                
                document.getElementById('exp-summary-text').innerText = summaryText;

                const heroHtml = `
                    <div class="exp-hero-card">
                        <div class="exp-hero-col">
                            <span class="hero-lbl">Setting aside:</span>
                            <span class="hero-val">${fmt(data.summary.estimatedFunding)} on Payday 💰</span>
                        </div>
                        <div class="exp-hero-divider"></div>
                        <div class="exp-hero-col right">
                            <span class="hero-lbl">Next Funding:</span>
                            <span class="hero-status">${nextDate}</span>
                        </div>
                    </div>
                `;
                document.getElementById('exp-hero-container').innerHTML = heroHtml;

                let html = `<div class="add-bill-row" onclick="openBillModal()">
                    <span style="font-size:20px; line-height:1;">+</span> Add Bill
                </div>`;

                data.expenses.forEach((e, index) => {
                    let pct = e.amount > 0 ? Math.min((e.reserved / e.amount) * 100, 100) : 0;
                    const readyDate = e.reservedBy ? new Date(e.reservedBy).toLocaleDateString(undefined, {month:'short', day:'numeric'}) : 'Monthly';
                    const estFunding = e.estimatedFunding > 0 ? `${fmt(e.estimatedFunding)} on Payday 💰` : 'Fully Funded';
                    let statusBadge = e.paused ? `<span class="exp-funding-status">Paused</span>` : (e.reserved >= e.amount ? `<span class="exp-funding-status ready">Ready</span>` : '');
                    html += `<div class="exp-item" onclick="openExpenseDetail(${index})"><div class="exp-header-line"><div class="exp-name">${e.name}</div>${statusBadge}</div><div class="exp-progress-container"><div class="exp-progress-bar" style="width: ${pct}%"></div></div><div class="exp-details"><span>${fmt(e.reserved)} of ${fmt(e.amount)} reserved • Ready by ${readyDate}</span><span style="color:#2C2C2C">${estFunding}</span></div></div>`;
                });
                document.getElementById('expenses-list').innerHTML = html;
            });
        }

        function loadUserProfile() {
            fetch('/api/user')
                .then(res => res.json())
                .then(data => {
                    if (data.error) return;

                    const first = data.firstName || "";
                    const last = data.lastName || "";
                    const imgUrl = data.imageUrl;
                    
                    // Update Name
                    const fullName = `${first} ${last}`;
                    const nameEl = document.getElementById('user-name');
                    if(nameEl) nameEl.innerText = fullName;

                    const avatarEl = document.getElementById('user-avatar');
                    if (!avatarEl) return;

                    if (imgUrl) {
                        // 1. If Image URL exists, inject an IMG tag
                        // We set background to transparent to hide the default orange color
                        avatarEl.style.background = 'transparent';
                        avatarEl.innerHTML = `<img src="${imgUrl}" style="width:100%; height:100%; border-radius:50%; object-fit:cover; display:block;">`;
                    } else {
                        // 2. Fallback to Initials if no image found
                        let initials = "";
                        if (first.length > 0) initials += first[0];
                        if (last.length > 0) initials += last[0];
                        
                        // Reset style to default orange background (defined in CSS)
                        avatarEl.style.background = ''; 
                        avatarEl.innerText = initials.toUpperCase();
                    }
                })
                .catch(err => console.error("Failed to load user profile", err));
        }

        function openIntercom() {
            if (window.Intercom) {
                window.Intercom('show');
            } else {
                console.log("Intercom not ready yet");
            }
        }


        function updateSpendPocket(selectElement, userId) {
            const selectedPocketId = selectElement.value;
            
            // UI Feedback: Disable select temporarily
            selectElement.disabled = true;
            selectElement.style.opacity = "0.6";

            // We send just the IDs to Python; Python handles the complex GraphQL
            const payload = {
                userId: userId,
                pocketId: selectedPocketId
            };

            // UPDATED: Point to the specific Python route, not /api/graphql
            fetch('/api/set-card-spend', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                // Re-enable control
                selectElement.disabled = false;
                selectElement.style.opacity = "1";

                if (data.error) {
                    appAlert("Failed to update: " + data.error, "Error");
                    // Optional: Reload cards to reset the dropdown to the server state
                    loadCards(true); 
                } else {
                    console.log("Spend pocket updated successfully", data);
                    
                    // Visual confirmation (flash green border)
                    selectElement.style.borderColor = "#63BB67";
                    setTimeout(() => selectElement.style.borderColor = "#DDD", 1000);
                }
            })
            .catch(err => {
                console.error("Error updating spend pocket", err);
                selectElement.disabled = false;
                selectElement.style.opacity = "1";
                appAlert("Network error occurred.", "Error");
            });
        }
        
        // --- CREDIT CARD POCKETS VISIBILITY TOGGLE ---
        function toggleCreditCardPocketsVisibility() {
            showCreditCardPockets = !showCreditCardPockets;
            localStorage.setItem('showCreditCardPockets', showCreditCardPockets);
            updateCreditCardToggleButton();
            loadGoals(); // Reload pockets view
            loadSidebarGoals(); // Reload sidebar
        }

        function updateCreditCardToggleButton() {
            const btn = document.getElementById('cc-pockets-toggle-text');
            if (btn) {
                btn.textContent = showCreditCardPockets ? '💳 Hide CC' : '💳 Show CC';
            }
        }

        // --- GOALS (Updated with Grouping and DnD) ---
        function loadGoals(forceRefresh = false) {
            const url = forceRefresh ? '/api/goals?refresh=true' : '/api/goals';
            fetch(url).then(res => res.json()).then(data => {
                goalsDataStore = data.goals;
                allGroups = data.all_groups || [];

                let html = '';

                // Add Pocket Button
                html += `<div class="add-bill-row" onclick="openPocketModal()">
                    <span style="font-size:20px; line-height:1;">+</span> Add Pocket
                </div>`;

                // 1. Group Data
                const groups = {};
                const ungrouped = [];

                // Initialize groups structure from defined groups
                allGroups.forEach(g => {
                    groups[g.id] = { id: g.id, name: g.name, pockets: [], totalBalance: 0, totalTarget: 0 };
                });

                // Filter out credit card pockets unless toggle is on
                const regularGoals = showCreditCardPockets ? data.goals : data.goals.filter(g => !g.isCreditCard);
                
                regularGoals.forEach((g, index) => {
                    // Attach original index for onClick handlers (using original goals array for indexing)
                    const originalIndex = data.goals.findIndex(goal => goal.id === g.id);
                    g.originalIndex = originalIndex >= 0 ? originalIndex : index; 
                    
                    if (g.groupId && groups[g.groupId]) {
                        groups[g.groupId].pockets.push(g);
                        groups[g.groupId].totalBalance += g.balance;
                        groups[g.groupId].totalTarget += g.target;
                    } else {
                        ungrouped.push(g);
                    }
                });

                // 2. Render Groups (Modern Card Style)
                Object.values(groups).forEach(group => {
                    const groupId = 'grp-' + group.id;
                    
                    // Consistent color based on name
                    const colorIndex = (group.name.charCodeAt(0) + group.name.length) % 5;
                    const colors = ['#0093E9', '#80D0C7', '#F5A623', '#7B1FA2', '#43A047'];
                    const bg = colors[colorIndex];
                    
                    const chevron = group.pockets.length > 0 ? '▼' : ' ';
                    
                    // Add Drag Attributes to Group Container
                    html += `
                    <div class="group-container group-drop-zone" 
                         data-group-id="${group.id}"
                         ondragover="allowDrop(event)" 
                         ondrop="drop(event)"
                         ondragleave="dragLeave(event)">
                        
                        <div class="group-header" onclick="toggleGroup('${groupId}', this)">
                            <div class="group-icon-square" style="background:${bg}">${group.name[0].toUpperCase()}</div>
                            <div class="group-info">
                                <div class="group-title-text">${group.name}</div>
                                <div class="group-subtitle">${group.pockets.length} pockets</div>
                            </div>
                            <div class="group-stats">
                                <div class="group-balance">${fmt(group.totalBalance)}</div>
                                <div class="group-target">of ${fmt(group.totalTarget)}</div>
                            </div>
                            <div class="group-chevron">${chevron}</div>
                        </div>
                        <div id="${groupId}" class="group-content">
                    `;

                    // Render Pockets inside Group
                    group.pockets.forEach(g => {
                        html += renderGoalItem(g, g.originalIndex);
                    });

                    html += `</div></div>`; // Close content and container
                });

                // 3. Render Ungrouped Items
                if (ungrouped.length > 0) {
                    html += `<div style="padding:15px 25px; font-size:11px; color:#999; font-weight:700; letter-spacing:1px; text-transform:uppercase; margin-top:20px;">Ungrouped</div>`;
                    ungrouped.forEach(g => {
                        html += renderGoalItem(g, g.originalIndex);
                    });
                }

                document.getElementById('goals-list').innerHTML = html;
                
                // Make the entire goals-list container a drop zone for ungrouping
                const goalsList = document.getElementById('goals-list');
                goalsList.setAttribute('data-group-id', 'null');
                goalsList.addEventListener('dragover', allowDrop);
                goalsList.addEventListener('drop', drop);
                goalsList.addEventListener('dragleave', dragLeave);
            });
        }

        // Helper to render individual item with Draggable attributes
        function renderGoalItem(g, index) {
            let pct = g.target > 0 ? Math.min((g.balance / g.target) * 100, 100) : 0;
            const hasGoal = g.target > 0;

            // Check if this is a credit card pocket
            const isCreditCard = g.isCreditCard === true;
            const amountLabel = isCreditCard ? 'set aside' : 'saved';

            const progressHtml = hasGoal
                ? `<div class="exp-progress-container"><div class="exp-progress-bar" style="width: ${pct}%"></div></div>`
                : '';
            const detailsText = hasGoal
                ? `<span>${fmt(g.balance)} of ${fmt(g.target)} ${amountLabel}</span>`
                : `<span>${fmt(g.balance)} ${amountLabel}</span>`;
            const creditCardIcon = isCreditCard ? '<span style="font-size: 18px; margin-right: 8px; vertical-align: middle;">💳</span>' : '';

            // ADDED: draggable="true", ondragstart, data-pocket-id, touch events
            return `<div class="exp-item draggable-item ${isCreditCard ? 'credit-card-pocket' : ''}" 
                        draggable="true" 
                        ondragstart="drag(event)"
                        ontouchstart="handleTouchStart(event)"
                        ontouchmove="handleTouchMove(event)"
                        ontouchend="handleTouchEnd(event)"
                        data-pocket-id="${g.id}"
                        onclick="openGoalDetailList(${index})">
                        <div class="exp-header-line">
                            <div class="exp-name">${creditCardIcon}${g.name}</div>
                            <span class="exp-funding-status ready">${isCreditCard ? 'Credit Card' : 'Active'}</span>
                        </div>
                        ${progressHtml}
                        <div class="exp-details">${detailsText}</div>
                    </div>`;
        }
        
        // --- DRAG AND DROP HANDLERS ---
        
        let draggedItem = null;
        let touchStartY = 0;
        let touchStartX = 0;

        function drag(ev) {
            draggedItem = ev.target;
            // Set data
            ev.dataTransfer.setData("pocketId", ev.target.getAttribute('data-pocket-id'));
            ev.dataTransfer.effectAllowed = 'move';
            
            // Visual timeout to allow the drag image to be generated before hiding the element
            setTimeout(() => ev.target.classList.add('is-dragging'), 0);
        }

        // Mobile touch handlers
        function handleTouchStart(ev) {
            const touch = ev.touches[0];
            touchStartY = touch.clientY;
            touchStartX = touch.clientX;
            draggedItem = ev.target.closest('.draggable-item');
            if (draggedItem) {
                ev.preventDefault();
                draggedItem.classList.add('is-dragging');
            }
        }

        function handleTouchMove(ev) {
            if (!draggedItem) return;
            ev.preventDefault();
            
            const touch = ev.touches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const zone = elementBelow?.closest('.group-drop-zone') || elementBelow?.closest('#goals-list');
            
            // Clear all active states
            document.querySelectorAll('.drag-active').forEach(el => el.classList.remove('drag-active'));
            
            if (zone) {
                zone.classList.add('drag-active');
                
                let listContainer;
                if (zone.id === 'goals-list') {
                    listContainer = zone;
                } else if (zone.classList.contains('group-container')) {
                    listContainer = zone.querySelector('.group-content');
                    if (listContainer?.classList.contains('collapsed')) {
                        listContainer.classList.remove('collapsed');
                        zone.querySelector('.group-header')?.classList.remove('collapsed');
                    }
                }
                
                if (listContainer) {
                    const afterElement = getDragAfterElement(listContainer, touch.clientY);
                    if (afterElement == null) {
                        listContainer.appendChild(draggedItem);
                    } else {
                        listContainer.insertBefore(draggedItem, afterElement);
                    }
                }
            }
        }

        function handleTouchEnd(ev) {
            if (!draggedItem) return;
            ev.preventDefault();
            
            const touch = ev.changedTouches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const zone = elementBelow?.closest('.group-drop-zone') || elementBelow?.closest('#goals-list');
            
            document.querySelectorAll('.drag-active').forEach(el => el.classList.remove('drag-active'));
            draggedItem.classList.remove('is-dragging');
            
            if (zone) {
                let groupId;
                let listContainer;
                
                if (zone.id === 'goals-list') {
                    groupId = null;
                    listContainer = zone;
                } else {
                    const rawGroupId = zone.getAttribute('data-group-id');
                    groupId = rawGroupId === "null" ? null : rawGroupId;
                    listContainer = zone.classList.contains('group-container') ? zone.querySelector('.group-content') : zone;
                }
                
                if (listContainer) {
                    const childPocketIds = [...listContainer.querySelectorAll('.draggable-item')]
                                            .map(el => el.getAttribute('data-pocket-id'));
                    savePocketOrder(groupId, childPocketIds);
                }
            }
            
            draggedItem = null;
        }

        function allowDrop(ev) {
            ev.preventDefault();
            const zone = ev.target.closest('.group-drop-zone') || ev.target.closest('#goals-list');
            if (!zone) return;

            // Clear all active states first
            document.querySelectorAll('.drag-active').forEach(el => el.classList.remove('drag-active'));
            zone.classList.add('drag-active');

            let listContainer;
            if (zone.id === 'goals-list') {
                // Dropped outside any group - ungroup the item
                listContainer = zone;
            } else if (zone.classList.contains('group-container')) {
                // Inside a group card, the items are in .group-content
                listContainer = zone.querySelector('.group-content');
                // If the group is collapsed, we force expand it to allow drop
                if (listContainer?.classList.contains('collapsed')) {
                    listContainer.classList.remove('collapsed');
                    zone.querySelector('.group-header')?.classList.remove('collapsed');
                }
            }

            if (listContainer && draggedItem) {
                const afterElement = getDragAfterElement(listContainer, ev.clientY);
                if (afterElement == null) {
                    listContainer.appendChild(draggedItem);
                } else {
                    listContainer.insertBefore(draggedItem, afterElement);
                }
            }
        }

        // Helper to calculate insertion point based on mouse Y position
        function getDragAfterElement(container, y) {
            // Get all draggable items in this container EXCEPT the one currently dragging
            const draggableElements = [...container.querySelectorAll('.draggable-item:not(.is-dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                // offset: distance from the center of the child to the mouse cursor
                const offset = y - box.top - box.height / 2;
                
                // We want the element where the mouse is strictly ABOVE the center (negative offset)
                // and closest to 0
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function dragLeave(ev) {
            // We strictly remove the 'active' style from the wrapper
            const zone = ev.target.closest('.group-drop-zone');
            if(zone) {
                // Check if we are actually leaving the zone, not just entering a child
                const rect = zone.getBoundingClientRect();
                if (ev.clientX < rect.left || ev.clientX >= rect.right || 
                    ev.clientY < rect.top || ev.clientY >= rect.bottom) {
                    zone.classList.remove('drag-active');
                }
            }
        }

        function drop(ev) {
            ev.preventDefault();
            const zone = ev.target.closest('.group-drop-zone') || ev.target.closest('#goals-list');
            if (!zone) return;
            
            // Clear all active states
            document.querySelectorAll('.drag-active').forEach(el => el.classList.remove('drag-active'));
            
            if(draggedItem) {
                draggedItem.classList.remove('is-dragging');
                draggedItem = null;
            }

            // 1. Identify the new Group ID
            let groupId;
            let listContainer;
            
            if (zone.id === 'goals-list') {
                // Dropped outside any group - ungroup the item
                groupId = null;
                listContainer = zone;
            } else {
                const rawGroupId = zone.getAttribute('data-group-id');
                groupId = rawGroupId === "null" ? null : rawGroupId;
                listContainer = zone.classList.contains('group-container') ? zone.querySelector('.group-content') : zone;
            }

            if (listContainer) {
                const childPocketIds = [...listContainer.querySelectorAll('.draggable-item')]
                                        .map(el => el.getAttribute('data-pocket-id'));
                savePocketOrder(groupId, childPocketIds);
            }
        }

        function savePocketOrder(groupId, orderedIds) {
            // Optimistic UI is already done (DOM is moved). Now persist.
            fetch('/api/groups/move-pocket', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    targetGroupId: groupId, 
                    orderedPocketIds: orderedIds 
                })
            })
            .then(res => res.json())
            .then(data => {
                if(!data.success) {
                    console.error("Failed to save order", data.error);
                    appAlert("Could not save new order. Reloading...", "Error");
                    loadGoals(true); // Revert on failure
                } else {
                    // Success - refresh to update group numbers
                    loadGoals(true);
                }
            })
            .catch(err => {
                console.error("Network error", err);
            });
        }

        
        // Use dragend to cleanup styles if drop didn't happen
        document.addEventListener("dragend", function(event) {
             document.querySelectorAll('.is-dragging').forEach(el => el.classList.remove('is-dragging'));
             document.querySelectorAll('.drag-active').forEach(el => el.classList.remove('drag-active'));
        });


        // Helper to toggle accordion
        function toggleGroup(id, headerEl) {
            const content = document.getElementById(id);
            if(content.innerHTML.trim() === "") return; // Don't toggle empty groups
            content.classList.toggle('collapsed');
            headerEl.classList.toggle('collapsed');
        }

        // --- GROUP MANAGEMENT LOGIC ---

        function openGroupMgmt() {
            document.getElementById('group-mgmt-modal').style.display = 'flex';
            renderMgmtList();
        }

        function closeGroupMgmt() {
            document.getElementById('group-mgmt-modal').style.display = 'none';
        }

        // View 1: List of Groups
        function renderMgmtList() {
            const body = document.getElementById('mgmt-body');
            document.getElementById('mgmt-title').innerText = "Manage Groups";
            
            let html = '<div style="margin-bottom:20px;">';
            
            if (allGroups.length === 0) {
                html += '<div style="color:#999; font-style:italic; padding:10px 0;">No groups created yet.</div>';
            } else {
                allGroups.forEach(g => {
                    html += `
                    <div class="mgmt-list-item">
                        <div class="mgmt-name">${g.name}</div>
                        <div class="mgmt-actions">
                            <span class="action-icon" onclick="renderMgmtEdit(${g.id}, '${g.name.replace(/'/g, "\\'")}')">✎ Edit</span>
                            <span class="action-icon delete" onclick="deleteGroup(${g.id})">🗑 Delete</span>
                        </div>
                    </div>`;
                });
            }
            html += '</div>';
            
            html += `<button class="btn-primary" onclick="renderMgmtEdit(null, '')">+ Create New Group</button>`;
            
            body.innerHTML = html;
        }

        // View 2: Edit/Create Group
        function renderMgmtEdit(id, name) {
            const body = document.getElementById('mgmt-body');
            const title = id ? "Edit Group" : "Create New Group";
            document.getElementById('mgmt-title').innerText = title;
            
            let html = `
                <label class="form-label">Group Name</label>
                <input type="text" id="mgmt-name-input" class="form-input" value="${name}" placeholder="e.g. Vacation Funds">
                
                <label class="form-label">Assign Pockets</label>
                <div class="pocket-select-list">
            `;
            
            // Render Pockets Checkboxes
            goalsDataStore.forEach(p => {
                const isChecked = (id && p.groupId === id) ? 'checked' : '';
                // Logic for label: if in another group, show which one
                let subLabel = '';
                if (p.groupId && p.groupId !== id) {
                    const otherGroupName = p.groupName || 'Another Group';
                    subLabel = `<span class="ps-current-group">In: ${otherGroupName}</span>`;
                }
                
                html += `
                <label class="pocket-select-row">
                    <input type="checkbox" class="ps-checkbox" value="${p.id}" ${isChecked}>
                    <span class="ps-name">${p.name}</span>
                    ${subLabel}
                </label>`;
            });
            
            html += `</div>
                <div style="margin-top:20px;">
                    <button class="btn-primary" onclick="saveGroup(${id})">Save Group</button>
                    <button class="btn-secondary" onclick="renderMgmtList()">Back</button>
                </div>
            `;
            
            body.innerHTML = html;
        }

        function saveGroup(id) {
            const name = document.getElementById('mgmt-name-input').value;
            if(!name) { appAlert("Please enter a group name", "Validation Error"); return; }
            
            // Get selected pockets
            const checkboxes = document.querySelectorAll('.ps-checkbox:checked');
            const pocketIds = Array.from(checkboxes).map(cb => cb.value);
            
            const btn = document.querySelector('.btn-primary');
            btn.innerText = "Saving...";
            btn.disabled = true;
            
            fetch('/api/groups/manage', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: id, name: name, pockets: pocketIds })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    // Refresh data and return to list
                    loadGoals(true); // Background refresh main list
                    // We need to fetch groups again locally to update 'allGroups' for the UI
                    fetch('/api/goals').then(r=>r.json()).then(d => {
                         goalsDataStore = d.goals;
                         allGroups = d.all_groups;
                         renderMgmtList();
                    });
                } else {
                    appAlert("Error: " + data.error, "Error");
                    btn.disabled = false;
                    btn.innerText = "Save Group";
                }
            });
        }

        function deleteGroup(id) {
            appConfirm("Delete this group? Pockets inside will become ungrouped.", "Delete Group", { confirmText: "Delete", danger: true }).then(confirmed => {
                if (!confirmed) return;
            
                fetch('/api/groups/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: id })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        loadGoals(true);
                        // Manually remove from local array to speed up UI
                        allGroups = allGroups.filter(g => g.id !== id);
                        renderMgmtList();
                    } else {
                        appAlert("Error: " + data.error, "Error");
                    }
                });
            });
        }

        // --- SIDEBAR POCKETS ---
        function loadSidebarPockets(forceRefresh = false) {
            const url = forceRefresh ? '/api/goals?refresh=true' : '/api/goals';
            fetch(url).then(res => res.json()).then(data => {
                const container = document.getElementById('sidebar-pockets-list');
                if(data.error || !data.goals || data.goals.length === 0) {
                    container.innerHTML = '<div style="color:#999; font-size:13px; text-align:center;">No active pockets</div>';
                    return;
                }

                let html = '';
                // Filter out credit card pockets from sidebar unless toggle is on
                const regularGoals = showCreditCardPockets ? data.goals : data.goals.filter(g => !g.isCreditCard);

                regularGoals.forEach((g, index) => {
                    let pct = g.target > 0 ? Math.min((g.balance / g.target) * 100, 100) : 0;
                    const hasGoal = g.target > 0;

                    // Sidebar specific logic for no-goal pockets
                    const isCreditCard = g.isCreditCard === true;
                    const amountLabel = isCreditCard ? 'Set Aside' : 'Saved';

                    const detailsText = hasGoal
                        ? `<span>${fmt(g.balance)}</span><span>of ${fmt(g.target)}</span>`
                        : `<span>${fmt(g.balance)}</span><span>${amountLabel}</span>`;
                    
                    const barHtml = hasGoal
                        ? `<div class="goal-bar-bg"><div class="goal-bar-fill" style="width:${pct}%"></div></div>`
                        : '';

                    html += `
                    <div class="goal-card-clickable" onclick="openSidebarGoalDetail(${index})" style="margin-bottom: 15px; cursor:pointer;">
                        <div style="margin-bottom: 5px; font-weight:600; font-size:14px;">${g.name}</div>
                        <div style="font-size:12px; color:#767676; display:flex; justify-content:space-between; margin-bottom:5px;">
                            ${detailsText}
                        </div>
                        ${barHtml}
                    </div>
                    `;
                });
                container.innerHTML = html;
                // Update shared store
                goalsDataStore = data.goals;
            });
        }

        // --- FAMILY ---
        function loadFamily() {
            fetch('/api/family').then(res => res.json()).then(data => {
                if(data.error) return;
                familyDataStore = [...data.children, ...data.parents];
                const container = document.getElementById('family-content');
                let html = '';
                if(data.children.length > 0) {
                    html += `<div class="family-section-title">Children</div><div class="family-grid">`;
                    data.children.forEach((child, index) => {
                        const stripColor = cardColors[child.color] || '#CCC';
                        html += `<div class="family-card" onclick="openFamilyDetail('child', ${index})"><div class="color-strip" style="background:${stripColor}"></div><img src="${child.image}" class="profile-img"><div class="family-name">${child.name}</div><div class="family-role">Child</div><div class="family-balance">${fmt(child.balance)}</div></div>`;
                    });
                    html += `</div>`;
                }
                if(data.parents.length > 0) {
                    html += `<div class="family-section-title">Parents</div><div class="family-grid">`;
                    data.parents.forEach((parent, index) => {
                        const stripColor = cardColors[parent.color] || '#CCC';
                        html += `<div class="family-card" style="cursor:default"><div class="color-strip" style="background:${stripColor}"></div><img src="${parent.image}" class="profile-img"><div class="family-name">${parent.name}</div><div class="family-role">Parent</div></div>`;
                    });
                    html += `</div>`;
                }
                container.innerHTML = html;
            });
        }

        function loadTrends() { fetch('/api/trends').then(res => res.json()).then(data => { if(data.error) return; document.getElementById('trend-earned').innerText = fmt(data.earned); document.getElementById('trend-spent').innerText = fmt(data.spent); }); }

        function openExpenseDetail(index) { 
            const e = expensesDataStore[index]; 
            const modal = document.getElementById('tx-modal'); 
            modal.style.display = 'flex'; 
            document.getElementById('modal-title-text').innerText = "Expense Details"; 
            const pct = e.amount > 0 ? ((e.reserved / e.amount) * 100).toFixed(0) : 0; 
            
            const safeName = e.name.replace(/'/g, "\\'");

            document.getElementById('modal-body-content').innerHTML = `
                <div style="text-align:center;">
                    <div style="font-size:18px; font-weight:600; margin-bottom:10px;">${e.name}</div>
                    <div class="detail-amount">${fmt(e.reserved)}</div>
                    <div style="color:#999; margin-bottom:20px;">Reserved of ${fmt(e.amount)}</div>
                    <div style="text-align:left;">
                        <div class="detail-row"><span>Status</span><span>${e.paused?'Paused':'Active'}</span></div>
                        <div class="detail-row"><span>Progress</span><span>${pct}%</span></div>
                        <div class="detail-row"><span>Next Funding</span><span>${fmt(e.estimatedFunding)}</span></div>
                    </div>
                    
                    <button class="btn-goal-delete" onclick="deleteBill('${e.id}', '${safeName}', ${e.reserved})">Delete Expense</button>
                </div>`; 
        }

        function deleteBill(id, name, reservedAmount) {
            let msg = `Are you sure you want to delete "${name}"?`;
            
            // Logic: Checking -> Safe-to-Spend, anything else -> displayName
            const destinationName = (currentFundingSource === "Checking") ? "Safe-to-Spend" : currentFundingSource;

            if (reservedAmount > 0) {
                msg += `\n\n${fmt(reservedAmount)} currently reserved will be returned to ${destinationName}.`;
            } else {
                msg += `\n\nThis will remove the bill and stop future funding.`;
            }

            appConfirm(msg, "Delete Expense", { confirmText: "Delete", danger: true }).then(confirmed => {
                if (!confirmed) return;

                const btn = document.querySelector('.btn-goal-delete');
                if(btn) {
                    btn.innerText = "Deleting...";
                    btn.disabled = true;
                    btn.style.opacity = "0.7";
                }

                fetch('/api/delete-bill', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: id })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.error) {
                        appAlert("Error: " + data.error, "Error");
                        if(btn) {
                            btn.innerText = "Delete Expense";
                            btn.disabled = false;
                            btn.style.opacity = "1";
                        }
                    } else {
                        closeModal();
                        loadExpenses(true); 
                    }
                })
                .catch(err => {
                    appAlert("System error occurred.", "Error");
                    if(btn) btn.disabled = false;
                });
            });
        }
        
        // --- UPDATED GOAL DETAIL (Pockets) with Group Assignment ---
        function openGoalDetailList(index) {
            const g = goalsDataStore[index];
            const modal = document.getElementById('tx-modal');
            modal.style.display = 'flex';
            document.getElementById('modal-title-text').innerText = "Pocket Activity";
            const body = document.getElementById('modal-body-content');

            // Set initial layout while loading
            const isCreditCard = g.isCreditCard === true;
            const amountLabel = isCreditCard ? 'Set Aside' : 'Saved';
            const targetText = g.target > 0 ? `${amountLabel} of ${fmt(g.target)}` : `Total ${amountLabel}`;
            
            // Pre-fill group logic if needed (though we manage via the main button now, keeping this doesn't hurt)
            // But per your request, the management button is the primary way now.
            // Let's keep the standard detail view clean.
            
            body.innerHTML = `
                <div class="pocket-header">
                    <div class="pocket-balance">${fmt(g.balance)}</div>
                    <div class="pocket-sub">${targetText}</div>
                </div>

                <div class="pocket-tx-scroll" id="pocket-tx-list">
                    <div style="text-align:center; padding:20px; color:#999;">Loading activity...</div>
                </div>
                
                <div style="margin-top: 20px; display: flex; flex-direction: row; gap: 15px;">
                    <button class="btn-goal-add" style="flex:1; margin:0;" onclick="openMoveModal('${g.id}')">Add Funds</button>
                    <button class="btn-goal-delete" style="flex:1; margin:0;" onclick="deletePocket('${g.id}', '${g.name.replace(/'/g, "\\'")}')">Delete Pocket</button>
                </div>
            `;

            // Fetch transactions for this pocket
            fetch('/api/transactions?pageSize=100').then(res => res.json()).then(data => {
                const listContainer = document.getElementById('pocket-tx-list');
                if(data.error) {
                    listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:red;">Error loading</div>';
                    return;
                }
                
                const pocketTxs = data.transactions.filter(t => t.subaccountId === g.id);
                
                if(pocketTxs.length === 0) {
                    listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">No recent activity</div>';
                } else {
                    let html = '';
                    pocketTxs.forEach(tx => {
                        const date = new Date(tx.date).toLocaleDateString(undefined, {month:'short', day:'numeric'});
                        const amtClass = tx.amount > 0 ? 'tx-pos' : 'tx-neg';
                        const sign = tx.amount > 0 ? '+' : '';
                        
                        html += `
                        <div class="pocket-tx-row">
                            <div class="pocket-tx-date">${date}</div>
                            <div class="pocket-tx-title">${tx.title}</div>
                            <div class="pocket-tx-amt ${amtClass}">${sign}${fmt(tx.amount)}</div>
                        </div>
                        `;
                    });
                    listContainer.innerHTML = html;
                }
            });
        }

        // --- NEW DELETE FUNCTION ---
        function deletePocket(id, name) {
            // 1. Confirmation
            appConfirm(`Are you sure you want to delete the "${name}" pocket?\n\nThis will permanently remove the pocket history.`, "Delete Pocket", { confirmText: "Delete", danger: true }).then(confirmed => {
                if (!confirmed) return;

                const btn = document.querySelector('.btn-goal-delete');
                if(btn) {
                    btn.innerText = "Deleting...";
                    btn.disabled = true;
                    btn.style.opacity = "0.7";
                }

                // 2. Call Backend
                fetch('/api/delete-pocket', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: id })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.error) {
                        appAlert("Error deleting pocket: " + data.error, "Error");
                        if(btn) {
                            btn.innerText = "Delete Pocket";
                            btn.disabled = false;
                        }
                    } else {
                        // 3. Success
                        closeModal();
                        // Force refresh lists
                        loadGoals(true);
                        loadSidebarPockets(true);
                        initBalances(); // Refresh total balances
                    }
                })
                .catch(err => {
                    appAlert("System error occurred.", "Error");
                });
            });
        }

        function openFamilyDetail(type, index) {
            if (type !== 'child') return;
            fetch('/api/family').then(res=>res.json()).then(data => {
                const person = data.children[index];
                const modal = document.getElementById('tx-modal'); modal.style.display = 'flex'; document.getElementById('modal-title-text').innerText = "Account Details";
                const age = Math.abs(new Date(Date.now() - new Date(person.dob).getTime()).getUTCFullYear() - 1970);
                document.getElementById('modal-body-content').innerHTML = `<div style="text-align:center;"><img src="${person.image}" style="width:80px; height:80px; border-radius:50%; margin-bottom:15px; border:2px solid #EEE;"><div style="font-size:20px; font-weight:700; color:#333; margin-bottom:5px;">${person.name}</div><div class="detail-amount">${fmt(person.balance)}</div><div style="color:#999; margin-bottom:25px;">Checking Balance</div><div style="text-align:left;"><div class="detail-row"><span>Role</span><span>Child (${age} yrs)</span></div><div class="detail-row"><span>Allowance</span><span>${person.allowance}</span></div><div class="detail-row"><span>Card Color</span><span style="color:${cardColors[person.color]}">● ${person.color}</span></div></div><button class="btn-goal-add">Manage Settings</button></div>`;
            });
        }
        function openSidebarGoalDetail(index) {
            // Reuse the main detail view for sidebar clicks too for consistency
            // Note: Since sidebar ordering might differ if grouping is used, we need to find the correct index in the master store
            // However, loadSidebarPockets updates goalsDataStore to flat list, which might conflict if both are used. 
            // Better to rely on the ID. But for now, since loadGoals refreshes the store with grouping, let's just re-open the main goals tab.
            switchTab('goals');
        }
        function openTxDetail(id) { const modal = document.getElementById('tx-modal'); modal.style.display = 'flex'; document.getElementById('modal-title-text').innerText = "Transaction Details"; document.getElementById('modal-body-content').innerHTML = 'Loading...'; fetch(`/api/transaction/${encodeURIComponent(id)}`).then(res=>res.json()).then(data => { document.getElementById('modal-body-content').innerHTML = `<div style="text-align:center; margin-bottom: 20px;"><div class="detail-amount">${fmt(data.amount)}</div><div style="font-size:16px;">${data.title}</div></div><div style="text-align:left;"><div class="detail-row"><span>Date</span><span>${new Date(data.date).toLocaleDateString()}</span></div><div class="detail-row"><span>Status</span><span>${data.status}</span></div></div>`; }); }
        
        function closeModal(e) { document.getElementById('tx-modal').style.display = 'none'; }
        
        // --- MOVE MONEY MODAL ---
        function openMoveModal(preFillToId = null) { 
            // Close other modals if open (like the pocket detail modal)
            document.getElementById('tx-modal').style.display = 'none';
            
            document.getElementById('move-modal').style.display = 'flex'; 
            document.getElementById('move-message').innerHTML = ''; 
            
            // ALWAYS REFRESH
            fetch('/api/subaccounts?refresh=true').then(res=>res.json()).then(data => { 
                if(data.error) return; 
                
                // Store account data globally for validation logic
                moveMoneyAccounts = data.subaccounts; 
                
                const opts = data.subaccounts.map(acc => `<option value="${acc.id}">${acc.name} (${fmt(acc.balance)})</option>`).join(''); 
                const fromSelect = document.getElementById('move-from');
                const toSelect = document.getElementById('move-to');
                
                fromSelect.innerHTML = opts; 
                toSelect.innerHTML = opts; 
                
                // Logic to pre-fill destination if provided
                if(preFillToId) {
                    toSelect.value = preFillToId;
                    // Try to set 'From' to Checking (assuming first one or specific logic) if not same
                    if(fromSelect.value === preFillToId && fromSelect.options.length > 1) {
                         fromSelect.selectedIndex = (fromSelect.selectedIndex + 1) % fromSelect.options.length;
                    }
                }
            }); 
        }

        function closeMoveModal() { document.getElementById('move-modal').style.display = 'none'; }
        
        function executeTransfer() { 
            const btn = document.querySelector('#move-modal .btn-goal-add'); 
            const msg = document.getElementById('move-message'); 
            
            const fromId = document.getElementById('move-from').value;
            const toId = document.getElementById('move-to').value;
            const amount = parseFloat(document.getElementById('move-amount').value);
            const note = document.getElementById('move-note').value;

            // --- VALIDATION START ---
            if (fromId === toId) {
                msg.innerHTML = '<div style="color:var(--alert-red); margin-bottom:10px;">Cannot transfer to the same account.</div>';
                return;
            }

            const sourceAccount = moveMoneyAccounts.find(acc => acc.id === fromId);
            if (sourceAccount && amount > sourceAccount.balance) {
                msg.innerHTML = '<div style="color:var(--alert-red); margin-bottom:10px;">Insufficient funds. Available: ' + fmt(sourceAccount.balance) + '</div>';
                return;
            }

            if (!amount || amount <= 0) {
                msg.innerHTML = '<div style="color:var(--alert-red); margin-bottom:10px;">Please enter a valid amount.</div>';
                return;
            }
            // --- VALIDATION END ---

            btn.disabled = true; 
            btn.innerText = "Processing..."; 
            
            const payload = { fromId, toId, amount, note }; 
            
            fetch('/api/move-money', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(payload) 
            }).then(res=>res.json()).then(data => { 
                btn.disabled = false; 
                btn.innerText = "Transfer Funds"; 
                if(data.error) { 
                    msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">${data.error}</div>`; 
                } else { 
                    msg.innerHTML = `<div style="color:green; margin-bottom:10px;">Success!</div>`; 
                    setTimeout(() => { 
                        closeMoveModal(); 
                        initBalances(); 
                        reloadTx(); 
                        loadSidebarPockets(true); 
                        
                        // Also refresh current view
                        if(document.getElementById('view-expenses').classList.contains('active')) loadExpenses(true);
                        if(document.getElementById('view-goals').classList.contains('active')) loadGoals(true);

                    }, 1500); 
                } 
            }); 
        }

        // --- NEW: ADD BILL LOGIC ---
        function openBillModal() {
            document.getElementById('bill-modal').style.display = 'flex';
            document.getElementById('bill-message').innerHTML = '';
            
            // Populate Days (1-31)
            const daySelect = document.getElementById('bill-day');
            daySelect.innerHTML = '';
            for(let i=1; i<=31; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = i + (i===1?'st':(i===2?'nd':(i===3?'rd':'th')));
                daySelect.appendChild(opt);
            }
        }

        function closeBillModal(e) { document.getElementById('bill-modal').style.display = 'none'; }

        function saveBill() {
            const btn = document.querySelector('#bill-modal .btn-goal-add');
            const msg = document.getElementById('bill-message');
            const modalBody = document.querySelector('#bill-modal .modal-body');
            
            // 1. Gather Inputs
            const name = document.getElementById('bill-name').value;
            const amount = document.getElementById('bill-amount').value;
            const frequency = document.getElementById('bill-freq').value;
            const dayOfMonth = document.getElementById('bill-day').value;
            
            // Optional / Advanced Inputs
            const matchString = document.getElementById('bill-id-search').value;
            const minAmount = document.getElementById('bill-min').value;
            const maxAmount = document.getElementById('bill-max').value;
            const isVariable = document.getElementById('bill-variable').checked;

            // 2. Validation
            if(!name || !amount) {
                msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">Please enter name and amount.</div>`;
                return;
            }
            
            if(!dayOfMonth) {
                msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">Please select a day of the month.</div>`;
                return;
            }

            btn.disabled = true;
            btn.innerText = "Creating Bill...";

            // 3. Construct Payload
            const payload = {
                name: name,
                amount: amount,
                frequency: frequency,
                dayOfMonth: dayOfMonth,
                matchString: matchString || null,
                minAmount: minAmount || null,
                maxAmount: maxAmount || null,
                variable: isVariable
            };

            // 4. API Call
            fetch('/api/create-bill', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                    btn.disabled = false;
                    btn.innerText = "Create Bill";

                    if(data.error) {
                        msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">${data.error}</div>`;
                    } else {
                        // SUCCESS LOGIC
                        const res = data.result;
                        const reservedCents = res.reservedAmount || 0;
                        const reservedAmt = reservedCents / 100.0;
                        
                        // Use the simplified name we injected from the Python backend
                        const accountName = res.fundingDisplayName || "Checking";

                        // Replace Modal Content with Success Message
                        modalBody.innerHTML = `
                            <div style="text-align:center; padding: 20px 0;">
                                <div style="font-size: 40px; margin-bottom: 10px;">🎉</div>
                                <div style="font-size: 18px; font-weight: 700; color: #2C2C2C; margin-bottom: 15px;">Bill Created Successfully</div>
                                
                                <div style="background: #F8F9FB; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: left; border: 1px solid #EEE;">
                                    <div style="font-size: 14px; line-height: 1.5; color: #555;">
                                        To ensure <strong>${name}</strong> is fully caught up and aligned with your funding schedule, 
                                        <span style="color: #2C2C2C; font-weight: 700;">${fmt(reservedAmt)}</span> 
                                        has been automatically reserved from your 
                                        <span style="color: #2C2C2C; font-weight: 700;">${accountName}</span> account.
                                    </div>
                                </div>

                                <button class="btn-goal-add" onclick="closeBillModalAndRefresh()">Done</button>
                            </div>
                        `;
                    }
                })
            .catch(err => {
                btn.disabled = false;
                btn.innerText = "Create Bill";
                msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">System Error</div>`;
                console.error(err);
            });
        }

        // Add this helper function to handle the close + refresh logic
        function closeBillModalAndRefresh() {
            closeBillModal();
            // Use timeout to allow modal animation to finish slightly
            setTimeout(() => {
                // Reset the modal body content for next time (optional, but good practice if not reloading page)
                // Since we are doing a simpler prototype, we can just reload lists.
                // Ideally you would reconstruct the form HTML here if you want to reuse it without refresh.
                // For now, we refresh data.
                loadExpenses(true);
                initBalances();
            }, 200);
        }
// --- NEW: ADD POCKET LOGIC ---
        function openPocketModal() {
            document.getElementById('pocket-modal').style.display = 'flex';
            document.getElementById('pocket-message').innerHTML = '';
            // Reset fields
            document.getElementById('pocket-name').value = '';
            document.getElementById('pocket-amount').value = '';
            document.getElementById('pocket-initial').value = '';
            document.getElementById('pocket-desc').value = '';
            document.getElementById('pocket-group').value = '';
            
            // Populate group dropdown
            const groupSelect = document.getElementById('pocket-group');
            groupSelect.innerHTML = '<option value="">No Group</option>';
            allGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                groupSelect.appendChild(option);
            });
            
            // Initial hint update
            const avail = currentBalances.checking;
            document.getElementById('pocket-funding-hint').innerText = `Safe-to-Spend: ${fmt(avail)}`;
        }

        function closePocketModal(e) { document.getElementById('pocket-modal').style.display = 'none'; }
        
function savePocket() {
            const btn = document.querySelector('#pocket-modal .btn-goal-add');
            const msg = document.getElementById('pocket-message');
            
            const name = document.getElementById('pocket-name').value;
            const amount = document.getElementById('pocket-amount').value;
            const initial = document.getElementById('pocket-initial').value || 0;
            const note = document.getElementById('pocket-desc').value || "";
            const groupId = document.getElementById('pocket-group').value || null;
            
            console.log('Selected groupId:', groupId); // Debug log
            
            // Validation
            if(!name || !amount) {
                msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">Please enter name and goal amount.</div>`;
                return;
            }
            
            const avail = currentBalances.checking;
            if (parseFloat(initial) > avail) {
                msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">Initial funding cannot exceed Safe-to-Spend balance (${fmt(avail)}).</div>`;
                return;
            }

            btn.disabled = true;
            btn.innerText = "Creating Pocket...";

            // Payload matches the arguments expected by the Python route
            const payload = { 
                name: name, 
                amount: amount, 
                initial: initial, 
                note: note,
                groupId: groupId
            };
            
            console.log('Sending payload:', payload); // Debug log

            fetch('/api/create-pocket', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                console.log('Backend response:', data); // Debug log
                btn.disabled = false;
                btn.innerText = "Create Pocket";

                if(data.error) {
                    msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">${data.error}</div>`;
                } else {
                    msg.innerHTML = `<div style="color:green; margin-bottom:10px;">Success! Pocket Created.</div>`;
                    
                    setTimeout(() => {
                        closePocketModal();
                        // Force refresh goals and sidebar to show the new pocket
                        loadGoals(true); 
                        loadSidebarPockets(true);
                        // Refresh balance math in case money was moved
                        initBalances(); 
                    }, 1000);
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerText = "Create Pocket";
                msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">System Error</div>`;
            });
        }

        // --- MOBILE HEADER DROPDOWN LOGIC ---
        function toggleMobileStats(e) {
            e.stopPropagation(); // Prevent document click from closing immediately
            const header = document.querySelector('.mobile-center-header');
            const dropdown = document.getElementById('mobile-sts-dropdown');
            
            // Toggle class
            const isShowing = dropdown.classList.contains('show');
            
            if (isShowing) {
                dropdown.classList.remove('show');
                header.classList.remove('active');
            } else {
                // Update numbers from the desktop hidden header
                document.getElementById('mb-math-total').innerText = document.getElementById('math-total').innerText;
                document.getElementById('mb-math-bills').innerText = "-" + document.getElementById('math-sched').innerText;
                document.getElementById('mb-math-goals').innerText = "-" + document.getElementById('math-goals').innerText;
                document.getElementById('mb-math-sts').innerText = document.getElementById('sts-balance').innerText;
                
                dropdown.classList.add('show');
                header.classList.add('active');
            }
        }

        // Click off listener for dropdown
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('mobile-sts-dropdown');
            const header = document.querySelector('.mobile-center-header');
            if(dropdown && dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                header.classList.remove('active');
            }
        });
        // Accepts a 'force' parameter (true/false)
        function initBalances(force = false) {
            // If force is true, add ?refresh=true to the URL
            const url = force ? '/api/savings?refresh=true' : '/api/savings';

            fetch(url).then(res=>res.json()).then(data => {
                if(!data.error) {
                    const allPocketsTotal = data.total_goals || 0;
                    const checkBal = data.checking ? parseFloat(data.checking.raw_balance) : 0;

                    currentBalances.checking = checkBal;
                    currentBalances.savings = allPocketsTotal;

                    if(data.checking) {
                        document.getElementById('checking-val').innerText = fmt(checkBal);
                    }
                    const mathGoalsEl = document.getElementById('math-goals');
                    if(mathGoalsEl) {
                        mathGoalsEl.innerText = fmt(allPocketsTotal);
                    }
                }
                loadExpenses();
            });
        }

        // --- INTERCOM INTEGRATION ---
        
        // 1. Standard Intercom Install Snippet
        (function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',w.intercomSettings);}else{var d=document;var i=function(){i.c(arguments);};i.q=[];i.c=function(args){i.q.push(args);};w.Intercom=i;var l=function(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/c7bal0a1';var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);};if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}})();

        function loadIntercom() {
            fetch('/api/intercom')
                .then(res => res.json())
                .then(data => {
                    if(data.error) {
                        console.log("Intercom skipped: " + data.error);
                        return;
                    }

                    const userData = data.user_data;

                    // Prepare Settings
                    // Inside your loadIntercom() function...

                    window.intercomSettings = {
                        api_base: "https://api-iam.intercom.io",
                        app_id: "c7bal0a1",
                        
                        user_id: userData.user_id,
                        intercom_user_jwt: userData.intercom_user_jwt,
                        
                        // NEW: Hide the bubble automatically if on mobile
                        hide_default_launcher: window.innerWidth <= 768, 

                        launcher_logo_url: "https://media.licdn.com/dms/image/v2/D560BAQEroTqp4W9tBg/company-logo_200_200/company-logo_200_200/0/1686260003377/trycrew_logo?e=2147483647&v=beta&t=AFyDbpJ8X-2MB86GkQo9MmPMZGLuUp-FMu-BDHH5hvM"
                    };

                    // Initialize the Messenger
                    if (window.Intercom) {
                        window.Intercom('boot', window.intercomSettings);
                    }
                })
                .catch(err => console.error("Intercom fetch failed", err));
        }


        // Start with forced refresh on pockets to ensure sidebar is accurate
        initBalances(); reloadTx(); loadTrends(); loadSidebarPockets(true); loadUserProfile(); loadIntercom(); loadCards(true); updateCreditCardToggleButton();

    </script>
    <!-- Custom App Dialog -->
    <div id="app-dialog-overlay" class="app-dialog-overlay">
        <div class="app-dialog">
            <div class="app-dialog-header">
                <h3 class="app-dialog-title" id="app-dialog-title">Alert</h3>
            </div>
            <div class="app-dialog-body" id="app-dialog-body"></div>
            <div class="app-dialog-footer" id="app-dialog-footer"></div>
        </div>
    </div>

    <script>
        // Custom Dialog Functions
        let appDialogResolve = null;
        
        function showAppDialog(title, message, buttons) {
            const overlay = document.getElementById('app-dialog-overlay');
            const titleEl = document.getElementById('app-dialog-title');
            const bodyEl = document.getElementById('app-dialog-body');
            const footerEl = document.getElementById('app-dialog-footer');
            
            titleEl.textContent = title || 'Alert';
            bodyEl.textContent = message || '';
            footerEl.innerHTML = '';
            
            if (buttons && buttons.length > 0) {
                buttons.forEach((btn, index) => {
                    const button = document.createElement('button');
                    button.className = `app-dialog-button ${btn.class || 'app-dialog-button-secondary'}`;
                    button.textContent = btn.text || 'OK';
                    button.onclick = (e) => {
                        e.stopPropagation(); // Prevent bubbling to overlay
                        // Resolve the promise first with the button's value
                        const result = btn.value !== false;
                        if (appDialogResolve) {
                            appDialogResolve(result);
                            appDialogResolve = null;
                        }
                        if (btn.onClick) btn.onClick();
                        // Then hide the dialog
                        hideAppDialog();
                    };
                    footerEl.appendChild(button);
                });
            } else {
                // Default OK button
                const button = document.createElement('button');
                button.className = 'app-dialog-button app-dialog-button-primary';
                button.textContent = 'OK';
                button.onclick = (e) => {
                    e.stopPropagation(); // Prevent bubbling to overlay
                    // Resolve the promise first
                    if (appDialogResolve) {
                        appDialogResolve(true);
                        appDialogResolve = null;
                    }
                    // Then hide the dialog
                    hideAppDialog();
                };
                footerEl.appendChild(button);
            }
            
            // Set up overlay click handler to close when clicking outside
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    hideAppDialog();
                }
            };
            
            // Prevent clicks inside the dialog from closing it
            const dialog = overlay.querySelector('.app-dialog');
            dialog.onclick = function(e) {
                e.stopPropagation();
            };
            
            overlay.classList.add('show');
            return new Promise(resolve => {
                appDialogResolve = resolve;
            });
        }
        
        function hideAppDialog() {
            const overlay = document.getElementById('app-dialog-overlay');
            if (!overlay) return;
            overlay.classList.remove('show');
            // Only resolve with false if we haven't already resolved (e.g., when clicking outside)
            if (appDialogResolve) {
                appDialogResolve(false);
                appDialogResolve = null;
            }
        }
        
        // Replace browser alert() and confirm()
        function appAlert(message, title = 'Alert') {
            return showAppDialog(title, message, [
                { text: 'OK', class: 'app-dialog-button-primary', value: true }
            ]);
        }
        
        function appConfirm(message, title = 'Confirm', options = {}) {
            const confirmText = options.confirmText || 'OK';
            const cancelText = options.cancelText || 'Cancel';
            const confirmClass = options.danger ? 'app-dialog-button-danger' : 'app-dialog-button-primary';
            
            return showAppDialog(title, message, [
                { text: cancelText, class: 'app-dialog-button-secondary', value: false },
                { text: confirmText, class: confirmClass, value: true }
            ]);
        }
    </script>
    </body>
</html>