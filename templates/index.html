<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Simple. Activity</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FDFDFD">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Simple">
    <link rel="apple-touch-icon" href="https://d31s10tn3clc14.cloudfront.net/imgs/deposits/Review+Logos/simple-logo.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #FDFDFD;
            --border-color: #E8E8E8;
            --text-dark: #2C2C2C;
            --text-light: #767676;
            --simple-blue: #0093E9;
            --alert-red: #D93025;
            --link-blue: #0085C3;
            --exp-track: #F0F0F0;
            --exp-fill: #34495E;
            --nav-height: 60px;
            --bottom-nav-height: 0px; /* 0 on desktop */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-dark); 
            font-size: 14px; 
            overflow-y: hidden; /* Desktop keeps hidden, Mobile will override */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- NAV --- */
        .top-nav { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            height: var(--nav-height); 
            padding: 0 40px; 
            background: #FFF; 
            border-bottom: 1px solid var(--border-color); 
            flex-shrink: 0; 
            z-index: 50;
            position: relative; /* For absolute centering */
        }
        .nav-left, .nav-right { display: flex; align-items: center; gap: 30px; }
        .logo { margin-right: 15px; display: flex; align-items: center; }
        .logo img { height: 22px; display: block; }
        
        .nav-link { 
            text-decoration: none; 
            color: var(--text-dark); 
            font-weight: 500; 
            padding: 21px 0; 
            border-bottom: 2px solid transparent; 
            cursor: pointer; 
            transition: color 0.2s; 
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .nav-link svg {
            display: none; /* Hidden on desktop */
            width: 24px;
            height: 24px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .nav-link:hover { color: var(--simple-blue); }
        .nav-link.active { border-bottom: 2px solid var(--simple-blue); color: var(--text-dark); }
        
        .user-profile { display: flex; align-items: center; gap: 10px; color: var(--text-light); cursor: pointer; }
        .avatar { width: 32px; height: 32px; background: #F5A623; color: #FFF; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; }

        /* --- HEADER --- */
        .info-header { 
            background: #FAFAFA; 
            padding: 25px 40px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            flex-shrink: 0; 
            margin-bottom: 0;
        }
        .balance-container h1 { margin: 0; font-size: 32px; font-weight: 600; color: var(--text-dark); display: flex; align-items: baseline; gap: 12px; }
        .sts-label { font-size: 15px; font-weight: 400; color: #999; }
        .math-line { margin-top: 6px; font-size: 13px; color: var(--text-dark); }
        .math-gray { color: #999; }
        .header-links { display: flex; gap: 30px; align-items: center; } 
        .header-link-group { display: flex; flex-direction: column; }
        .header-link-label { font-size: 12px; color: #999; margin-bottom: 4px; }
        .header-link-action { font-size: 13px; color: var(--link-blue); font-weight: 500; text-decoration: none; }

        /* --- CONTROLS --- */
        .controls-bar { 
            padding: 25px 40px 0 40px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-shrink: 0; 
            margin-bottom: -10px;
        }
        #search-container { display: flex; gap: 10px; width: 60%; transition: opacity 0.2s; }
        .search-input { padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 4px; width: 100%; font-size: 14px; color: #333; }
        .btn { padding: 8px 16px; border-radius: 4px; font-weight: 500; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .btn-outline { background: #FFF; border: 1px solid var(--border-color); color: var(--text-dark); white-space: nowrap; }
        .btn-outline:hover { border-color: #BBB; }
        
        .btn-move { background: #FFF; border: 1px solid var(--border-color); color: var(--text-dark); display: flex; align-items: center; gap: 8px; padding: 10px 16px; white-space: nowrap; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.05);}
        .btn-move:hover { border-color: #BBB; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* FILTERS */
        .filters { 
            padding: 0 40px; 
            margin-bottom: 20px; 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            flex-shrink: 0; 
            position: relative; 
            margin-top: 20px;
            z-index: 10;
        }
        .pill { background: #E0E0E0; color: var(--text-dark); padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px;}
        .pill:hover { background: #D0D0D0; }
        .pill-remove { font-size: 14px; color: #666; font-weight: normal; }
        .link-blue { color: var(--link-blue); font-size: 13px; cursor: pointer; user-select: none; white-space: nowrap; }

        /* FILTER POPUP */
        .filter-popup {
            position: absolute; top: 30px; left: 150px; background: #FFF; border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-radius: 6px; padding: 20px; width: 300px; z-index: 100; display: none;
        }
        .filter-group { margin-bottom: 15px; }
        .filter-label { font-size: 12px; font-weight: 600; color: #777; margin-bottom: 5px; display: block; }
        .filter-row { display: flex; gap: 10px; }
        .filter-input { width: 100%; padding: 8px; border: 1px solid #DDD; border-radius: 4px; font-size: 13px; }
        .btn-apply { background: var(--simple-blue); color: #FFF; width: 100%; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: 600; }

        /* NEW: Popup Header for Exit Button */
        .popup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom:10px; border-bottom:1px solid #F0F0F0; }
        .popup-title { font-weight: 700; font-size: 14px; color: #333; }
        .close-popup { font-size: 24px; color: #999; cursor: pointer; line-height: 1; }
        .close-popup:hover { color: #333; }

        /* --- GRID --- */
        .main-grid { 
            display: grid; 
            grid-template-columns: 3fr 1fr; 
            gap: 40px; 
            padding: 0 40px; 
            max-width: 1600px; 
            /* On desktop, we want the grid to fill remaining height */
            flex: 1;
            overflow: hidden; 
            width: 100%;
            margin-top: 30px;
        }
        .main-column {
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Contains the internal scroll */
            height: 100%;
        }

        .view-section { display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }

        .section-header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--simple-blue); padding-bottom: 12px; margin-bottom: 0px; flex-shrink: 0; }
        .tab-title { font-weight: 700; font-size: 15px; color: var(--text-dark); }
        .view-toggles { color: var(--text-light); font-size: 13px; cursor: default; }
        .view-toggles span.active { color: var(--text-dark); font-weight: 700; }

        .data-container {
            background: #FFF; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 4px 4px;
            flex: 1; 
            overflow-y: auto; 
            scrollbar-width: thin; 
            scrollbar-color: #CCC #F0F0F0;
        }
        .data-container::-webkit-scrollbar { width: 8px; }
        .data-container::-webkit-scrollbar-track { background: #FAFAFA; border-left: 1px solid #EEE; }
        .data-container::-webkit-scrollbar-thumb { background-color: #C1C1C1; border-radius: 4px; border: 2px solid #FAFAFA; }

        /* TRANSACTIONS */
        .tx-group-date { font-size: 12px; color: #999; font-weight: 700; background: #FAFAFA; padding: 8px 15px; border-bottom: 1px solid #EEE; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 2; }
        .tx-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: #FFF; border-bottom: 1px solid #F4F4F4; cursor: pointer; transition: background 0.1s; }
        .tx-row:hover { background: #F7FBFF; }
        .tx-left { display: flex; flex-direction: column; gap: 4px; }
        .tx-title { font-weight: 600; font-size: 14px; color: var(--text-dark); }
        .tx-desc { font-size: 12px; color: #999; }
        .tx-amount { font-weight: 600; font-size: 14px; }
        .tx-neg { color: var(--text-dark); }
        .tx-pos { color: #63BB67; }

        /* EXPENSES & GOALS */
        .exp-summary-bar { font-size: 13px; color: #767676; font-weight: 500; margin-bottom: 15px; text-align: right; }
        
        /* New Expense Hero Card for Mobile */
        .exp-hero-card {
            background: #FFF;
            padding: 20px 25px;
            border-bottom: 1px solid #EAEAEA;
            display: none; /* Hidden on desktop by default */
            flex-direction: row;
            justify-content: space-between;
            align-items: stretch;
        }
        .exp-hero-col { display: flex; flex-direction: column; justify-content: center; }
        .exp-hero-col.right { min-width: 90px; }
        
        .exp-hero-divider {
            width: 1px;
            background-color: #E0E0E0;
            margin: 0 20px;
        }

        .hero-lbl { font-size: 13px; color: #999; font-weight: 400; margin-bottom: 5px; }
        .hero-val { font-size: 16px; font-weight: 600; color: #2C2C2C; }
        .hero-status { font-size: 15px; font-weight: 600; color: #2E7D32; display: flex; align-items: center; gap: 4px; }

        .exp-item { padding: 20px 25px; border-bottom: 1px solid #EAEAEA; cursor: pointer; transition: background-color 0.15s; }
        .exp-item:last-child { border-bottom: none; }
        .exp-item:hover { background-color: #F9F9F9; }
        .exp-header-line { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .exp-name { font-weight: 700; font-size: 15px; color: #2C2C2C; }
        .exp-funding-status { font-size: 12px; font-weight: 600; color: #767676; background: #F0F0F0; padding: 3px 8px; border-radius: 4px; }
        .exp-funding-status.ready { background: #E6F8E8; color: #2E7D32; }
        .exp-progress-container { height: 10px; background: var(--exp-track); border-radius: 5px; width: 100%; overflow: hidden; margin-bottom: 10px; }
        .exp-progress-bar { height: 100%; background: var(--exp-fill); width: 0%; border-radius: 5px; transition: width 0.5s ease-out; }
        .exp-details { display: flex; justify-content: space-between; font-size: 13px; color: #666; font-weight: 500; }

        /* ADD BILL / POCKET ROW STYLES */
        .add-bill-row {
            border: 2px dashed #E0E0E0;
            border-radius: 8px;
            margin: 10px 25px 20px 25px;
            padding: 18px;
            text-align: center;
            color: #999;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .add-bill-row:hover {
            border-color: var(--simple-blue);
            color: var(--simple-blue);
            background: #F7FBFF;
        }

        /* FAMILY TAB */
        .family-section-title { font-size: 14px; font-weight: 700; color: #999; margin: 25px 0 15px 0; text-transform: uppercase; letter-spacing: 0.5px; }
        .family-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .family-card { background: #FFF; border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; position: relative; overflow: hidden; }
        .family-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .color-strip { position: absolute; top: 0; left: 0; right: 0; height: 6px; }
        .profile-img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 2px solid #FFF; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .family-name { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 5px; }
        .family-role { font-size: 12px; font-weight: 500; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }
        .family-balance { font-size: 24px; font-weight: 600; color: #333; margin-top: 15px; }

        /* CARDS TAB */
        .card-row { display: flex; align-items: center; padding: 20px; border-bottom: 1px solid #EAEAEA; background: #FFF; transition: background 0.1s; }
        .card-row:hover { background: #FAFAFA; }
        .card-icon { width: 40px; height: 26px; border-radius: 4px; margin-right: 15px; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card-icon::after { content:''; position:absolute; top:4px; left:4px; width:6px; height:4px; background:rgba(255,255,255,0.5); border-radius:1px; }
        .card-info { flex: 1; }
        .card-name { font-weight: 600; font-size: 15px; color: #333; }
        .card-meta { font-size: 13px; color: #999; margin-top: 2px; }
        .card-type-badge { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 4px 8px; border-radius: 12px; margin-right: 15px; }
        .type-phys { background: #E3F2FD; color: #1565C0; }
        .type-virt { background: #F3E5F5; color: #7B1FA2; }
        .card-status { font-size: 13px; font-weight: 500; width: 100px; text-align: right; }
        .status-active { color: #63BB67; }
        .status-inactive { color: #AAA; }

        /* SIDEBAR */
        .sidebar-column { display: flex; flex-direction: column; overflow: hidden; }
        .sidebar-card { background: #FFF; border: 1px solid var(--border-color); border-radius: 4px; padding: 20px; margin-bottom: 20px; flex-shrink: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
        .card-title { font-size: 13px; font-weight: 700; margin-bottom: 15px; display: flex; justify-content: space-between; color: var(--text-dark); }
        .trend-row { display: flex; justify-content: space-between; padding: 12px 0; font-size: 13px; border-bottom: 1px solid #FAFAFA; }
        .trend-row:last-child { border-bottom: none; }
        .goal-bar-bg { height: 4px; background: #E6E6E6; border-radius: 2px; margin-top: 8px; overflow: hidden; }
        .goal-bar-fill { height: 100%; background: var(--simple-blue); width: 0%; }
        .goal-card-clickable { cursor: pointer; transition: border-color 0.2s; }
        .goal-card-clickable:hover { border-color: var(--simple-blue); }

        /* MODAL */
        /* UPDATE: Z-INDEX Increased to 2100 to beat Bottom Nav (1000) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(3px); display: none; justify-content: center; align-items: center; z-index: 2100; }
        .modal-content { background: #FFF; width: 450px; border-radius: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); border: none; overflow: hidden; animation: popIn 0.2s ease-out; max-width: 90vw;}
        /* Animation for Modals (Flex centered) */
        @keyframes popIn { 
            from { transform: scale(0.95); opacity: 0; } 
            to { transform: scale(1); opacity: 1; } 
        }
        
        /* Animation for Fixed/Absolute centered elements (Transform centered) */
        @keyframes popInCenter { 
            from { transform: translateX(-50%) scale(0.95); opacity: 0; } 
            to { transform: translateX(-50%) scale(1); opacity: 1; } 
        }

        .modal-header { padding: 15px 20px; background: #F8F9FB; border-bottom: 1px solid #EEE; display: flex; justify-content: space-between; align-items: center; }
        
        /* UPDATE: Added Scroll Properties for Mobile Forms */
        .modal-body { 
            padding: 30px; 
            max-height: 70vh; /* Restrict height */
            overflow-y: auto; /* Allow scroll */
            scrollbar-width: thin;
            -webkit-overflow-scrolling: touch; /* Smooth iOS scroll */
        }
        
        .detail-amount { font-size: 36px; font-weight: 700; margin-bottom: 5px; color: #333; letter-spacing: -1px; }
        .detail-title { font-size: 18px; font-weight: 500; color: #555; margin-bottom: 25px; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 14px; border-bottom: 1px solid #FAFAFA; padding-bottom: 10px; }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { color: #999; font-weight: 500; }
        .detail-val { color: #333; font-weight: 600; }
        .close-btn { cursor: pointer; font-size: 24px; color: #999; line-height: 1; }
        .close-btn:hover { color: #333; }
        
        /* Updated Button Styles for Modal Footer */
        .btn-goal-add { 
            background: var(--simple-blue); 
            color: #FFF; 
            width: 100%; 
            padding: 14px; 
            border-radius: 6px; 
            border:none; 
            font-weight:600; 
            font-size:15px; 
            cursor: pointer; 
            margin-top: 10px; /* Default margin for standard forms */
        }
        .btn-goal-add:hover { background: #007BB5; }

        /* NEW DELETE BUTTON STYLE */
        .btn-goal-delete {
            background: #FFF;
            color: var(--alert-red);
            border: 1px solid #E0E0E0; /* Slightly clearer border */
            width: 100%;
            padding: 14px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 15px; /* Matched font size to Add button */
            cursor: pointer;
            margin-top: 15px; /* Default margin */
            transition: all 0.2s;
        }
        .btn-goal-delete:hover {
            background: #FFF5F5; 
            border-color: var(--alert-red);
        }

        /* --- CUSTOM SUGGESTION DROPDOWN STYLES --- */
        .suggestion-box {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #FFF;
            border: 1px solid #DDD;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000; /* High Z-index */
            display: none; /* Hidden by default */
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); /* Stronger shadow */
        }
        .suggestion-item {
            padding: 12px 10px; /* Larger tap area for mobile */
            cursor: pointer;
            border-bottom: 1px solid #F0F0F0;
            font-size: 14px;
            color: #333;
            background: #FFF;
        }
        .suggestion-item:hover {
            background: #F9F9F9;
            color: var(--simple-blue);
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }

        .form-group { margin-bottom: 15px; }
        .form-row-2 { display: flex; gap: 15px; }
        .form-label { display: block; font-size: 12px; font-weight: 600; color: #777; margin-bottom: 5px; }
        .form-select, .form-input { width: 100%; padding: 10px; border: 1px solid #DDD; border-radius: 4px; font-size: 14px; background: #FFF; }
        .form-select:focus, .form-input:focus { border-color: var(--simple-blue); outline: none; }
        
        /* CHECKBOX & SUBTEXT */
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .checkbox-input { width: 18px; height: 18px; cursor: pointer; }
        .checkbox-label { font-size: 14px; color: #2C2C2C; font-weight: 600; }
        .form-subtext { font-size: 12px; color: #999; margin-top: 5px; line-height: 1.4; padding-left: 2px; }

        /* TABLE STYLES FOR GOAL HISTORY */
        .history-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        .history-table th { text-align: left; color: #999; font-weight: 600; padding-bottom: 10px; border-bottom: 1px solid #EEE; }
        .history-table td { padding: 10px 0; border-bottom: 1px solid #FAFAFA; color: #333; }
        .history-table .bal-col { color: #777; text-align: right; }
        .history-table .amt-col { text-align: right; font-weight: 600; }

        #modal-body-content { max-height: 70vh; overflow-y: auto; scrollbar-width: thin; }

        /* --- POCKET DETAIL SCROLL AREA --- */
        .pocket-header { text-align: center; margin-bottom: 20px; }
        .pocket-balance { font-size: 42px; font-weight: 700; color: #2C2C2C; margin-bottom: 5px; letter-spacing: -1px; }
        .pocket-sub { font-size: 14px; color: #999; margin-bottom: 25px; font-weight: 500; }
        .pocket-tx-scroll {
            max-height: 350px;
            overflow-y: auto;
            border-top: 1px solid #EEE;
            margin: 0 -30px; /* Bleed to edge */
            padding: 0 30px;
            scrollbar-width: thin;
        }
        .pocket-tx-scroll::-webkit-scrollbar { width: 6px; }
        .pocket-tx-scroll::-webkit-scrollbar-thumb { background-color: #DDD; border-radius: 3px; }
        
        .pocket-tx-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #FAFAFA;
            font-size: 14px;
        }
        .pocket-tx-row:last-child { border-bottom: none; }
        .pocket-tx-date { color: #999; font-size: 12px; width: 80px; }
        .pocket-tx-title { font-weight: 600; color: #333; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 15px; }
        .pocket-tx-amt { font-weight: 600; text-align: right; }

        /* --- MOBILE ADAPTATIONS --- */
        @media (max-width: 768px) {
            :root {
                --nav-height: 60px;
                --bottom-nav-height: calc(60px + env(safe-area-inset-bottom)); /* Add safe area */
            }

            body {
                overflow-y: auto; 
                padding-bottom: var(--bottom-nav-height); 
                height: auto;
                min-height: 100vh;
                background-color: #F8F9FB; /* Light gray bg for contrast on mobile */
            }

            /* TRANSFORM NAV TO STICKY TOP HEADER & BOTTOM TABS */
            .top-nav {
                padding: 0 15px;
                position: sticky;
                top: 0;
                width: 100%;
                z-index: 900;
                justify-content: space-between; 
                /* IMPORTANT: Removed backdrop-filter from parent to allow fixed children */
                background: #FFFFFF; 
                border-bottom: 1px solid rgba(0,0,0,0.05);
            }

            /* HIDE NAV LINKS ON MOBILE BUT KEEP LOGO */
            .nav-left {
                width: auto;
                gap: 0;
                display: flex;
            }
            .nav-left a.nav-link { display: none; } /* Hide desktop links */
            .logo { display: flex; margin-right: 0; }

            /* CREATE A NEW CENTERED MOBILE HEADER WITHIN NAV */
            .mobile-center-header {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                white-space: nowrap; /* Prevents jumping */
            }
            .mobile-top-label {
                font-size: 10px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: #2C2C2C; /* Darker label */
                font-weight: 600;
                line-height: 1;
                margin-bottom: 3px;
            }
            .mobile-top-balance {
                font-size: 15px;
                font-weight: 700;
                color: var(--simple-blue); /* BLUE COLOR AS REQUESTED */
                line-height: 1;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            /* FIXED BOTTOM NAV */
            .mobile-bottom-nav {
                display: flex; /* Show only on mobile */
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                z-index: 1000;
                background: rgba(255, 255, 255, 0.98); 
                backdrop-filter: blur(10px);
                height: var(--bottom-nav-height);
                padding-bottom: env(safe-area-inset-bottom);
                border-top: 1px solid rgba(0,0,0,0.1);
                box-shadow: 0 -1px 10px rgba(0,0,0,0.02);
            }

            .mobile-nav-link {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 4px;
                color: #999;
                font-size: 10px;
                font-weight: 500;
                cursor: pointer;
            }
            
            .mobile-nav-link svg {
                width: 22px;
                height: 22px;
                fill: none;
                stroke: currentColor;
                stroke-width: 2;
                stroke-linecap: round;
                stroke-linejoin: round;
            }

            .mobile-nav-link.active {
                color: var(--simple-blue);
            }
            .mobile-nav-link.active svg {
                stroke: var(--simple-blue);
                stroke-width: 2.5;
            }

            /* Top Right Profile */
            .nav-right {
                position: absolute;
                right: 15px;
                gap: 10px;
            }
            .user-profile span { display: none; }
            .user-profile .avatar { display: flex; width: 30px; height: 30px; font-size: 12px; }

            /* MAIN LAYOUT */
            .main-grid {
                grid-template-columns: 1fr;
                padding: 0 15px;
                height: auto;
                display: flex;
                flex-direction: column;
                overflow: visible;
                gap: 20px;
                margin-bottom: 20px;
                margin-top: 5px; /* TIGHTER SPACING FOR MOBILE */
            }

            .main-column {
                overflow: visible;
                height: auto;
            }

            /* HEADER INFO MOBILE OVERRIDES */
            /* Hide the big info header on mobile since we moved it to top nav */
            .info-header {
                display: none; 
            }

            /* CONTROLS */
            .controls-bar {
                padding: 15px;
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
                background: #FFF;
                border-bottom: 1px solid #EEE;
            }
            #search-container { width: 100%; }
            .search-input { height: 40px; background: #F4F6F8; border:none; } 
            .btn { height: 40px; display: flex; align-items: center; justify-content: center; }
            .btn-outline { background: #FFF; border: 1px solid #DDD; }
            .btn-move { justify-content: center; width: 100%; margin-top: 0; background: #FFF; border: 1px solid #DDD; font-weight: 600; }

            /* FILTERS */
            .filters {
                padding: 10px 15px;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 10px;
                gap: 8px;
                background: #FFF;
                margin-bottom: 0; /* Attach to grid */
                margin-top: 0;
            }
            .pill { padding: 6px 14px; font-size: 12px; background: #F0F2F5; }
            
            /* UPDATED MOBILE POPUP STYLE: FIXED POS */
            .filter-popup {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 350px;
                z-index: 2000;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            }

            /* DATA CONTAINERS */
            .data-container {
                border-radius: 0; /* Full width feel */
                border: none;
                border-top: 1px solid var(--border-color);
                overflow: visible;
                max-height: none;
                background: #FFF;
                margin: 0 -15px; /* Bleed to edges */
            }
            
            /* TRANSACTIONS & LISTS */
            /* UPDATED: Removed top margin to remove blank space */
            .section-header-row { 
                margin: 0 0 10px 0; 
                border: none; 
                padding: 15px 5px 5px 5px; 
                flex-wrap: wrap; 
            }
            .tab-title { font-size: 16px; font-weight: 800; color: #111; margin-right: 15px; }
            /* Styling for the subtitle on mobile specifically to match screenshot */
            .exp-summary { display: none; }

            .exp-hero-card { display: flex; margin: 0 -15px; border-top: 1px solid #EEE; }

            .tx-group-date { background: #F8F9FB; color: #555; border-bottom: 1px solid #EEE; padding: 10px 20px; font-weight: 600; font-size: 11px; }
            .tx-row { padding: 18px 20px; }
            .tx-title { font-size: 15px; font-weight: 500; }
            .tx-desc { margin-top: 2px; }
            .tx-amount { font-size: 15px; font-weight: 600; }

            .add-bill-row {
                margin: 10px 15px; /* Tighter margins on mobile */
            }

            /* REMOVE SIDEBAR ON MOBILE */
            .sidebar-column { display: none !important; }

            /* MODALS */
            .modal-content {
                width: 90%;
                margin: 0 auto;
            }
            /* Reduce padding for mobile modals to fit more content */
            .modal-body {
                padding: 20px;
            }
        }
        
        /* NEW STYLES FOR MOBILE STS DROPDOWN */
        .mobile-sts-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            /* Fixed: Ensure static transform includes translateX(-50%) */
            transform: translateX(-50%);
            background: #FFF;
            border: 1px solid #EEE;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-radius: 8px;
            padding: 15px;
            width: 200px;
            margin-top: 10px;
            z-index: 2000;
            text-align: right;
            cursor: default;
        }
        .mobile-sts-dropdown.show { display: block; animation: popInCenter 0.2s ease-out; }
        .mobile-sts-dropdown::before { /* Little arrow pointing up */
            content: ''; position: absolute; top: -6px; left: 50%; margin-left: -6px;
            border-width: 0 6px 6px 6px; border-style: solid; border-color: transparent transparent #FFF transparent;
        }
        .mb-dropdown-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #333; }
        .mb-dropdown-row.minus { color: #D93025; }
        .mb-dropdown-row.total { font-weight: 700; color: var(--simple-blue); margin-bottom: 0; font-size: 14px; }
        .mb-dropdown-divider { height: 1px; background: #EEE; margin: 8px 0; }
        .mb-math-label { color: #999; font-weight: 500; font-size: 11px; text-transform: uppercase; margin-left: 10px; }
        .header-arrow { font-size: 10px; margin-left: 4px; transition: transform 0.2s; display: inline-block; }
        .mobile-center-header.active .header-arrow { transform: rotate(180deg); }
        
        /* Desktop specific hide */
        @media (min-width: 769px) {
            .mobile-bottom-nav { display: none; }
            .mobile-center-header { display: none; }
        }
    </style>
</head>
<body>

    <div id="tx-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span id="modal-title-text" style="font-weight:600; color:#999; font-size:12px; letter-spacing:1px; text-transform:uppercase;">Details</span>
                <span class="close-btn" onclick="closeModal(event)">×</span>
            </div>
            <div class="modal-body" id="modal-body-content"><div style="text-align:center; padding: 20px;">Loading...</div></div>
        </div>
    </div>

    <div id="move-modal" class="modal-overlay" onclick="closeMoveModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span style="font-weight:600; color:#999; font-size:12px; letter-spacing:1px; text-transform:uppercase;">Move Money</span>
                <span class="close-btn" onclick="closeMoveModal(event)">×</span>
            </div>
            <div class="modal-body">
                <div id="move-message"></div>
                <div class="form-group"><label class="form-label">From</label><select id="move-from" class="form-select"><option>Loading...</option></select></div>
                <div class="form-group"><label class="form-label">To</label><select id="move-to" class="form-select"><option>Loading...</option></select></div>
                <div class="form-group"><label class="form-label">Amount</label><input type="number" id="move-amount" class="form-input" placeholder="0.00" step="0.01"></div>
                <div class="form-group"><label class="form-label">Note (Optional)</label><input type="text" id="move-note" class="form-input" placeholder="What's this for?"></div>
                <button class="btn-goal-add" onclick="executeTransfer()">Transfer Funds</button>
            </div>
        </div>
    </div>

    <div id="bill-modal" class="modal-overlay" onclick="closeBillModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span style="font-weight:600; color:#999; font-size:12px; letter-spacing:1px; text-transform:uppercase;">Add Expense</span>
                <span class="close-btn" onclick="closeBillModal(event)">×</span>
            </div>
            <div class="modal-body">
                <div id="bill-message"></div>
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" id="bill-name" class="form-input" placeholder="e.g. Netflix">
                </div>
                
                <div class="form-row-2" style="position:relative; z-index:4;">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Amount</label>
                        <input type="number" id="bill-amount" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Frequency</label>
                        <select id="bill-freq" class="form-select">
                            <option value="MONTHLY">Once A Month</option>
                            <option value="WEEKLY">Every Week</option>
                            <option value="BIWEEKLY">Every two weeks</option>
                            <option value="QUARTERLY">Every three Months</option>
                            <option value="SEMI_ANNUALLY">Twice a year</option>
                            <option value="ANNUALLY">Once a year</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="position:relative; z-index:3;">
                    <label class="form-label">Day of Month</label>
                    <select id="bill-day" class="form-select">
                        </select>
                </div>

                <div class="form-group" style="position:relative; z-index:50;">
                    <label class="form-label">Identification (Search Transactions)</label>
                    <input type="text" id="bill-id-search" class="form-input" placeholder="Type to search..." autocomplete="off">
                    <div id="suggestion-box" class="suggestion-box"></div>
                </div>

                <div class="form-row-2" style="position:relative; z-index:1;">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Min Amount</label>
                        <input type="number" id="bill-min" class="form-input" placeholder="0.00">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Max Amount</label>
                        <input type="number" id="bill-max" class="form-input" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="bill-variable" class="checkbox-input">
                        <span class="checkbox-label">Adjust for Variable Bills</span>
                    </label>
                    <div class="form-subtext">If a bill is different than expected, update its reservation amount for the next period</div>
                </div>

                <button class="btn-goal-add" onclick="saveBill()">Create Bill</button>
            </div>
        </div>
    </div>

    <div id="pocket-modal" class="modal-overlay" onclick="closePocketModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span style="font-weight:600; color:#999; font-size:12px; letter-spacing:1px; text-transform:uppercase;">Create Pocket</span>
                <span class="close-btn" onclick="closePocketModal(event)">×</span>
            </div>
            <div class="modal-body">
                <div id="pocket-message"></div>
                <div class="form-group">
                    <label class="form-label">Pocket Name</label>
                    <input type="text" id="pocket-name" class="form-input" placeholder="e.g. Vacation Fund">
                </div>

                <div class="form-group">
                    <label class="form-label">Initial Funding</label>
                    <input type="number" id="pocket-initial" class="form-input" placeholder="0.00">
                    <div id="pocket-funding-hint" class="form-subtext">Safe-to-Spend: $0.00</div>
                </div>                
                
                <div class="form-group">
                    <label class="form-label">Goal Amount ($)</label>
                    <input type="number" id="pocket-amount" class="form-input" placeholder="0.00">
                </div>
                

                <div class="form-group">
                    <label class="form-label">Description (Optional)</label>
                    <input type="text" id="pocket-desc" class="form-input" placeholder="What is this for?">
                </div>

                <button class="btn-goal-add" onclick="savePocket()">Create Pocket</button>
            </div>
        </div>
    </div>

    <nav class="top-nav">
        <div class="nav-left">
            <div class="logo"><img src="https://d31s10tn3clc14.cloudfront.net/imgs/deposits/Review+Logos/simple-logo.png" alt="Simple"></div>
            <a onclick="switchTab('activity')" id="nav-activity" class="nav-link active">Activity</a>
            <a onclick="switchTab('expenses')" id="nav-expenses" class="nav-link">Expenses</a>
            <a onclick="switchTab('goals')" id="nav-goals" class="nav-link">Pockets</a>
            <a onclick="switchTab('family')" id="nav-family" class="nav-link">Family</a>
            <a onclick="switchTab('cards')" id="nav-cards" class="nav-link">Cards</a>
        </div>

        <div class="mobile-center-header" onclick="toggleMobileStats(event)">
            <div class="mobile-top-label" id="mobile-header-label">Safe-to-Spend®</div>
            <div class="mobile-top-balance" id="mobile-header-balance">$ --.-- <span class="header-arrow">▼</span></div>
            
            <div id="mobile-sts-dropdown" class="mobile-sts-dropdown">
                <div class="mb-dropdown-row"><span id="mb-math-total">$0.00</span> <span class="mb-math-label">Available</span></div>
                <div class="mb-dropdown-row minus"><span id="mb-math-bills">-$0.00</span> <span class="mb-math-label">Bills</span></div>
                <div class="mb-dropdown-row minus"><span id="mb-math-goals">-$0.00</span> <span class="mb-math-label">Pockets</span></div>
                <div class="mb-dropdown-divider"></div>
                <div class="mb-dropdown-row total"><span id="mb-math-sts">$0.00</span> <span class="mb-math-label">Safe-to-Spend</span></div>
            </div>
        </div>

    </nav>

    <div class="mobile-bottom-nav">
        <div onclick="switchTab('activity')" id="mb-nav-activity" class="mobile-nav-link active">
            <svg viewBox="0 0 24 24"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
            <span>Activity</span>
        </div>
        <div onclick="switchTab('expenses')" id="mb-nav-expenses" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            <span>Expenses</span>
        </div>
        <div onclick="switchTab('goals')" id="mb-nav-goals" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
            <span>Pockets</span>
        </div>
        <div onclick="switchTab('family')" id="mb-nav-family" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="7" r="4"/><path d="M5.5 21v-2a4 4 0 0 1 4-4h5a4 4 0 0 1 4 4v2"/></svg>
            <span>Family</span>
        </div>
        <div onclick="switchTab('cards')" id="mb-nav-cards" class="mobile-nav-link">
            <svg viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>
            <span>Cards</span>
        </div>
    </div>

    <div class="info-header">
        <div class="balance-container">
            <h1><span id="sts-balance">$ --.--</span><span class="sts-label">Safe-to-Spend®</span></h1>
            <div class="math-line"><span id="math-total">$0.00</span> <span class="math-gray">available balance</span> - <span id="math-sched">$0.00</span> <span class="math-gray">in Bills</span> - <span id="math-goals">$0.00</span> <span class="math-gray">in Pockets</span></div>
        </div>
        <div class="header-links">
            <button class="btn btn-move" id="btn-move-money" onclick="openMoveModal()">Move Money <span style="font-size:16px; line-height:0;">⇅</span></button>
            <div class="header-link-group"><span class="header-link-label">CDs</span><a href="#" class="header-link-action">Open a CD today!</a></div>
        </div>
    </div>

    <div class="controls-bar" id="controls-bar">
        <div class="search-wrapper" id="search-container"><input type="text" class="search-input" id="search-input-box" placeholder="Search activity..."><button class="btn btn-outline" onclick="triggerSearch()">Search</button></div>
    </div>

    <div class="filters" id="filter-bar">
        <span style="color: #999; font-size: 12px;">Current Filters:</span>
        <div id="active-filters" style="display:flex; gap:10px;"><div class="pill" onclick="removeFilter('date')">Last 6 months <span class="pill-remove">×</span></div></div>
        <span class="link-blue" onclick="toggleFilterMenu()">More Filters ⌵</span>
        <div id="filter-menu" class="filter-popup">
            <div class="popup-header">
                <span class="popup-title">Filter Transactions</span>
                <span class="close-popup" onclick="toggleFilterMenu()">×</span>
            </div>
            <div class="filter-group"><span class="filter-label">Date Range</span><div class="filter-row"><input type="date" id="filter-min-date" class="filter-input"><input type="date" id="filter-max-date" class="filter-input"></div></div>
            <div class="filter-group"><span class="filter-label">Amount Range ($)</span><div class="filter-row"><input type="number" id="filter-min-amt" class="filter-input" placeholder="Min"><input type="number" id="filter-max-amt" class="filter-input" placeholder="Max"></div></div>
            <button class="btn-apply" onclick="applyFilters()">Apply Filters</button>
        </div>
    </div>

    <div class="main-grid">
        <div class="main-column">

            <div id="view-activity" class="view-section active">
                <div class="section-header-row"><span class="tab-title">Transactions</span><div class="view-toggles"><span class="active">≡ List</span></div></div>
                <div id="list-container" class="data-container"><div id="tx-loading" style="text-align:center; padding:20px; color:#999;">Loading transactions...</div><div id="tx-content"></div></div>
            </div>

            <div id="view-expenses" class="view-section">
                <div class="section-header-row"><span class="tab-title">Monthly Expenses</span><div class="exp-summary" id="exp-summary-text"></div></div>
                <div id="exp-hero-container"></div>
                <div id="expenses-list" class="data-container">
                    <div style="text-align:center; padding:20px; color:#999;">Loading expenses...</div>
                </div>
            </div>

            <div id="view-goals" class="view-section">
                <div class="section-header-row"><span class="tab-title">Pockets</span></div>
                <div id="goals-list" class="data-container"><div style="text-align:center; padding:20px; color:#999;">Loading goals...</div></div>
            </div>

            <div id="view-family" class="view-section">
                <div class="section-header-row"><span class="tab-title">Family</span></div>
                <div class="data-container" style="padding: 20px;">
                    <div id="family-content"><div style="text-align:center; padding:20px; color:#999;">Loading family...</div></div>
                </div>
            </div>

            <div id="view-cards" class="view-section">
                <div class="section-header-row"><span class="tab-title">Cards</span></div>
                <div class="data-container">
                    <div id="cards-content"><div style="text-align:center; padding:20px; color:#999;">Loading cards...</div></div>
                </div>
            </div>

        </div>

        <div class="sidebar-column">
            <div class="sidebar-card">
                <div class="card-title"><span>Trends</span><span style="color:#999; font-weight:400; font-size:12px;">Monthly ▼</span></div>
                <div class="trend-row" style="font-weight: 700; color:#AAA; font-size:10px; text-transform:uppercase; letter-spacing:0.5px;"><span>Overview</span><span>This month</span></div>
                <div class="trend-row"><span>Checking</span><span id="checking-val" style="color:var(--text-dark); font-weight:600;">--</span></div>
                <div class="trend-row"><span>Earned</span><span id="trend-earned" style="color:var(--text-light);">$0.00</span></div>
                <div class="trend-row"><span>Spent</span><span id="trend-spent" style="color:var(--text-light);">$0.00</span></div>
            </div>
             <div class="sidebar-card">
                <div class="card-title"><span>Active Pockets</span></div>
                <div id="sidebar-pockets-list">
                    <div style="text-align:center; color:#999; padding:10px;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fmt = (num) => "$" + num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const cardColors = { 'DENIM': '#4a69bd', 'TEAL': '#0abde3', 'BEIGE': '#d1ccc0', 'BLACK': '#2f3640' };

        // --- PWA REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('SW Registered: ', registration.scope);
                })
                .catch(err => {
                    console.log('SW Registration Failed: ', err);
                });
            });
        }

        // --- TAB SWITCHING ---
        function switchTab(tab) {
            const tabs = ['activity', 'expenses', 'goals', 'family', 'cards'];
            
            // Clear Active Desktop
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            // Clear Active Mobile
            document.querySelectorAll('.mobile-nav-link').forEach(el => el.classList.remove('active'));
            // Clear View
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));

            // Set Desktop Active
            const desktopNav = document.getElementById(`nav-${tab}`);
            if(desktopNav) desktopNav.classList.add('active');
            
            // Set Mobile Active
            const mobileNav = document.getElementById(`mb-nav-${tab}`);
            if(mobileNav) mobileNav.classList.add('active');

            const searchContainer = document.getElementById('search-container');
            const filterBar = document.getElementById('filter-bar');
            const controlsBar = document.getElementById('controls-bar');

            document.getElementById(`view-${tab}`).classList.add('active');

            // Handle UI Visibility based on Tab
            if(tab === 'activity') {
                searchContainer.style.opacity = '1'; searchContainer.style.visibility = 'visible'; filterBar.style.display = 'flex';
                controlsBar.style.display = 'flex';
            } else if (tab === 'goals') {
                searchContainer.style.opacity = '0'; searchContainer.style.visibility = 'hidden'; filterBar.style.display = 'none';
                controlsBar.style.display = 'none'; // FIX: Hide Controls bar on mobile Pockets to avoid whitespace
            } else {
                // Expenses, Family, Cards - Hide controls bar completely
                searchContainer.style.opacity = '0'; searchContainer.style.visibility = 'hidden'; filterBar.style.display = 'none';
                controlsBar.style.display = 'none';
            }

            // === UPDATED LOGIC: Force refresh on Expenses and Goals ===
            // This ensures data is fresh when navigating
            if(tab === 'expenses') loadExpenses(true);
            if(tab === 'goals') loadGoals(true);
            
            if(tab === 'family') loadFamily();
            if(tab === 'cards') loadCards();
        }

        // --- CARDS LOGIC ---
        function loadCards() {
            fetch('/api/cards').then(res => res.json()).then(data => {
                const container = document.getElementById('cards-content');
                if(data.error) { container.innerHTML = `<div style="text-align:center; padding:20px; color:red;">${data.error}</div>`; return; }

                let html = '';
                if(data.cards.length === 0) {
                    html = '<div style="text-align:center; padding:40px; color:#999;">No cards found.</div>';
                } else {
                    data.cards.forEach(card => {
                        const bg = cardColors[card.color] || '#333';
                        const isActive = card.status === 'ACTIVATED';
                        const statusClass = isActive ? 'status-active' : 'status-inactive';
                        const typeClass = card.type === 'Physical' ? 'type-phys' : 'type-virt';
                        const statusText = isActive ? 'Active' : (card.status === 'DEACTIVATED' ? 'Inactive' : card.status);
                        const limitText = card.limit ? ` • Limit: ${card.limit}` : '';

                        html += `
                        <div class="card-row">
                            <div class="card-icon" style="background-color: ${bg};"></div>
                            <div class="card-info">
                                <div class="card-name">${card.name} <span style="font-weight:400; color:#999;">(..${card.lastFour || '????'})</span></div>
                                <div class="card-meta">Holder: ${card.holder}${limitText}</div>
                            </div>
                            <span class="card-type-badge ${typeClass}">${card.type}</span>
                            <span class="card-status ${statusClass}">${statusText}</span>
                        </div>`;
                    });
                }
                container.innerHTML = html;
            });
        }

        // --- FILTER & SEARCH ---
        let filterState = { q: '', minDate: '', maxDate: '', minAmt: '', maxAmt: '' };
        document.getElementById('search-input-box').addEventListener('input', (e) => { filterState.q = e.target.value; reloadTx(); });
        function triggerSearch() { filterState.q = document.getElementById('search-input-box').value; reloadTx(); }
        function toggleFilterMenu() { const menu = document.getElementById('filter-menu'); menu.style.display = menu.style.display === 'block' ? 'none' : 'block'; }
        function applyFilters() { filterState.minDate = document.getElementById('filter-min-date').value; filterState.maxDate = document.getElementById('filter-max-date').value; filterState.minAmt = document.getElementById('filter-min-amt').value; filterState.maxAmt = document.getElementById('filter-max-amt').value; updatePills(); reloadTx(); toggleFilterMenu(); }
        function updatePills() { const container = document.getElementById('active-filters'); container.innerHTML = ''; if (!filterState.minDate && !filterState.maxDate && !filterState.minAmt && !filterState.maxAmt) { container.innerHTML = `<div class="pill" onclick="removeFilter('date')">Last 6 months <span class="pill-remove">×</span></div>`; return; } if(filterState.minDate || filterState.maxDate) { container.innerHTML += `<div class="pill" onclick="removeFilter('date')">${filterState.minDate || '...'} to ${filterState.maxDate || '...'} <span class="pill-remove">×</span></div>`; } if(filterState.minAmt || filterState.maxAmt) { container.innerHTML += `<div class="pill" onclick="removeFilter('amt')">$${filterState.minAmt || '0'} - $${filterState.maxAmt || '∞'} <span class="pill-remove">×</span></div>`; } }
        function removeFilter(type) { if(type === 'date') { filterState.minDate = ''; filterState.maxDate = ''; document.getElementById('filter-min-date').value = ''; document.getElementById('filter-max-date').value = ''; } if(type === 'amt') { filterState.minAmt = ''; filterState.maxAmt = ''; document.getElementById('filter-min-amt').value = ''; document.getElementById('filter-max-amt').value = ''; } updatePills(); reloadTx(); }
        
        // --- DYNAMIC SEARCH FOR BILL IDENTIFICATION (REPLACED DATALIST) ---
        
        // 1. Debounce utility to prevent spamming the API while typing
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // 2. Search Function
        const performBillSearch = debounce(function(evt) {
            const query = evt.target.value;
            const suggestionBox = document.getElementById('suggestion-box');
            
            // Clear if empty or short
            if(query.length < 2) {
                suggestionBox.style.display = 'none';
                return;
            }

            // Call the existing transactions API with the search term ('q')
            fetch(`/api/transactions?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    suggestionBox.innerHTML = ''; // Clear previous results
                    
                    if(data.transactions && data.transactions.length > 0) {
                        // Filter for unique titles to avoid duplicates in the dropdown
                        const uniqueTitles = [...new Set(data.transactions.map(t => t.title))];
                        
                        uniqueTitles.forEach(title => {
                            const div = document.createElement('div');
                            div.className = 'suggestion-item';
                            div.innerText = title;
                            // Add click handler to populate input and close box
                            div.onclick = function() {
                                document.getElementById('bill-id-search').value = title;
                                suggestionBox.style.display = 'none';
                            };
                            suggestionBox.appendChild(div);
                        });
                        
                        // Show the box
                        suggestionBox.style.display = 'block';
                    } else {
                        suggestionBox.style.display = 'none';
                    }
                })
                .catch(err => {
                    console.error("Search failed", err);
                    suggestionBox.style.display = 'none';
                });
        }, 400); // Wait 400ms after typing stops

        // 3. Attach to the specific "Identification" input field
        const billSearchInput = document.getElementById('bill-id-search');
        if(billSearchInput) {
            billSearchInput.addEventListener('input', performBillSearch);
        }
        
        // 4. Close suggestions when clicking elsewhere
        document.addEventListener('click', function(e) {
            const suggestionBox = document.getElementById('suggestion-box');
            const searchInput = document.getElementById('bill-id-search');
            if (e.target !== suggestionBox && e.target !== searchInput) {
                suggestionBox.style.display = 'none';
            }
        });

        function reloadTx() {
            const loader = document.getElementById('tx-loading'); const content = document.getElementById('tx-content'); loader.style.display = 'block'; content.innerHTML = '';
            const cleanState = {}; for (const key in filterState) { if (filterState[key]) cleanState[key] = filterState[key]; }
            const params = new URLSearchParams(cleanState).toString();
            fetch(`/api/transactions?${params}`).then(res => res.json()).then(data => {
                loader.style.display = 'none';
                if(data.error || !data.transactions || data.transactions.length === 0) { content.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">No transactions found.</div>`; return; }
                const grouped = {};
                
                // Also populate Search suggestions for Bills from initial load if needed, but dynamic is better
                
                data.transactions.forEach(tx => { const dateStr = new Date(tx.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); if(!grouped[dateStr]) grouped[dateStr] = []; grouped[dateStr].push(tx); });
                let html = '';
                for (const [date, txs] of Object.entries(grouped)) {
                    html += `<div class="tx-group-date">${date}</div>`;
                    txs.forEach(tx => { const amtClass = tx.amount > 0 ? 'tx-pos' : 'tx-neg'; html += `<div class="tx-row" onclick="openTxDetail('${tx.id}')"><div class="tx-left"><span class="tx-title">${tx.title || 'Unknown'}</span>${tx.description ? `<span class="tx-desc">${tx.description}</span>` : ''}</div><div class="tx-amount ${amtClass}">${fmt(tx.amount)}</div></div>`; });
                }
                content.innerHTML = html;
            }).catch(err => { loader.style.display = 'none'; content.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Offline / Cached Mode</div>'; });
        }

        // --- SHARED DATA ---
        let currentGoalData = { name: '', current: 0, target: 0, pct: 0, id: null, rawVal: 0 };
        let currentBalances = { checking: 0, savings: 0 };
        let expensesDataStore = [];
        let goalsDataStore = [];
        let familyDataStore = [];
        let moveMoneyAccounts = [];

        function updateAllMath(billReserved) {
            const available = currentBalances.checking + currentBalances.savings + billReserved;
            document.getElementById('math-total').innerText = fmt(available);
            document.getElementById('math-sched').innerText = fmt(billReserved);
            document.getElementById('math-goals').innerText = fmt(currentBalances.savings);
            document.getElementById('sts-balance').innerText = fmt(currentBalances.checking);
            
            // Mobile Update - Always shows checking/safe-to-spend
            if (document.getElementById('mobile-header-balance')) {
                // Keep the arrow span when updating text
                const arrowHtml = '<span class="header-arrow">▼</span>';
                document.getElementById('mobile-header-balance').innerHTML = fmt(currentBalances.checking) + " " + arrowHtml;
            }
        }

        // Add a global variable to store the funding source
        let currentFundingSource = "Checking";

        // --- EXPENSES ---
        function loadExpenses(forceRefresh = false) {
            const url = forceRefresh ? '/api/expenses?refresh=true' : '/api/expenses';
            fetch(url).then(res => res.json()).then(data => {
                if(data.error) return;
                updateAllMath(data.summary.totalReserved || 0);
                expensesDataStore = data.expenses;
                
                // Store the source for later use in Delete Logic
                currentFundingSource = data.summary.fundingSource || "Checking";
                
                const nextDate = new Date(data.summary.nextFundingDate).toLocaleDateString(undefined, {month:'short', day:'numeric', year:'numeric'});
                const summaryText = `Next Funding: ${nextDate} • Estimated ${fmt(data.summary.estimatedFunding)}`;
                
                document.getElementById('exp-summary-text').innerText = summaryText;

                const heroHtml = `
                    <div class="exp-hero-card">
                        <div class="exp-hero-col">
                            <span class="hero-lbl">Setting aside:</span>
                            <span class="hero-val">${fmt(data.summary.estimatedFunding)} on Payday 💰</span>
                        </div>
                        <div class="exp-hero-divider"></div>
                        <div class="exp-hero-col right">
                            <span class="hero-lbl">Next Funding:</span>
                            <span class="hero-status">${nextDate}</span>
                        </div>
                    </div>
                `;
                document.getElementById('exp-hero-container').innerHTML = heroHtml;

                let html = `<div class="add-bill-row" onclick="openBillModal()">
                    <span style="font-size:20px; line-height:1;">+</span> Add Bill
                </div>`;

                data.expenses.forEach((e, index) => {
                    let pct = e.amount > 0 ? Math.min((e.reserved / e.amount) * 100, 100) : 0;
                    const readyDate = e.reservedBy ? new Date(e.reservedBy).toLocaleDateString(undefined, {month:'short', day:'numeric'}) : 'Monthly';
                    const estFunding = e.estimatedFunding > 0 ? `${fmt(e.estimatedFunding)} on Payday 💰` : 'Fully Funded';
                    let statusBadge = e.paused ? `<span class="exp-funding-status">Paused</span>` : (e.reserved >= e.amount ? `<span class="exp-funding-status ready">Ready</span>` : '');
                    html += `<div class="exp-item" onclick="openExpenseDetail(${index})"><div class="exp-header-line"><div class="exp-name">${e.name}</div>${statusBadge}</div><div class="exp-progress-container"><div class="exp-progress-bar" style="width: ${pct}%"></div></div><div class="exp-details"><span>${fmt(e.reserved)} of ${fmt(e.amount)} reserved • Ready by ${readyDate}</span><span style="color:#2C2C2C">${estFunding}</span></div></div>`;
                });
                document.getElementById('expenses-list').innerHTML = html;
            });
        }

        // --- GOALS ---
        function loadGoals(forceRefresh = false) {
            const url = forceRefresh ? '/api/goals?refresh=true' : '/api/goals';
            fetch(url).then(res => res.json()).then(data => {
                goalsDataStore = data.goals;

                // Add Pocket Button
                let html = `<div class="add-bill-row" onclick="openPocketModal()">
                    <span style="font-size:20px; line-height:1;">+</span> Add Pocket
                </div>`;

                data.goals.forEach((g, index) => {
                    let pct = g.target > 0 ? Math.min((g.balance / g.target) * 100, 100) : 0;
                    
                    // Logic to handle empty goal (Pocket without target)
                    const hasGoal = g.target > 0;
                    const progressHtml = hasGoal
                        ? `<div class="exp-progress-container"><div class="exp-progress-bar" style="width: ${pct}%"></div></div>`
                        : ''; 
                    const detailsText = hasGoal
                        ? `<span>${fmt(g.balance)} of ${fmt(g.target)} saved</span>`
                        : `<span>${fmt(g.balance)} saved</span>`;

                    html += `<div class="exp-item" onclick="openGoalDetailList(${index})"><div class="exp-header-line"><div class="exp-name">${g.name}</div><span class="exp-funding-status ready">Active</span></div>${progressHtml}<div class="exp-details">${detailsText}<span style="color:#2C2C2C"></span></div></div>`;
                });
                document.getElementById('goals-list').innerHTML = html;
            });
        }

        // --- SIDEBAR POCKETS ---
        function loadSidebarPockets(forceRefresh = false) {
            const url = forceRefresh ? '/api/goals?refresh=true' : '/api/goals';
            fetch(url).then(res => res.json()).then(data => {
                const container = document.getElementById('sidebar-pockets-list');
                if(data.error || !data.goals || data.goals.length === 0) {
                    container.innerHTML = '<div style="color:#999; font-size:13px; text-align:center;">No active pockets</div>';
                    return;
                }

                let html = '';
                data.goals.forEach((g, index) => {
                    let pct = g.target > 0 ? Math.min((g.balance / g.target) * 100, 100) : 0;
                    const hasGoal = g.target > 0;
                    
                    // Sidebar specific logic for no-goal pockets
                    const detailsText = hasGoal
                        ? `<span>${fmt(g.balance)}</span><span>of ${fmt(g.target)}</span>`
                        : `<span>${fmt(g.balance)}</span><span>Saved</span>`;
                    
                    const barHtml = hasGoal
                        ? `<div class="goal-bar-bg"><div class="goal-bar-fill" style="width:${pct}%"></div></div>`
                        : '';

                    html += `
                    <div class="goal-card-clickable" onclick="openSidebarGoalDetail(${index})" style="margin-bottom: 15px; cursor:pointer;">
                        <div style="margin-bottom: 5px; font-weight:600; font-size:14px;">${g.name}</div>
                        <div style="font-size:12px; color:#767676; display:flex; justify-content:space-between; margin-bottom:5px;">
                            ${detailsText}
                        </div>
                        ${barHtml}
                    </div>
                    `;
                });
                container.innerHTML = html;
                // Update shared store
                goalsDataStore = data.goals;
            });
        }

        // --- FAMILY ---
        function loadFamily() {
            fetch('/api/family').then(res => res.json()).then(data => {
                if(data.error) return;
                familyDataStore = [...data.children, ...data.parents];
                const container = document.getElementById('family-content');
                let html = '';
                if(data.children.length > 0) {
                    html += `<div class="family-section-title">Children</div><div class="family-grid">`;
                    data.children.forEach((child, index) => {
                        const stripColor = cardColors[child.color] || '#CCC';
                        html += `<div class="family-card" onclick="openFamilyDetail('child', ${index})"><div class="color-strip" style="background:${stripColor}"></div><img src="${child.image}" class="profile-img"><div class="family-name">${child.name}</div><div class="family-role">Child</div><div class="family-balance">${fmt(child.balance)}</div></div>`;
                    });
                    html += `</div>`;
                }
                if(data.parents.length > 0) {
                    html += `<div class="family-section-title">Parents</div><div class="family-grid">`;
                    data.parents.forEach((parent, index) => {
                        const stripColor = cardColors[parent.color] || '#CCC';
                        html += `<div class="family-card" style="cursor:default"><div class="color-strip" style="background:${stripColor}"></div><img src="${parent.image}" class="profile-img"><div class="family-name">${parent.name}</div><div class="family-role">Parent</div></div>`;
                    });
                    html += `</div>`;
                }
                container.innerHTML = html;
            });
        }

        function loadTrends() { fetch('/api/trends').then(res => res.json()).then(data => { if(data.error) return; document.getElementById('trend-earned').innerText = fmt(data.earned); document.getElementById('trend-spent').innerText = fmt(data.spent); }); }

        function openExpenseDetail(index) { 
            const e = expensesDataStore[index]; 
            const modal = document.getElementById('tx-modal'); 
            modal.style.display = 'flex'; 
            document.getElementById('modal-title-text').innerText = "Expense Details"; 
            const pct = e.amount > 0 ? ((e.reserved / e.amount) * 100).toFixed(0) : 0; 
            
            const safeName = e.name.replace(/'/g, "\\'");

            document.getElementById('modal-body-content').innerHTML = `
                <div style="text-align:center;">
                    <div style="font-size:18px; font-weight:600; margin-bottom:10px;">${e.name}</div>
                    <div class="detail-amount">${fmt(e.reserved)}</div>
                    <div style="color:#999; margin-bottom:20px;">Reserved of ${fmt(e.amount)}</div>
                    <div style="text-align:left;">
                        <div class="detail-row"><span>Status</span><span>${e.paused?'Paused':'Active'}</span></div>
                        <div class="detail-row"><span>Progress</span><span>${pct}%</span></div>
                        <div class="detail-row"><span>Next Funding</span><span>${fmt(e.estimatedFunding)}</span></div>
                    </div>
                    
                    <button class="btn-goal-delete" onclick="deleteBill('${e.id}', '${safeName}', ${e.reserved})">Delete Expense</button>
                </div>`; 
        }

        function deleteBill(id, name, reservedAmount) {
            let msg = `Are you sure you want to delete "${name}"?`;
            
            // Logic: Checking -> Safe-to-Spend, anything else -> displayName
            const destinationName = (currentFundingSource === "Checking") ? "Safe-to-Spend" : currentFundingSource;

            if (reservedAmount > 0) {
                msg += `\n\n${fmt(reservedAmount)} currently reserved will be returned to ${destinationName}.`;
            } else {
                msg += `\n\nThis will remove the bill and stop future funding.`;
            }

            if(!confirm(msg)) {
                return;
            }

            const btn = document.querySelector('.btn-goal-delete');
            if(btn) {
                btn.innerText = "Deleting...";
                btn.disabled = true;
                btn.style.opacity = "0.7";
            }

            fetch('/api/delete-bill', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: id })
            })
            .then(res => res.json())
            .then(data => {
                if(data.error) {
                    alert("Error: " + data.error);
                    if(btn) {
                        btn.innerText = "Delete Expense";
                        btn.disabled = false;
                        btn.style.opacity = "1";
                    }
                } else {
                    closeModal();
                    loadExpenses(true); 
                }
            })
            .catch(err => {
                alert("System error occurred.");
                if(btn) btn.disabled = false;
            });
        }
        
        // --- UPDATED GOAL DETAIL (Pockets) with SIDE-BY-SIDE BUTTONS ---
        function openGoalDetailList(index) { 
            const g = goalsDataStore[index];
            const modal = document.getElementById('tx-modal'); 
            modal.style.display = 'flex'; 
            document.getElementById('modal-title-text').innerText = "Pocket Activity"; 
            const body = document.getElementById('modal-body-content');
            
            // Set initial layout while loading
            const targetText = g.target > 0 ? `Saved of ${fmt(g.target)}` : 'Total Saved';
            
            body.innerHTML = `
                <div class="pocket-header">
                    <div class="pocket-balance">${fmt(g.balance)}</div>
                    <div class="pocket-sub">${targetText}</div>
                </div>
                <div class="pocket-tx-scroll" id="pocket-tx-list">
                    <div style="text-align:center; padding:20px; color:#999;">Loading activity...</div>
                </div>
                
                <div style="margin-top: 20px; display: flex; flex-direction: row; gap: 15px;">
                    <button class="btn-goal-add" style="flex:1; margin:0;" onclick="openMoveModal('${g.id}')">Add Funds</button>
                    <button class="btn-goal-delete" style="flex:1; margin:0;" onclick="deletePocket('${g.id}', '${g.name.replace(/'/g, "\\'")}')">Delete Pocket</button>
                </div>
            `;

            // Fetch transactions for this pocket
            fetch('/api/transactions?pageSize=100').then(res => res.json()).then(data => {
                const listContainer = document.getElementById('pocket-tx-list');
                if(data.error) {
                    listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:red;">Error loading</div>';
                    return;
                }
                
                const pocketTxs = data.transactions.filter(t => t.subaccountId === g.id);
                
                if(pocketTxs.length === 0) {
                    listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">No recent activity</div>';
                } else {
                    let html = '';
                    pocketTxs.forEach(tx => {
                        const date = new Date(tx.date).toLocaleDateString(undefined, {month:'short', day:'numeric'});
                        const amtClass = tx.amount > 0 ? 'tx-pos' : 'tx-neg';
                        const sign = tx.amount > 0 ? '+' : '';
                        
                        html += `
                        <div class="pocket-tx-row">
                            <div class="pocket-tx-date">${date}</div>
                            <div class="pocket-tx-title">${tx.title}</div>
                            <div class="pocket-tx-amt ${amtClass}">${sign}${fmt(tx.amount)}</div>
                        </div>
                        `;
                    });
                    listContainer.innerHTML = html;
                }
            });
        }

        // --- NEW DELETE FUNCTION ---
        function deletePocket(id, name) {
            // 1. Confirmation
            if(!confirm(`Are you sure you want to delete the "${name}" pocket?\n\nThis will permanently remove the pocket history.`)) {
                return;
            }

            const btn = document.querySelector('.btn-goal-delete');
            if(btn) {
                btn.innerText = "Deleting...";
                btn.disabled = true;
                btn.style.opacity = "0.7";
            }

            // 2. Call Backend
            fetch('/api/delete-pocket', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: id })
            })
            .then(res => res.json())
            .then(data => {
                if(data.error) {
                    alert("Error deleting pocket: " + data.error);
                    if(btn) {
                        btn.innerText = "Delete Pocket";
                        btn.disabled = false;
                    }
                } else {
                    // 3. Success
                    closeModal();
                    // Force refresh lists
                    loadGoals(true);
                    loadSidebarPockets(true);
                    initBalances(); // Refresh total balances
                }
            })
            .catch(err => {
                alert("System error occurred.");
            });
        }

        function openFamilyDetail(type, index) {
            if (type !== 'child') return;
            fetch('/api/family').then(res=>res.json()).then(data => {
                const person = data.children[index];
                const modal = document.getElementById('tx-modal'); modal.style.display = 'flex'; document.getElementById('modal-title-text').innerText = "Account Details";
                const age = Math.abs(new Date(Date.now() - new Date(person.dob).getTime()).getUTCFullYear() - 1970);
                document.getElementById('modal-body-content').innerHTML = `<div style="text-align:center;"><img src="${person.image}" style="width:80px; height:80px; border-radius:50%; margin-bottom:15px; border:2px solid #EEE;"><div style="font-size:20px; font-weight:700; color:#333; margin-bottom:5px;">${person.name}</div><div class="detail-amount">${fmt(person.balance)}</div><div style="color:#999; margin-bottom:25px;">Checking Balance</div><div style="text-align:left;"><div class="detail-row"><span>Role</span><span>Child (${age} yrs)</span></div><div class="detail-row"><span>Allowance</span><span>${person.allowance}</span></div><div class="detail-row"><span>Card Color</span><span style="color:${cardColors[person.color]}">● ${person.color}</span></div></div><button class="btn-goal-add">Manage Settings</button></div>`;
            });
        }
        function openSidebarGoalDetail(index) {
            // Reuse the main detail view for sidebar clicks too for consistency
            openGoalDetailList(index);
        }
        function openTxDetail(id) { const modal = document.getElementById('tx-modal'); modal.style.display = 'flex'; document.getElementById('modal-title-text').innerText = "Transaction Details"; document.getElementById('modal-body-content').innerHTML = 'Loading...'; fetch(`/api/transaction/${encodeURIComponent(id)}`).then(res=>res.json()).then(data => { document.getElementById('modal-body-content').innerHTML = `<div style="text-align:center; margin-bottom: 20px;"><div class="detail-amount">${fmt(data.amount)}</div><div style="font-size:16px;">${data.title}</div></div><div style="text-align:left;"><div class="detail-row"><span>Date</span><span>${new Date(data.date).toLocaleDateString()}</span></div><div class="detail-row"><span>Status</span><span>${data.status}</span></div></div>`; }); }
        
        function closeModal(e) { document.getElementById('tx-modal').style.display = 'none'; }
        
        // --- MOVE MONEY MODAL ---
        function openMoveModal(preFillToId = null) { 
            // Close other modals if open (like the pocket detail modal)
            document.getElementById('tx-modal').style.display = 'none';
            
            document.getElementById('move-modal').style.display = 'flex'; 
            document.getElementById('move-message').innerHTML = ''; 
            
            // ALWAYS REFRESH
            fetch('/api/subaccounts?refresh=true').then(res=>res.json()).then(data => { 
                if(data.error) return; 
                
                // Store account data globally for validation logic
                moveMoneyAccounts = data.subaccounts; 
                
                const opts = data.subaccounts.map(acc => `<option value="${acc.id}">${acc.name} (${fmt(acc.balance)})</option>`).join(''); 
                const fromSelect = document.getElementById('move-from');
                const toSelect = document.getElementById('move-to');
                
                fromSelect.innerHTML = opts; 
                toSelect.innerHTML = opts; 
                
                // Logic to pre-fill destination if provided
                if(preFillToId) {
                    toSelect.value = preFillToId;
                    // Try to set 'From' to Checking (assuming first one or specific logic) if not same
                    if(fromSelect.value === preFillToId && fromSelect.options.length > 1) {
                         fromSelect.selectedIndex = (fromSelect.selectedIndex + 1) % fromSelect.options.length;
                    }
                }
            }); 
        }

        function closeMoveModal() { document.getElementById('move-modal').style.display = 'none'; }
        
        function executeTransfer() { 
            const btn = document.querySelector('#move-modal .btn-goal-add'); 
            const msg = document.getElementById('move-message'); 
            
            const fromId = document.getElementById('move-from').value;
            const toId = document.getElementById('move-to').value;
            const amount = parseFloat(document.getElementById('move-amount').value);
            const note = document.getElementById('move-note').value;

            // --- VALIDATION START ---
            if (fromId === toId) {
                msg.innerHTML = '<div style="color:var(--alert-red); margin-bottom:10px;">Cannot transfer to the same account.</div>';
                return;
            }

            const sourceAccount = moveMoneyAccounts.find(acc => acc.id === fromId);
            if (sourceAccount && amount > sourceAccount.balance) {
                msg.innerHTML = '<div style="color:var(--alert-red); margin-bottom:10px;">Insufficient funds. Available: ' + fmt(sourceAccount.balance) + '</div>';
                return;
            }

            if (!amount || amount <= 0) {
                msg.innerHTML = '<div style="color:var(--alert-red); margin-bottom:10px;">Please enter a valid amount.</div>';
                return;
            }
            // --- VALIDATION END ---

            btn.disabled = true; 
            btn.innerText = "Processing..."; 
            
            const payload = { fromId, toId, amount, note }; 
            
            fetch('/api/move-money', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(payload) 
            }).then(res=>res.json()).then(data => { 
                btn.disabled = false; 
                btn.innerText = "Transfer Funds"; 
                if(data.error) { 
                    msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">${data.error}</div>`; 
                } else { 
                    msg.innerHTML = `<div style="color:green; margin-bottom:10px;">Success!</div>`; 
                    setTimeout(() => { 
                        closeMoveModal(); 
                        initBalances(); 
                        reloadTx(); 
                        loadSidebarPockets(true); 
                        
                        // Also refresh current view
                        if(document.getElementById('view-expenses').classList.contains('active')) loadExpenses(true);
                        if(document.getElementById('view-goals').classList.contains('active')) loadGoals(true);

                    }, 1500); 
                } 
            }); 
        }

        // --- NEW: ADD BILL LOGIC ---
        function openBillModal() {
            document.getElementById('bill-modal').style.display = 'flex';
            document.getElementById('bill-message').innerHTML = '';
            
            // Populate Days (1-31)
            const daySelect = document.getElementById('bill-day');
            daySelect.innerHTML = '';
            for(let i=1; i<=31; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = i + (i===1?'st':(i===2?'nd':(i===3?'rd':'th')));
                daySelect.appendChild(opt);
            }
        }

        function closeBillModal(e) { document.getElementById('bill-modal').style.display = 'none'; }

        function saveBill() {
            const btn = document.querySelector('#bill-modal .btn-goal-add');
            const msg = document.getElementById('bill-message');
            const modalBody = document.querySelector('#bill-modal .modal-body');
            
            // 1. Gather Inputs
            const name = document.getElementById('bill-name').value;
            const amount = document.getElementById('bill-amount').value;
            const frequency = document.getElementById('bill-freq').value;
            const dayOfMonth = document.getElementById('bill-day').value;
            
            // Optional / Advanced Inputs
            const matchString = document.getElementById('bill-id-search').value;
            const minAmount = document.getElementById('bill-min').value;
            const maxAmount = document.getElementById('bill-max').value;
            const isVariable = document.getElementById('bill-variable').checked;

            // 2. Validation
            if(!name || !amount) {
                msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">Please enter name and amount.</div>`;
                return;
            }
            
            if(!dayOfMonth) {
                msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">Please select a day of the month.</div>`;
                return;
            }

            btn.disabled = true;
            btn.innerText = "Creating Bill...";

            // 3. Construct Payload
            const payload = {
                name: name,
                amount: amount,
                frequency: frequency,
                dayOfMonth: dayOfMonth,
                matchString: matchString || null,
                minAmount: minAmount || null,
                maxAmount: maxAmount || null,
                variable: isVariable
            };

            // 4. API Call
            fetch('/api/create-bill', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                    btn.disabled = false;
                    btn.innerText = "Create Bill";

                    if(data.error) {
                        msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">${data.error}</div>`;
                    } else {
                        // SUCCESS LOGIC
                        const res = data.result;
                        const reservedCents = res.reservedAmount || 0;
                        const reservedAmt = reservedCents / 100.0;
                        
                        // Use the simplified name we injected from the Python backend
                        const accountName = res.fundingDisplayName || "Checking";

                        // Replace Modal Content with Success Message
                        modalBody.innerHTML = `
                            <div style="text-align:center; padding: 20px 0;">
                                <div style="font-size: 40px; margin-bottom: 10px;">🎉</div>
                                <div style="font-size: 18px; font-weight: 700; color: #2C2C2C; margin-bottom: 15px;">Bill Created Successfully</div>
                                
                                <div style="background: #F8F9FB; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: left; border: 1px solid #EEE;">
                                    <div style="font-size: 14px; line-height: 1.5; color: #555;">
                                        To ensure <strong>${name}</strong> is fully caught up and aligned with your funding schedule, 
                                        <span style="color: #2C2C2C; font-weight: 700;">${fmt(reservedAmt)}</span> 
                                        has been automatically reserved from your 
                                        <span style="color: #2C2C2C; font-weight: 700;">${accountName}</span> account.
                                    </div>
                                </div>

                                <button class="btn-goal-add" onclick="closeBillModalAndRefresh()">Done</button>
                            </div>
                        `;
                    }
                })
            .catch(err => {
                btn.disabled = false;
                btn.innerText = "Create Bill";
                msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">System Error</div>`;
                console.error(err);
            });
        }

        // Add this helper function to handle the close + refresh logic
        function closeBillModalAndRefresh() {
            closeBillModal();
            // Use timeout to allow modal animation to finish slightly
            setTimeout(() => {
                // Reset the modal body content for next time (optional, but good practice if not reloading page)
                // Since we are doing a simpler prototype, we can just reload lists.
                // Ideally you would reconstruct the form HTML here if you want to reuse it without refresh.
                // For now, we refresh data.
                loadExpenses(true);
                initBalances();
            }, 200);
        }
// --- NEW: ADD POCKET LOGIC ---
        function openPocketModal() {
            document.getElementById('pocket-modal').style.display = 'flex';
            document.getElementById('pocket-message').innerHTML = '';
            // Reset fields
            document.getElementById('pocket-name').value = '';
            document.getElementById('pocket-amount').value = '';
            document.getElementById('pocket-initial').value = '';
            document.getElementById('pocket-desc').value = '';
            
            // Initial hint update
            const avail = currentBalances.checking;
            document.getElementById('pocket-funding-hint').innerText = `Safe-to-Spend: ${fmt(avail)}`;
        }

        function closePocketModal(e) { document.getElementById('pocket-modal').style.display = 'none'; }
        
function savePocket() {
            const btn = document.querySelector('#pocket-modal .btn-goal-add');
            const msg = document.getElementById('pocket-message');
            
            const name = document.getElementById('pocket-name').value;
            const amount = document.getElementById('pocket-amount').value;
            const initial = document.getElementById('pocket-initial').value || 0;
            const note = document.getElementById('pocket-desc').value || "";
            
            // Validation
            if(!name || !amount) {
                msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">Please enter name and goal amount.</div>`;
                return;
            }
            
            const avail = currentBalances.checking;
            if (parseFloat(initial) > avail) {
                msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">Initial funding cannot exceed Safe-to-Spend balance (${fmt(avail)}).</div>`;
                return;
            }

            btn.disabled = true;
            btn.innerText = "Creating Pocket...";

            // Payload matches the arguments expected by the Python route
            const payload = { 
                name: name, 
                amount: amount, 
                initial: initial, 
                note: note 
            };

            fetch('/api/create-pocket', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                btn.disabled = false;
                btn.innerText = "Create Pocket";

                if(data.error) {
                    msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">${data.error}</div>`;
                } else {
                    msg.innerHTML = `<div style="color:green; margin-bottom:10px;">Success! Pocket Created.</div>`;
                    
                    setTimeout(() => {
                        closePocketModal();
                        // Force refresh goals and sidebar to show the new pocket
                        loadGoals(true); 
                        loadSidebarPockets(true);
                        // Refresh balance math in case money was moved
                        initBalances(); 
                    }, 1000);
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerText = "Create Pocket";
                msg.innerHTML = `<div style="color:var(--alert-red); margin-bottom:10px;">System Error</div>`;
            });
        }

        // --- MOBILE HEADER DROPDOWN LOGIC ---
        function toggleMobileStats(e) {
            e.stopPropagation(); // Prevent document click from closing immediately
            const header = document.querySelector('.mobile-center-header');
            const dropdown = document.getElementById('mobile-sts-dropdown');
            
            // Toggle class
            const isShowing = dropdown.classList.contains('show');
            
            if (isShowing) {
                dropdown.classList.remove('show');
                header.classList.remove('active');
            } else {
                // Update numbers from the desktop hidden header
                document.getElementById('mb-math-total').innerText = document.getElementById('math-total').innerText;
                document.getElementById('mb-math-bills').innerText = "-" + document.getElementById('math-sched').innerText;
                document.getElementById('mb-math-goals').innerText = "-" + document.getElementById('math-goals').innerText;
                document.getElementById('mb-math-sts').innerText = document.getElementById('sts-balance').innerText;
                
                dropdown.classList.add('show');
                header.classList.add('active');
            }
        }

        // Click off listener for dropdown
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('mobile-sts-dropdown');
            const header = document.querySelector('.mobile-center-header');
            if(dropdown && dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                header.classList.remove('active');
            }
        });

        function initBalances() { fetch('/api/savings').then(res=>res.json()).then(data => { if(!data.error) { const savBal = data.savings ? parseFloat(data.savings.balance.replace(/[$,]/g, '')) : 0; const checkBal = data.checking ? parseFloat(data.checking.balance.replace(/[$,]/g, '')) : 0; currentBalances.checking = checkBal; currentBalances.savings = savBal; if(data.checking) document.getElementById('checking-val').innerText = fmt(checkBal);  } loadExpenses(); }); }

        // Start with forced refresh on pockets to ensure sidebar is accurate
        initBalances(); reloadTx(); loadTrends(); loadSidebarPockets(true);
    </script>
</body>
</html>